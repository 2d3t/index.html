<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–®–∞—Ä–∏–∫–∏ ¬∑ —à–∏—Ä–æ–∫–∏–π –æ—Ä–µ–æ–ª + –ø—Ä–∏—Ç—è–∂–µ–Ω–∏–µ + —Ä–∞–∑–≥–æ–Ω</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
            touch-action: none;
        }

        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: block;
            background: white;
            transition: background 0.5s ease;
        }

        #canvas.gradient-mode {
            background: linear-gradient(135deg, 
                #667eea 0%,
                #764ba2 20%,
                #6b8cff 40%,
                #a18cd1 60%,
                #fbc2eb 80%,
                #a6c1ee 100%);
            background-size: 300% 300%;
            animation: gradientShift 8s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 0%; }
            50% { background-position: 100% 100%; }
            100% { background-position: 0% 0%; }
        }

        .instruction {
            position: fixed;
            top: 20px;
            left: 0;
            right: 0;
            text-align: center;
            color: #666;
            font-size: 14px;
            padding: 8px 16px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(5px);
            border-radius: 30px;
            width: fit-content;
            margin: 0 auto;
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: opacity 0.5s;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .counter {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(5px);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            color: #444;
            z-index: 20;
            pointer-events: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .clear-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 14px;
            color: #444;
            z-index: 20;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.2s, background 0.2s;
        }

        .clear-btn:active {
            transform: scale(0.95);
            background: rgba(255,255,255,1);
        }

        .swipe-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 12px 24px;
            border-radius: 40px;
            font-size: 16px;
            z-index: 30;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .swipe-hint.show {
            opacity: 1;
        }

        .tap-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 12px 24px;
            border-radius: 40px;
            font-size: 16px;
            z-index: 30;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .tap-hint.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    
    <div class="instruction">üëÜ –¢–∞–ø ‚Äî —Ä–∞–∑–æ–≥–Ω–∞—Ç—å —à–∞—Ä—ã ¬∑ üëá –î–æ–ª–≥–æ–µ –∫–∞—Å–∞–Ω–∏–µ ‚Äî –ø—Ä–∏—Ç—è–∂–µ–Ω–∏–µ</div>
    <div class="counter" id="counter">–®–∞—Ä–∏–∫–æ–≤: <span id="ballCount">0</span></div>
    <button class="clear-btn" id="clearBtn">‚ú® –û—á–∏—Å—Ç–∏—Ç—å</button>
    <div class="swipe-hint" id="swipeHint">üëÜ –°–≤–∞–π–ø ‚Äî —Å–º–µ–Ω–∏—Ç—å —Ñ–æ–Ω</div>
    <div class="tap-hint" id="tapHint">üí® –®–∞—Ä–∏–∫–∏ —Ä–∞–∑–ª–µ—Ç–∞—é—Ç—Å—è!</div>

    <script>
        (function() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const ballCountSpan = document.getElementById('ballCount');
            const swipeHint = document.getElementById('swipeHint');
            const tapHint = document.getElementById('tapHint');
            
            let width, height;
            let balls = [];
            let activeTouches = new Map();
            
            // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —à–∞—Ä–∏–∫–æ–≤
            const EMIT_INTERVAL = 80; // –º—Å –º–µ–∂–¥—É –ø–æ—è–≤–ª–µ–Ω–∏–µ–º
            const MAX_BALLS = 400;
            
            // –†–∞–¥–∏—É—Å –æ—Ä–µ–æ–ª–∞ –≤–æ–∫—Ä—É–≥ –ø–∞–ª—å—Ü–∞
            const HALO_RADIUS = 120; // –±–∞–∑–æ–≤—ã–π —Ä–∞–¥–∏—É—Å —Ä–∞–∑–±—Ä–æ—Å–∞ —à–∞—Ä–∏–∫–æ–≤
            const HALO_VARIATION = 60; // –≤–∞—Ä–∏–∞—Ü–∏—è —Ä–∞–¥–∏—É—Å–∞ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
            
            // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–∏—Ç—è–∂–µ–Ω–∏—è
            const ATTRACTION_RADIUS = 200; // —Ä–∞–¥–∏—É—Å, –≤ –∫–æ—Ç–æ—Ä–æ–º —à–∞—Ä–∏–∫–∏ –ø—Ä–∏—Ç—è–≥–∏–≤–∞—é—Ç—Å—è
            const ATTRACTION_FORCE = 0.15; // —Å–∏–ª–∞ –ø—Ä–∏—Ç—è–∂–µ–Ω–∏—è (–º–µ–Ω—å—à–µ = –ø–ª–∞–≤–Ω–µ–µ)
            const MAX_SPEED = 8; // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è –∫ –ø–∞–ª—å—Ü—É
            const RETURN_SPEED = 0.05; // —Å–∫–æ—Ä–æ—Å—Ç—å –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ –º–µ—Å—Ç–æ
            
            // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–∞–∑–≥–æ–Ω–∞ (—Ç–∞–ø) - –£–õ–£–ß–®–ï–ù–û
            const SCATTER_FORCE = 25; // —É–≤–µ–ª–∏—á–∏–ª–∏ —Å–∏–ª—É —Ä–∞–∑–≥–æ–Ω–∞
            const SCATTER_DURATION = 3000; // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è —Ä–∞–∑–ª–µ—Ç–∞ (–º—Å)
            const SCATTER_FADE_TIME = 500; // –≤—Ä–µ–º—è –∑–∞—Ç—É—Ö–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π
            const SCATTER_MIN_SPEED = 3; // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å, —á—Ç–æ–±—ã —à–∞—Ä–∏–∫–∏ —Ç–æ—á–Ω–æ —É–ª–µ—Ç–∞–ª–∏
            
            // –¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞ (–ø–∞—Å—Ç–µ–ª—å–Ω—ã–µ —Ç–æ–Ω–∞)
            const COLORS = [
                '#FFB6C1', // —Å–≤–µ—Ç–ª–æ-—Ä–æ–∑–æ–≤—ã–π
                '#98D8C8', // –º—è—Ç–Ω—ã–π
                '#FFDAB9', // –ø–µ—Ä—Å–∏–∫–æ–≤—ã–π
                '#E6E6FA', // –ª–∞–≤–∞–Ω–¥–æ–≤—ã–π
                '#B0E0E6', // –≥–æ–ª—É–±–æ–π
                '#FADADD', // –Ω–µ–∂–Ω–æ-—Ä–æ–∑–æ–≤—ã–π
                '#C1FFC1', // —Å–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
                '#FFE4B5', // –ø–µ—Å–æ—á–Ω—ã–π
                '#D8BFD8', // —Å–∏—Ä–µ–Ω–µ–≤—ã–π
                '#B0C4DE', // —Å—Ç–∞–ª—å–Ω–æ–π –≥–æ–ª—É–±–æ–π
                '#FFC3A0', // –∫–æ—Ä–∞–ª–ª–æ–≤—ã–π
                '#C1E1C1', // –º—è—Ç–Ω–æ-–∑–µ–ª–µ–Ω—ã–π
            ];
            
            // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∂–µ—Å—Ç–æ–≤
            let touchStartX = null;
            let touchStartY = null;
            let touchStartTime = null;
            let touchStartIdentifier = null;
            const SWIPE_THRESHOLD = 30;
            const TAP_TIME_THRESHOLD = 200; // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è —Ç–∞–ø–∞
            const SWIPE_TIME_THRESHOLD = 500;
            const LONG_PRESS_THRESHOLD = 300; // –≤—Ä–µ–º—è –¥–ª—è –¥–æ–ª–≥–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è (–ø—Ä–∏—Ç—è–∂–µ–Ω–∏–µ)
            
            // –°–æ—Å—Ç–æ—è–Ω–∏—è
            let isGradientMode = false;
            let isScattering = false; // —Ä–µ–∂–∏–º —Ä–∞–∑–≥–æ–Ω–∞
            let scatterStartTime = 0; // –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–∑–≥–æ–Ω–∞
            
            // –ê–Ω–∏–º–∞—Ü–∏—è
            let animationFrame;
            let lastTimestamp = 0;

            function resize() {
                width = window.innerWidth;
                height = window.innerHeight;
                canvas.width = width;
                canvas.height = height;
                drawBalls();
            }

            function getRandomColor() {
                return COLORS[Math.floor(Math.random() * COLORS.length)];
            }

            function createBall(targetX, targetY) {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–æ—Ä–æ–Ω—É –ø–æ—è–≤–ª–µ–Ω–∏—è
                const side = Math.floor(Math.random() * 4);
                let startX, startY;
                const margin = 100;
                
                switch(side) {
                    case 0: // —Å–≤–µ—Ä—Ö—É
                        startX = Math.random() * width;
                        startY = -margin - Math.random() * 150;
                        break;
                    case 1: // —Å–ø—Ä–∞–≤–∞
                        startX = width + margin + Math.random() * 150;
                        startY = Math.random() * height;
                        break;
                    case 2: // —Å–Ω–∏–∑—É
                        startX = Math.random() * width;
                        startY = height + margin + Math.random() * 150;
                        break;
                    case 3: // —Å–ª–µ–≤–∞
                        startX = -margin - Math.random() * 150;
                        startY = Math.random() * height;
                        break;
                }
                
                // –í–ê–ñ–ù–û: –®–∏—Ä–æ–∫–∏–π –æ—Ä–µ–æ–ª –≤–æ–∫—Ä—É–≥ –ø–∞–ª—å—Ü–∞
                // –í—ã—á–∏—Å–ª—è–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —É–≥–æ–ª
                const angle = Math.random() * Math.PI * 2;
                // –°–ª—É—á–∞–π–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –ø–∞–ª—å—Ü–∞ (–æ—Ç 30 –¥–æ HALO_RADIUS + HALO_VARIATION)
                const distance = 30 + Math.random() * (HALO_RADIUS + HALO_VARIATION);
                
                // –ö–æ–Ω–µ—á–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è - –Ω–∞ –æ–∫—Ä—É–∂–Ω–æ—Å—Ç–∏ –≤–æ–∫—Ä—É–≥ –ø–∞–ª—å—Ü–∞
                const finalX = targetX + Math.cos(angle) * distance;
                const finalY = targetY + Math.sin(angle) * distance;
                
                // –†–∞–∑–º–µ—Ä —à–∞—Ä–∏–∫–∞
                const size = 12 + Math.random() * 24; // –æ—Ç 12 –¥–æ 36 –ø–∏–∫—Å–µ–ª–µ–π
                
                // –°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–ª–µ—Ç–∞
                const duration = 800 + Math.random() * 1200; // 0.8-2 —Å–µ–∫—É–Ω–¥—ã
                
                const color = getRandomColor();
                
                return {
                    startX, startY,
                    targetX: finalX,
                    targetY: finalY,
                    progress: 0,
                    speed: 1 / duration * 16,
                    size,
                    color,
                    opacity: 0.8 + Math.random() * 0.2,
                    phase: Math.random() * Math.PI * 2,
                    arrived: false,
                    x: startX,
                    y: startY,
                    originalX: finalX, // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
                    originalY: finalY,
                    vx: 0, // —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ X –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                    vy: 0, // —Å–∫–æ—Ä–æ—Å—Ç—å –ø–æ Y –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏
                    lastUpdate: performance.now(),
                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –¥–≤–∏–∂–µ–Ω–∏—è
                    delay: Math.random() * 200,
                    // –î–ª—è —Ä–∞–∑–≥–æ–Ω–∞
                    scatterVelocityX: 0,
                    scatterVelocityY: 0,
                    isScattering: false
                };
            }

            function emitBallsFromTouch(touchId, touchX, touchY) {
                if (balls.length >= MAX_BALLS || isScattering) return; // –Ω–µ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–Ω–∞
                
                const now = performance.now();
                const touch = activeTouches.get(touchId);
                
                if (touch) {
                    if (now - touch.lastEmitTime < EMIT_INTERVAL) return;
                    touch.lastEmitTime = now;
                }
                
                // –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω —à–∞—Ä–∏–∫ –¥–ª—è –±–æ–ª–µ–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è
                if (balls.length < MAX_BALLS) {
                    balls.push(createBall(touchX, touchY));
                }
                
                updateCounter();
            }

            // –§—É–Ω–∫—Ü–∏—è —Ä–∞–∑–≥–æ–Ω–∞ —à–∞—Ä–∏–∫–æ–≤ (—Ç–∞–ø) - –£–õ–£–ß–®–ï–ù–û
            function scatterBalls() {
                if (balls.length === 0) return;
                
                isScattering = true;
                scatterStartTime = performance.now();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
                tapHint.textContent = 'üí® –®–∞—Ä–∏–∫–∏ —Ä–∞–∑–ª–µ—Ç–∞—é—Ç—Å—è!';
                tapHint.classList.add('show');
                setTimeout(() => {
                    tapHint.classList.remove('show');
                }, 1500);
                
                console.log('–†–∞–∑–≥–æ–Ω –Ω–∞—á–∞—Ç! –®–∞—Ä–∏–∫–æ–≤:', balls.length); // –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                
                // –ó–∞–¥–∞–µ–º –∫–∞–∂–¥–æ–º—É —à–∞—Ä–∏–∫—É —Å–∫–æ—Ä–æ—Å—Ç—å —Ä–∞–∑–ª–µ—Ç–∞
                for (let ball of balls) {
                    if (!ball.arrived) continue;
                    
                    // –°–ª—É—á–∞–π–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–ª–µ—Ç–∞
                    const angle = Math.random() * Math.PI * 2;
                    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–∏–ª—É –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –±–ª–∏–∑–∫–æ –∫ —Ü–µ–Ω—Ç—Ä—É
                    const distanceFromCenter = Math.sqrt(
                        Math.pow(ball.x - width/2, 2) + 
                        Math.pow(ball.y - height/2, 2)
                    );
                    const centerBonus = Math.max(1, 2 - distanceFromCenter / (width/4));
                    
                    // –°–ª—É—á–∞–π–Ω–∞—è —Å–∏–ª–∞ —Å –±–æ–Ω—É—Å–æ–º –æ—Ç —Ü–µ–Ω—Ç—Ä–∞
                    const force = SCATTER_FORCE * (0.8 + Math.random() * 0.8) * centerBonus;
                    
                    ball.scatterVelocityX = Math.cos(angle) * force;
                    ball.scatterVelocityY = Math.sin(angle) * force;
                    ball.isScattering = true;
                    
                    // –û–±–Ω—É–ª—è–µ–º –æ–±—ã—á–Ω—ã–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
                    ball.vx = 0;
                    ball.vy = 0;
                }
                
                // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –∫–∞—Å–∞–Ω–∏—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–Ω–∞
                activeTouches.clear();
            }

            function updateBalls(timestamp) {
                if (!lastTimestamp) {
                    lastTimestamp = timestamp;
                    return;
                }
                
                const deltaTime = Math.min(100, timestamp - lastTimestamp);
                const timeFactor = deltaTime / 16; // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ 60fps
                
                // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏–∏ –ø—Ä–∏–±—ã–≤–∞—é—â–∏—Ö —à–∞—Ä–∏–∫–æ–≤
                for (let i = balls.length - 1; i >= 0; i--) {
                    const ball = balls[i];
                    
                    if (!ball.arrived) {
                        // –£—á–∏—Ç—ã–≤–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É
                        if (ball.delay > 0) {
                            ball.delay -= deltaTime;
                            continue;
                        }
                        
                        ball.progress += ball.speed * (deltaTime / 16);
                        
                        if (ball.progress >= 1) {
                            ball.progress = 1;
                            ball.arrived = true;
                            ball.x = ball.targetX;
                            ball.y = ball.targetY;
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –ø–æ–∑–∏—Ü–∏—é
                            ball.originalX = ball.targetX;
                            ball.originalY = ball.targetY;
                        } else {
                            // –ü–ª–∞–≤–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –∑–∞–º–µ–¥–ª–µ–Ω–∏—è
                            const t = ball.progress;
                            const eased = 1 - Math.pow(1 - t, 2.5); // –º—è–≥–∫–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ
                            
                            ball.x = ball.startX + (ball.targetX - ball.startX) * eased;
                            ball.y = ball.startY + (ball.targetY - ball.startY) * eased;
                        }
                    }
                }
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–≥–æ–Ω–∞ (—Ç–∞–ø) - –£–õ–£–ß–®–ï–ù–û
                if (isScattering) {
                    const scatterTime = timestamp - scatterStartTime;
                    
                    // –î–≤–∏–≥–∞–µ–º –≤—Å–µ —à–∞—Ä–∏–∫–∏
                    for (let i = balls.length - 1; i >= 0; i--) {
                        const ball = balls[i];
                        
                        if (!ball.arrived) continue;
                        
                        // –î–≤–∏–≥–∞–µ–º —à–∞—Ä–∏–∫ —Å —Å–∏–ª–æ–π —Ä–∞–∑–≥–æ–Ω–∞
                        ball.x += ball.scatterVelocityX * timeFactor;
                        ball.y += ball.scatterVelocityY * timeFactor;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–æ–µ —Ç—Ä–µ–Ω–∏–µ, —á—Ç–æ–±—ã –∑–∞–º–µ–¥–ª—è–ª–∏—Å—å
                        ball.scatterVelocityX *= 0.995;
                        ball.scatterVelocityY *= 0.995;
                        
                        // –ï—Å–ª–∏ —Å–∫–æ—Ä–æ—Å—Ç—å —Å—Ç–∞–ª–∞ —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–π, –¥–æ–±–∞–≤–ª—è–µ–º –∏–º–ø—É–ª—å—Å
                        const currentSpeed = Math.sqrt(
                            ball.scatterVelocityX * ball.scatterVelocityX + 
                            ball.scatterVelocityY * ball.scatterVelocityY
                        );
                        
                        if (currentSpeed < SCATTER_MIN_SPEED && scatterTime < SCATTER_DURATION - 500) {
                            // –ü–æ–¥—Ç–∞–ª–∫–∏–≤–∞–µ–º —à–∞—Ä–∏–∫, —á—Ç–æ–±—ã –æ–Ω —Ç–æ—á–Ω–æ —É–ª–µ—Ç–µ–ª
                            const angle = Math.atan2(ball.y - height/2, ball.x - width/2);
                            ball.scatterVelocityX += Math.cos(angle) * 2;
                            ball.scatterVelocityY += Math.sin(angle) * 2;
                        }
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—Å–µ –ª–∏ —à–∞—Ä–∏–∫–∏ —É–ª–µ—Ç–µ–ª–∏ –∑–∞ —ç–∫—Ä–∞–Ω
                    let allBallsOffScreen = true;
                    let ballsOffScreen = 0;
                    
                    for (let ball of balls) {
                        if (!ball.arrived) {
                            ballsOffScreen++;
                            continue;
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —à–∞—Ä–∏–∫ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —ç–∫—Ä–∞–Ω–∞ (—Å –º–µ–Ω—å—à–∏–º –∑–∞–ø–∞—Å–æ–º)
                        const margin = 150;
                        const isOffScreen = ball.x < -margin || 
                                           ball.x > width + margin || 
                                           ball.y < -margin || 
                                           ball.y > height + margin;
                        
                        if (!isOffScreen) {
                            allBallsOffScreen = false;
                        } else {
                            ballsOffScreen++;
                        }
                    }
                    
                    // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    if (balls.length > 0 && balls.length % 50 === 0) {
                        console.log(`–®–∞—Ä–∏–∫–æ–≤ –∑–∞ —ç–∫—Ä–∞–Ω–æ–º: ${ballsOffScreen}/${balls.length}`);
                    }
                    
                    // –ï—Å–ª–∏ –≤—Å–µ —à–∞—Ä–∏–∫–∏ —É–ª–µ—Ç–µ–ª–∏ –∑–∞ —ç–∫—Ä–∞–Ω –∏–ª–∏ –ø—Ä–æ—à–ª–æ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
                    if (allBallsOffScreen || scatterTime > SCATTER_DURATION) {
                        console.log('–û—á–∏—Å—Ç–∫–∞! –í—Ä–µ–º—è:', scatterTime, '–®–∞—Ä–∏–∫–æ–≤ –∑–∞ —ç–∫—Ä–∞–Ω–æ–º:', ballsOffScreen);
                        
                        // –û—á–∏—â–∞–µ–º –≤—Å–µ —à–∞—Ä–∏–∫–∏
                        balls = [];
                        isScattering = false;
                        updateCounter();
                        
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É –æ–± –æ—á–∏—Å—Ç–∫–µ
                        tapHint.textContent = '‚ú® –≠–∫—Ä–∞–Ω –æ—á–∏—â–µ–Ω!';
                        tapHint.classList.add('show');
                        setTimeout(() => {
                            tapHint.classList.remove('show');
                        }, 1000);
                    } else {
                        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º —à–∞—Ä–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –Ω–µ –º–æ–≥—É—Ç —É–ª–µ—Ç–µ—Ç—å
                        if (scatterTime > SCATTER_DURATION * 0.7) {
                            // –ü–æ—Å–ª–µ 70% –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∏–Ω–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è—Ç—å –∑–∞—Å—Ç—Ä—è–≤—à–∏–µ
                            for (let i = balls.length - 1; i >= 0; i--) {
                                const ball = balls[i];
                                if (!ball.arrived) continue;
                                
                                const margin = 100;
                                const isOffScreen = ball.x < -margin || 
                                                   ball.x > width + margin || 
                                                   ball.y < -margin || 
                                                   ball.y > height + margin;
                                
                                // –ï—Å–ª–∏ —à–∞—Ä–∏–∫ –±–ª–∏–∑–∫–æ –∫ –∫—Ä–∞—é, —Ç–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º –µ–≥–æ –∑–∞ —ç–∫—Ä–∞–Ω
                                if (!isOffScreen) {
                                    const distToLeft = ball.x;
                                    const distToRight = width - ball.x;
                                    const distToTop = ball.y;
                                    const distToBottom = height - ball.y;
                                    const minDist = Math.min(distToLeft, distToRight, distToTop, distToBottom);
                                    
                                    if (minDist < 50) {
                                        // –¢–µ–ª–µ–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞ –±–ª–∏–∂–∞–π—à–∏–π –∫—Ä–∞–π
                                        if (minDist === distToLeft) ball.x = -200;
                                        else if (minDist === distToRight) ball.x = width + 200;
                                        else if (minDist === distToTop) ball.y = -200;
                                        else ball.y = height + 200;
                                    }
                                }
                            }
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                    updateCounter();
                    
                    // –†–∏—Å—É–µ–º –∏ –≤—ã—Ö–æ–¥–∏–º
                    drawBalls();
                    return;
                }
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–∞—Å–∞–Ω–∏—è –∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑–≥–æ–Ω–∞, –ø—Ä–∏–º–µ–Ω—è–µ–º –ø—Ä–∏—Ç—è–∂–µ–Ω–∏–µ
                if (activeTouches.size > 0 && !isScattering) {
                    // –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –∫–∞—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–∏—Ç—è–∂–µ–Ω–∏—è (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –¥–ª—è –º—É–ª—å—Ç–∏—Ç–∞—á)
                    const firstTouch = Array.from(activeTouches.values())[0];
                    const touchX = firstTouch.x;
                    const touchY = firstTouch.y;
                    
                    for (let ball of balls) {
                        if (!ball.arrived) continue; // –ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏–±—ã–≤—à–∏–µ —à–∞—Ä–∏–∫–∏
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç —à–∞—Ä–∏–∫–∞ –¥–æ –ø–∞–ª—å—Ü–∞
                        const dx = touchX - ball.x;
                        const dy = touchY - ball.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        // –ï—Å–ª–∏ —à–∞—Ä–∏–∫ –≤ —Ä–∞–¥–∏—É—Å–µ –ø—Ä–∏—Ç—è–∂–µ–Ω–∏—è
                        if (distance < ATTRACTION_RADIUS) {
                            // –°–∏–ª–∞ –ø—Ä–∏—Ç—è–∂–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è (–¥–∞–ª—å—à–µ = —Å–ª–∞–±–µ–µ)
                            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–≤–∞–¥—Ä–∞—Ç–∏—á–Ω—É—é –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –¥–ª—è –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
                            const force = Math.pow(1 - distance / ATTRACTION_RADIUS, 1.5) * ATTRACTION_FORCE * timeFactor;
                            
                            // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                            const dirX = dx / (distance || 1);
                            const dirY = dy / (distance || 1);
                            
                            // –î–æ–±–∞–≤–ª—è–µ–º —É—Å–∫–æ—Ä–µ–Ω–∏–µ –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏
                            ball.vx += dirX * force * ATTRACTION_RADIUS;
                            ball.vy += dirY * force * ATTRACTION_RADIUS;
                            
                            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
                            const speed = Math.sqrt(ball.vx * ball.vx + ball.vy * ball.vy);
                            if (speed > MAX_SPEED) {
                                ball.vx = (ball.vx / speed) * MAX_SPEED;
                                ball.vy = (ball.vy / speed) * MAX_SPEED;
                            }
                            
                            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
                            ball.x += ball.vx;
                            ball.y += ball.vy;
                            
                            // –ù–µ –¥–∞–µ–º —à–∞—Ä–∏–∫—É —É–ª–µ—Ç–µ—Ç—å —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –æ—Ç –ø–∞–ª—å—Ü–∞
                            const newDx = touchX - ball.x;
                            const newDy = touchY - ball.y;
                            const newDistance = Math.sqrt(newDx * newDx + newDy * newDy);
                            
                            // –ï—Å–ª–∏ —à–∞—Ä–∏–∫ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –ø–∞–ª—å—Ü—É, –æ—Ç—Ç–∞–ª–∫–∏–≤–∞–µ–º –µ–≥–æ –Ω–µ–º–Ω–æ–≥–æ
                            if (newDistance < ball.size * 0.6) {
                                const pushAngle = Math.atan2(newDy, newDx);
                                ball.x = touchX - Math.cos(pushAngle) * ball.size * 0.7;
                                ball.y = touchY - Math.sin(pushAngle) * ball.size * 0.7;
                                
                                // –ì–∞—Å–∏–º —Å–∫–æ—Ä–æ—Å—Ç—å
                                ball.vx *= 0.5;
                                ball.vy *= 0.5;
                            }
                        } else {
                            // –ó–∞–º–µ–¥–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å, –µ—Å–ª–∏ —à–∞—Ä–∏–∫ –≤–Ω–µ —Ä–∞–¥–∏—É—Å–∞
                            ball.vx *= 0.95;
                            ball.vy *= 0.95;
                            
                            // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–≤–∏–∂–µ–Ω–∏–µ
                            ball.x += ball.vx;
                            ball.y += ball.vy;
                        }
                        
                        // –ü–ª–∞–≤–Ω–æ–µ –ø—Ä–∏—Ç—è–∂–µ–Ω–∏–µ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ (—á—Ç–æ–±—ã —à–∞—Ä–∏–∫–∏ –Ω–µ —Ä–∞–∑–±–µ–≥–∞–ª–∏—Å—å)
                        const returnDx = ball.originalX - ball.x;
                        const returnDy = ball.originalY - ball.y;
                        ball.vx += returnDx * RETURN_SPEED * timeFactor;
                        ball.vy += returnDy * RETURN_SPEED * timeFactor;
                        
                        // –ù–µ–±–æ–ª—å—à–æ–µ —Ç—Ä–µ–Ω–∏–µ
                        ball.vx *= 0.99;
                        ball.vy *= 0.99;
                        
                        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º, —á—Ç–æ–±—ã —à–∞—Ä–∏–∫ –Ω–µ —É–ª–µ—Ç–∞–ª —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
                        const fromOriginalX = ball.x - ball.originalX;
                        const fromOriginalY = ball.y - ball.originalY;
                        const offsetDistance = Math.sqrt(fromOriginalX * fromOriginalX + fromOriginalY * fromOriginalY);
                        const maxOffset = ATTRACTION_RADIUS * 1.5;
                        
                        if (offsetDistance > maxOffset) {
                            ball.x = ball.originalX + (fromOriginalX / offsetDistance) * maxOffset;
                            ball.y = ball.originalY + (fromOriginalY / offsetDistance) * maxOffset;
                            ball.vx *= 0.5;
                            ball.vy *= 0.5;
                        }
                    }
                } else if (!isScattering) {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞—Å–∞–Ω–∏–π, –ø–ª–∞–≤–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ —à–∞—Ä–∏–∫–∏
                    for (let ball of balls) {
                        if (!ball.arrived) continue;
                        
                        // –ü—Ä–∏—Ç—è–∂–µ–Ω–∏–µ –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
                        const dx = ball.originalX - ball.x;
                        const dy = ball.originalY - ball.y;
                        
                        ball.vx += dx * RETURN_SPEED * timeFactor * 2;
                        ball.vy += dy * RETURN_SPEED * timeFactor * 2;
                        
                        // –¢—Ä–µ–Ω–∏–µ
                        ball.vx *= 0.95;
                        ball.vy *= 0.95;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é
                        ball.x += ball.vx;
                        ball.y += ball.vy;
                        
                        // –ï—Å–ª–∏ –ø–æ—á—Ç–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å, –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º —Ç–æ—á–Ω–æ –Ω–∞ –º–µ—Å—Ç–æ
                        if (Math.abs(dx) < 0.5 && Math.abs(dy) < 0.5 && Math.abs(ball.vx) < 0.1 && Math.abs(ball.vy) < 0.1) {
                            ball.x = ball.originalX;
                            ball.y = ball.originalY;
                            ball.vx = 0;
                            ball.vy = 0;
                        }
                    }
                }
                
                lastTimestamp = timestamp;
            }

            function drawBalls() {
                ctx.clearRect(0, 0, width, height);
                
                for (let ball of balls) {
                    if (ball.arrived) {
                        // –õ–µ–≥–∫–∞—è –ø—É–ª—å—Å–∞—Ü–∏—è –¥–ª—è –ø—Ä–∏–±—ã–≤—à–∏—Ö —à–∞—Ä–∏–∫–æ–≤
                        const pulse = 1 + 0.03 * Math.sin(performance.now() * 0.002 + ball.phase);
                        drawBall(ball.x, ball.y, ball.size * pulse, ball.color, ball.opacity);
                    } else {
                        drawBall(ball.x, ball.y, ball.size, ball.color, ball.opacity);
                    }
                }
            }

            function drawBall(x, y, size, color, opacity) {
                // –û—Å–Ω–æ–≤–Ω–æ–π –∫—Ä—É–≥ —Å –º—è–≥–∫–æ–π —Ç–µ–Ω—å—é
                ctx.shadowColor = 'rgba(0,0,0,0.1)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 2;
                ctx.shadowOffsetY = 2;
                
                // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –æ–±—ä–µ–º–∞
                const gradient = ctx.createRadialGradient(
                    x - size * 0.15, y - size * 0.15, size * 0.1,
                    x, y, size * 0.7
                );
                
                // –î–µ–ª–∞–µ–º —Ü–≤–µ—Ç –±–æ–ª–µ–µ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º –¥–ª—è –ª–µ–≥–∫–æ—Å—Ç–∏
                const baseColor = color;
                gradient.addColorStop(0, baseColor);
                gradient.addColorStop(0.7, shadeColor(baseColor, -20));
                gradient.addColorStop(1, shadeColor(baseColor, -40));
                
                ctx.beginPath();
                ctx.arc(x, y, size * 0.5, 0, Math.PI * 2);
                ctx.fillStyle = gradient;
                ctx.fill();
                
                // –ë–ª–∏–∫
                ctx.shadowBlur = 5;
                ctx.beginPath();
                ctx.arc(x - size * 0.1, y - size * 0.1, size * 0.12, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fill();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–Ω—å
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
                
                // –õ–µ–≥–∫–∏–π –∫–æ–Ω—Ç—É—Ä
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.lineWidth = 1;
                ctx.stroke();
            }

            function shadeColor(color, percent) {
                let R = parseInt(color.substring(1,3), 16);
                let G = parseInt(color.substring(3,5), 16);
                let B = parseInt(color.substring(5,7), 16);
                
                R = Math.max(0, Math.min(255, R + R * percent / 100));
                G = Math.max(0, Math.min(255, G + G * percent / 100));
                B = Math.max(0, Math.min(255, B + B * percent / 100));
                
                return `rgb(${R}, ${G}, ${B})`;
            }

            function updateCounter() {
                ballCountSpan.textContent = balls.length;
            }

            function clearBalls() {
                if (isScattering) return; // –Ω–µ –æ—á–∏—â–∞–µ–º –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–Ω–∞
                balls = [];
                updateCounter();
                drawBalls();
            }

            function toggleGradientMode() {
                isGradientMode = !isGradientMode;
                
                if (isGradientMode) {
                    canvas.classList.add('gradient-mode');
                } else {
                    canvas.classList.remove('gradient-mode');
                }
                
                swipeHint.classList.add('show');
                setTimeout(() => {
                    swipeHint.classList.remove('show');
                }, 1500);
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–∞—Å–∞–Ω–∏–π
            function handleTouchStart(e) {
                e.preventDefault();
                
                if (isScattering) return; // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–∞—Å–∞–Ω–∏—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–Ω–∞
                
                const touches = e.touches;
                
                for (let i = 0; i < touches.length; i++) {
                    const touch = touches[i];
                    const touchId = touch.identifier;
                    const touchX = touch.clientX;
                    const touchY = touch.clientY;
                    
                    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –ø–µ—Ä–≤—ã–π —Ç–∞—á –¥–ª—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –∂–µ—Å—Ç–æ–≤
                    if (activeTouches.size === 0) {
                        touchStartX = touchX;
                        touchStartY = touchY;
                        touchStartTime = performance.now();
                        touchStartIdentifier = touchId;
                    }
                    
                    activeTouches.set(touchId, {
                        x: touchX,
                        y: touchY,
                        lastEmitTime: 0,
                        startTime: performance.now()
                    });
                    
                    // –°–æ–∑–¥–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–∞—á–∞–ª—å–Ω—ã—Ö —à–∞—Ä–∏–∫–æ–≤ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
                    for (let j = 0; j < 3; j++) {
                        if (balls.length < MAX_BALLS && !isScattering) {
                            balls.push(createBall(touchX, touchY));
                        }
                    }
                }
                
                updateCounter();
            }

            function handleTouchMove(e) {
                e.preventDefault();
                
                if (isScattering) return; // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥–≤–∏–∂–µ–Ω–∏—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–Ω–∞
                
                const touches = e.touches;
                
                for (let i = 0; i < touches.length; i++) {
                    const touch = touches[i];
                    const touchId = touch.identifier;
                    const touchX = touch.clientX;
                    const touchY = touch.clientY;
                    
                    if (activeTouches.has(touchId)) {
                        const touchData = activeTouches.get(touchId);
                        touchData.x = touchX;
                        touchData.y = touchY;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–ª–∏—à–∫–æ–º –ª–∏ –¥–æ–ª–≥–æ–µ –∫–∞—Å–∞–Ω–∏–µ (–¥–ª—è —Ä–∞–∑–ª–∏—á–µ–Ω–∏—è —Ç–∞–ø–∞)
                        const touchDuration = performance.now() - touchData.startTime;
                        
                        // –ï—Å–ª–∏ –¥–≤–∏–∂–µ–Ω–∏–µ –Ω–∞—á–∞–ª–æ—Å—å –∏ —ç—Ç–æ –Ω–µ —Ç–∞–ø (–¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –∫–∞—Å–∞–Ω–∏–µ) - —Å–æ–∑–¥–∞–µ–º —à–∞—Ä–∏–∫–∏
                        if (touchDuration > TAP_TIME_THRESHOLD) {
                            emitBallsFromTouch(touchId, touchX, touchY);
                        }
                    }
                }
            }

            function handleTouchEnd(e) {
                e.preventDefault();
                
                if (isScattering) return; // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –≤–æ –≤—Ä–µ–º—è —Ä–∞–∑–≥–æ–Ω–∞
                
                const changedTouches = e.changedTouches;
                
                for (let i = 0; i < changedTouches.length; i++) {
                    const touch = changedTouches[i];
                    const touchId = touch.identifier;
                    
                    const touchData = activeTouches.get(touchId);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ —ç—Ç–æ –∫–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–ø
                    if (touchData && touchStartIdentifier === touchId) {
                        const touchEndX = touch.clientX;
                        const touchEndY = touch.clientY;
                        const touchDuration = performance.now() - touchData.startTime;
                        
                        // –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è
                        const dx = touchEndX - touchData.x;
                        const dy = touchEndY - touchData.y;
                        const moveDistance = Math.sqrt(dx * dx + dy * dy);
                        
                        // –ï—Å–ª–∏ –∫–∞—Å–∞–Ω–∏–µ –±—ã–ª–æ –∫–æ—Ä–æ—Ç–∫–∏–º (—Ç–∞–ø) –∏ –±–µ–∑ –¥–≤–∏–∂–µ–Ω–∏—è
                        if (touchDuration < TAP_TIME_THRESHOLD && moveDistance < 10) {
                            // –≠—Ç–æ —Ç–∞–ø - —Ä–∞–∑–≥–æ–Ω—è–µ–º —à–∞—Ä–∏–∫–∏
                            scatterBalls();
                        }
                    }
                    
                    activeTouches.delete(touchId);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–≤–∞–π–ø (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –±—ã–ª–æ —Ç–∞–ø–∞ –∏ –Ω–µ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑–≥–æ–Ω–∞)
                if (activeTouches.size === 0 && touchStartX !== null && changedTouches.length > 0 && !isScattering) {
                    const touch = changedTouches[0];
                    const touchEndX = touch.clientX;
                    const touchEndY = touch.clientY;
                    
                    if (touchStartTime !== null) {
                        const dx = touchEndX - touchStartX;
                        const dy = touchEndY - touchStartY;
                        const distance = Math.sqrt(dx*dx + dy*dy);
                        const time = performance.now() - touchStartTime;
                        
                        // –ï—Å–ª–∏ —ç—Ç–æ —Å–≤–∞–π–ø (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–ª—å—à–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ)
                        if (distance > SWIPE_THRESHOLD && time < SWIPE_TIME_THRESHOLD) {
                            clearBalls();
                            toggleGradientMode();
                        }
                    }
                    
                    touchStartX = null;
                    touchStartY = null;
                    touchStartTime = null;
                    touchStartIdentifier = null;
                }
            }

            function animate(timestamp) {
                updateBalls(timestamp);
                drawBalls();
                animationFrame = requestAnimationFrame(animate);
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏
            document.getElementById('clearBtn').addEventListener('click', (e) => {
                e.preventDefault();
                clearBalls();
            });

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            canvas.addEventListener('touchcancel', handleTouchEnd, { passive: false });
            canvas.addEventListener('contextmenu', (e) => e.preventDefault());

            window.addEventListener('resize', () => {
                resize();
            });

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
            resize();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ª—É—á–∞–π–Ω—ã—Ö —à–∞—Ä–∏–∫–æ–≤ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
            for (let i = 0; i < 15; i++) {
                const x = Math.random() * width;
                const y = Math.random() * height;
                balls.push({
                    startX: x,
                    startY: y,
                    targetX: x,
                    targetY: y,
                    progress: 1,
                    arrived: true,
                    x: x,
                    y: y,
                    originalX: x,
                    originalY: y,
                    vx: 0,
                    vy: 0,
                    size: 15 + Math.random() * 25,
                    color: getRandomColor(),
                    opacity: 0.8,
                    phase: Math.random() * Math.PI * 2
                });
            }
            updateCounter();
            
            animationFrame = requestAnimationFrame(animate);
        })();
    </script>
</body>
</html>