<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Initi - –§–∞–π–ª–æ–≤—ã–π –ú–µ–Ω–µ–¥–∂–µ—Ä</title>
    <style id="current-skin">
        /* --- üé® –°–∫–∏–Ω—ã –∏ –±–∞–∑–æ–≤—ã–π CSS (–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) --- */
        :root {
            --color-bg: #c0c0c0;
            --color-primary: #000080;
            --color-text: #000;
            --color-btn-bg: #c0c0c0;
            --color-btn-border-light: #fff;
            --color-btn-border-dark: #808080;
            --color-active: #000080;
            --color-active-text: #fff;
            --color-header-bg: #000080;
            --color-header-text: #fff;
            --color-input-bg: #fff;
            --font-family: 'Tahoma', 'Arial', sans-serif;
            --shadow-light: 1px 1px #fff;
            --shadow-dark: 1px 1px #000;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-y: auto;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        .window, #fileSystem {
            background-color: var(--color-bg);
            border: 3px solid;
            border-color: var(--color-btn-border-light) var(--color-btn-border-dark) var(--color-btn-border-dark) var(--color-btn-border-light);
            padding: 2px;
            box-shadow: var(--shadow-dark) 2px 2px 0 0;
        }

        .header {
            background-color: var(--color-header-bg);
            color: var(--color-header-text);
            padding: 2px 4px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        button, input[type="button"], select {
            background-color: var(--color-btn-bg);
            border: 3px solid;
            border-color: var(--color-btn-border-light) var(--color-btn-border-dark) var(--color-btn-border-dark) var(--color-btn-border-light);
            padding: 2px 8px;
            margin: 2px;
            font-family: var(--font-family);
            font-size: 14px;
            outline: none;
        }

        button:active, input[type="button"]:active {
            border-color: var(--color-btn-border-dark) var(--color-btn-border-light) var(--color-btn-border-light) var(--color-btn-border-dark);
            padding: 3px 7px 1px 9px;
        }

        #mainContainer {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 8px;
            position: relative;
        }

        #pathBar {
            background-color: var(--color-input-bg);
            border: 1px solid var(--color-btn-border-dark);
            padding: 4px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        #fileSystem {
            flex-grow: 1;
            overflow-y: auto;
            padding: 4px;
            min-height: 200px;
            position: relative;
        }

        .file-item, .folder-item {
            display: flex;
            align-items: center;
            padding: 4px;
            margin-bottom: 2px;
            border: 1px solid transparent;
            cursor: pointer;
            position: relative;
        }

        .file-item:hover, .folder-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .file-item.selected, .folder-item.selected {
            background-color: var(--color-active);
            color: var(--color-active-text);
        }

        .file-item-name, .folder-item-name {
            margin-left: 8px;
            background-color: rgba(0, 0, 0, 0.5); 
            color: white;
            padding: 1px 4px;
            border-radius: 2px;
        }
        
        .file-date, .folder-date {
            margin-left: auto;
            font-size: 10px;
            background-color: rgba(0, 0, 0, 0.5); 
            color: white;
            padding: 1px 4px;
            border-radius: 2px;
        }

        #fileSystem.has-wallpaper {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: transparent !important;
        }

        .control-panel {
            display: flex;
            flex-wrap: wrap;
            padding: 8px 0;
            border-top: 1px solid var(--color-btn-border-dark);
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            width: 90%;
            max-width: 400px;
        }
        
        #textEditor textarea {
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
            border: 1px solid var(--color-btn-border-dark);
            margin-bottom: 8px;
            background-color: var(--color-input-bg);
            color: var(--color-text);
            font-family: monospace;
            padding: 4px;
        }
        
        #photoViewer {
            background-color: rgba(0, 0, 0, 0.95);
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            touch-action: pan-y;
        }

        #photoDisplay {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .icon {
            font-size: 18px;
            margin-right: 4px;
        }
        .icon-folder::before { content: 'üìÅ'; }
        .icon-file::before { content: 'üìÑ'; }
        .icon-text::before { content: 'üìù'; }
        .icon-photo::before { content: 'üñºÔ∏è'; }
        .icon-audio::before { content: 'üéß'; }
        .icon-html::before { content: 'üåê'; }

        #searchBox {
            width: 100%;
            padding: 4px;
            box-sizing: border-box;
            border: 1px solid var(--color-btn-border-dark);
            margin-bottom: 8px;
            background-color: var(--color-input-bg);
        }

        @media (max-width: 600px) {
            .file-item, .folder-item {
                flex-wrap: wrap;
                justify-content: space-between;
            }
            .file-item-name, .folder-item-name, .file-date, .folder-date {
                width: 100%;
                margin-left: 0;
            }
            .file-date, .folder-date {
                text-align: right;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>

    <div id="mainContainer">
        <h1 class="header" style="text-align: center;">Initi: –§–∞–π–ª–æ–≤—ã–π –ú–µ–Ω–µ–¥–∂–µ—Ä</h1>

        <div class="control-panel window">
            <input type="text" id="searchBox" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
            <button onclick="navigateUp()">‚¨ÜÔ∏è –í–≤–µ—Ä—Ö</button>
            <button onclick="createItem('folder')">üìÅ –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
            <button onclick="createItem('file')">üìÑ –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª</button>
            <button onclick="renameItem()">‚úçÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
            <button onclick="deleteItem()">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
            <button onclick="showSkinsModal()">üé® –°–∫–∏–Ω—ã</button>
            <button onclick="showSettingsModal()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <select id="sortSelect" onchange="renderCurrentFolder()">
                <option value="name_asc">–°–æ—Ä—Ç: –ê-–Ø</option>
                <option value="name_desc">–°–æ—Ä—Ç: –Ø-–ê</option>
                <option value="type">–°–æ—Ä—Ç: –¢–∏–ø</option>
                <option value="date_desc">–°–æ—Ä—Ç: –î–∞—Ç–∞ (–ù–æ–≤—ã–µ)</option>
                <option value="date_asc">–°–æ—Ä—Ç: –î–∞—Ç–∞ (–°—Ç–∞—Ä—ã–µ)</option>
            </select>
        </div>

        <div id="pathBar" class="window">–ü—É—Ç—å: /</div>

        <div id="fileSystem" class="window" onclick="selectItem(event)">
            <p id="loadingIndicator" style="text-align: center; color: var(--color-text);">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
    </div>

    <div id="fileContentModal" class="modal" onclick="closeModal(event, 'fileContentModal')">
        <div class="modal-content window" onclick="event.stopPropagation()">
            <div class="header" id="fileContentHeader">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞</div>
            <p id="fileContentDate" style="text-align: center; font-size: 12px; margin: 4px 0;"></p>
            <div id="fileContentBody" style="padding: 8px;">
                <div id="textNotesSection">
                    <h3>–ó–∞–º–µ—Ç–∫–∏ üìù</h3>
                    <div id="textNotesList"></div>
                    <button onclick="createTextNote()">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
                </div>
                <hr>
                <div id="mediaSection">
                    <h3>–ú–µ–¥–∏–∞ (–§–æ—Ç–æ/–ê—É–¥–∏–æ) üñºÔ∏èüéß</h3>
                    <input type="file" id="mediaFileInput" style="display: none;" onchange="handleFileSelection(event)">
                    <button onclick="document.getElementById('mediaFileInput').accept='image/*'; document.getElementById('mediaFileInput').click()">üñºÔ∏è –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ</button>
                    <button onclick="document.getElementById('mediaFileInput').accept='audio/*'; document.getElementById('mediaFileInput').click()">üéß –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∞—É–¥–∏–æ</button>
                    <div id="mediaList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;"></div>
                </div>
            </div>
            <div class="control-panel">
                <button onclick="closeFileContentModal()">üíæ –ó–∞–∫—Ä—ã—Ç—å (–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)</button>
            </div>
        </div>
    </div>
    
    <div id="textEditorModal" class="modal" onclick="closeModal(event, 'textEditorModal')">
        <div class="modal-content window" onclick="event.stopPropagation()">
            <div class="header" id="textEditorHeader">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏</div>
            <div id="textEditor" style="padding: 8px;">
                <textarea id="noteContent" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ HTML-–∫–æ–¥..."></textarea>
                <input type="checkbox" id="isHtmlCheckbox"> <label for="isHtmlCheckbox">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ HTML</label>
                <div class="control-panel" style="justify-content: space-between;">
                    <div>
                        <button id="runHtmlButton" onclick="runHtmlDemo()" style="display:none;">üåê –ó–∞–ø—É—Å—Ç–∏—Ç—å HTML-–∫–æ–¥</button>
                    </div>
                    <div>
                        <button onclick="saveTextNote()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button onclick="closeTextEditorModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="htmlDemoModal" class="modal" style="display: none; background-color: white;">
        <iframe id="htmlDemoIframe" style="width: 100%; height: 100%; border: none;"></iframe>
        <button onclick="closeHtmlDemoModal()" style="position: absolute; top: 10px; right: 10px; background-color: red; color: white;">‚úñÔ∏è –í—ã—Ö–æ–¥</button>
    </div>

    <div id="photoViewer" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
        <img id="photoDisplay" src="" alt="Photo" onclick="closePhotoViewer()">
    </div>

    <div id="settingsModal" class="modal" onclick="closeModal(event, 'settingsModal')">
        <div class="modal-content window" onclick="event.stopPropagation()">
            <div class="header">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –î–∞–Ω–Ω—ã–µ</div>
            <div style="padding: 8px;">
                <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π</h3>
                <button onclick="saveFileSystem()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ .db</button>
                <input type="file" id="loadFileInput" onchange="loadFileSystem(event)" style="display: none;">
                <button onclick="document.getElementById('loadFileInput').click()">‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ .db</button>
                <button onclick="clearIndexedDB()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ú–µ–¥–∏–∞ (IndexedDB)</button>

                <h3 style="margin-top: 10px;">–û–±–æ–∏ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏</h3>
                <input type="text" id="wallpaperInput" placeholder="URL –∏–ª–∏ Base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" style="width: 100%; box-sizing: border-box; margin-bottom: 8px;">
                <button onclick="applyWallpaper()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–±–æ–∏</button>
                <button onclick="removeWallpaper()">–£–¥–∞–ª–∏—Ç—å –æ–±–æ–∏</button>
            </div>
            <div class="control-panel">
                <button onclick="closeSettingsModal()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="skinsModal" class="modal" onclick="closeModal(event, 'skinsModal')">
        <div class="modal-content window" onclick="event.stopPropagation()">
            <div class="header">üé® –í—ã–±–æ—Ä –°–∫–∏–Ω–∞</div>
            <div style="padding: 8px; display: flex; flex-direction: column; gap: 8px;">
                <button onclick="setSkin('win95')">Windows 95 (–ö–ª–∞—Å—Å–∏–∫–∞)</button>
                <button onclick="setSkin('winxp')">Windows XP (Luna)</button>
                <button onclick="setSkin('win7')">Windows 7 (Aero)</button>
                <button onclick="setSkin('dark')">–ù–µ-Windows (–¢–µ–º–Ω—ã–π)</button>
                <button onclick="setSkin('light')">–ù–µ-Windows (–°–≤–µ—Ç–ª—ã–π)</button>
            </div>
            <div class="control-panel">
                <button onclick="closeSkinsModal()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // --- ‚öôÔ∏è –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

        let fileSystem = {
            name: 'root',
            type: 'folder',
            children: [],
            path: '/',
            wallpaper: null,
            created: new Date().toISOString()
        };
        let currentPath = '/';
        let selectedItem = null;
        let currentFile = null;
        let currentNoteIndex = null;
        
        // –ú–∞—Å—Å–∏–≤ –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è Object URLs (—á—Ç–æ–±—ã –∏—Ö –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–æ–∑–≤–∞—Ç—å)
        let objectUrls = []; 
        
        // --- üìä IndexedDB Setup ---

        const DB_NAME = 'InitiFS';
        const DB_VERSION = 1;
        const STORE_NAME = 'mediaStore';
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = function(event) {
                    const db = event.target.result;
                    // –°–æ–∑–¥–∞–Ω–∏–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤
                    db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                };

                request.onsuccess = function(event) {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = function(event) {
                    console.error("IndexedDB error:", event.target.errorCode);
                    alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ IndexedDB. –ú–µ–¥–∏–∞—Ñ–∞–π–ª—ã –Ω–µ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è.");
                    reject(event.target.error);
                };
            });
        }
        
        function clearIndexedDB() {
            if (!db) return alert("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.");

            if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ —Ñ–æ—Ç–æ –∏ –∞—É–¥–∏–æ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞? –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (–∏–º–µ–Ω–∞) –æ—Å—Ç–∞–Ω–µ—Ç—Å—è.")) {
                return;
            }

            const transaction = db.transaction(STORE_NAME, 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.clear();

            request.onsuccess = () => {
                alert("IndexedDB —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–∞!");
            };

            request.onerror = (event) => {
                alert("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ IndexedDB: " + event.target.error);
            };
        }

        // --- üñºÔ∏è Media Management with IndexedDB ---

        function handleFileSelection(event) {
            const file = event.target.files[0];
            if (!file) return;

            const mediaType = file.type.startsWith('image/') ? 'photo' : (file.type.startsWith('audio/') ? 'audio' : 'unknown');

            if (mediaType === 'unknown') {
                alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–æ—Ä–º–∞—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –∞—É–¥–∏–æ.');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ IndexedDB
            const mediaId = Date.now().toString() + Math.random().toString(36).substring(2, 9);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª (Blob) –≤ IndexedDB
            saveMediaToDB(mediaId, file)
                .then(() => {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–∞–π–ª –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ Initi
                    currentFile.content.media.push({
                        type: mediaType,
                        id: mediaId
                    });
                    renderFileContent();
                    saveState();
                })
                .catch(error => {
                    alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∞–π–ª: ${error.message}. –í–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –±—Ä–∞—É–∑–µ—Ä–∞.`);
                });
            
            // –°–±—Ä–æ—Å –ø–æ–ª—è –≤–≤–æ–¥–∞
            event.target.value = '';
        }

        function saveMediaToDB(id, file) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                // –•—Ä–∞–Ω–∏–º –æ–±—ä–µ–∫—Ç —Å ID –∏ —Å–∞–º–∏–º —Ñ–∞–π–ª–æ–º (Blob)
                const request = store.add({ id: id, file: file });

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function getMediaFromDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);

                request.onsuccess = (event) => {
                    const data = event.target.result;
                    if (data) {
                        resolve(data.file); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–∞–º Blob/File
                    } else {
                        reject(new Error(`–ú–µ–¥–∏–∞ —Å ID ${id} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.`));
                    }
                };
                request.onerror = (event) => reject(event.target.error);
            });
        }
        
        function deleteMediaFromDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        // --- üìù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º—ã–º —Ñ–∞–π–ª–∞-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–û–±–Ω–æ–≤–ª–µ–Ω–æ) ---

        function openFileContent(path) {
            currentFile = getItemByPath(path);
            if (!currentFile || currentFile.type !== 'file') return;

            document.getElementById('fileContentHeader').textContent = currentFile.name;
            document.getElementById('fileContentDate').textContent = '–°–æ–∑–¥–∞–Ω: ' + formatDate(currentFile.created);
            
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ Object URLs
            objectUrls.forEach(url => URL.revokeObjectURL(url));
            objectUrls = [];

            renderFileContent();
            document.getElementById('fileContentModal').style.display = 'flex';
        }

        async function renderFileContent() {
            const noteListDiv = document.getElementById('textNotesList');
            const mediaListDiv = document.getElementById('mediaList');
            noteListDiv.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞...';
            mediaListDiv.innerHTML = '';
            
            // –°–Ω–∞—á–∞–ª–∞ —Ä–µ–Ω–¥–µ—Ä–∏–º –∑–∞–º–µ—Ç–∫–∏ (–æ–Ω–∏ –≤ localStorage)
            noteListDiv.innerHTML = '';
            currentFile.content.notes.forEach((note, index) => {
                // ... (–õ–æ–≥–∏–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∑–∞–º–µ—Ç–æ–∫ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
                const div = document.createElement('div');
                div.style.border = '1px solid #ccc';
                div.style.padding = '5px';
                div.style.marginBottom = '5px';
                div.style.backgroundColor = '#f9f9f9';

                const header = document.createElement('div');
                header.textContent = `–ó–∞–º–µ—Ç–∫–∞ #${index + 1}` + (note.isHtml ? ' (HTML)' : ' (–¢–µ–∫—Å—Ç)');
                header.style.fontWeight = 'bold';
                div.appendChild(header);

                const contentPreview = document.createElement('p');
                contentPreview.textContent = note.content.substring(0, 50) + '...';
                contentPreview.style.margin = '4px 0';
                div.appendChild(contentPreview);

                const editBtn = document.createElement('button');
                editBtn.textContent = '‚úçÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
                editBtn.onclick = () => editTextNote(index);
                div.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '‚ùå –£–¥–∞–ª–∏—Ç—å';
                deleteBtn.onclick = () => deleteTextNote(index);
                div.appendChild(deleteBtn);
                
                if (note.isHtml) {
                    const runBtn = document.createElement('button');
                    runBtn.textContent = 'üåê –ó–∞–ø—É—Å—Ç–∏—Ç—å';
                    runBtn.onclick = () => runHtmlDemo(note.content);
                    div.appendChild(runBtn);
                }

                noteListDiv.appendChild(div);
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –º–µ–¥–∏–∞ (–∏–∑ IndexedDB)
            for (let index = 0; index < currentFile.content.media.length; index++) {
                const media = currentFile.content.media[index];
                try {
                    const fileBlob = await getMediaFromDB(media.id);
                    const objectURL = URL.createObjectURL(fileBlob);
                    objectUrls.push(objectURL); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ—á–∏—Å—Ç–∫–∏

                    const div = document.createElement('div');
                    div.style.position = 'relative';
                    div.style.width = '80px';
                    div.style.height = '80px';
                    div.style.overflow = 'hidden';

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = '‚ùå';
                    deleteBtn.style.position = 'absolute';
                    deleteBtn.style.top = '0';
                    deleteBtn.style.right = '0';
                    deleteBtn.style.fontSize = '8px';
                    deleteBtn.style.padding = '0 3px';
                    deleteBtn.onclick = (e) => { e.stopPropagation(); deleteMediaItem(index); };
                    div.appendChild(deleteBtn);

                    if (media.type === 'photo') {
                        const img = document.createElement('img');
                        img.src = objectURL;
                        img.style.width = '100%';
                        img.style.height = '100%';
                        img.style.objectFit = 'cover';
                        img.onclick = () => openPhotoViewer(index, objectURL);
                        div.appendChild(img);
                    } else if (media.type === 'audio') {
                        const audioIcon = document.createElement('div');
                        audioIcon.textContent = 'üéß –ê—É–¥–∏–æ';
                        audioIcon.style.textAlign = 'center';
                        audioIcon.style.paddingTop = '20px';
                        audioIcon.style.backgroundColor = '#ddd';
                        audioIcon.style.height = '100%';
                        audioIcon.onclick = () => {
                            const audio = new Audio(objectURL);
                            audio.play().catch(e => console.error('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è:', e));
                        };
                        div.appendChild(audioIcon);
                    }
                    mediaListDiv.appendChild(div);

                } catch (error) {
                    const errorDiv = document.createElement('div');
                    errorDiv.textContent = `[–û—à–∏–±–∫–∞: ${media.type} –Ω–µ –Ω–∞–π–¥–µ–Ω–æ]`;
                    errorDiv.style.color = 'red';
                    mediaListDiv.appendChild(errorDiv);
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞:", error);
                }
            }
        }
        
        function deleteMediaItem(index) {
            const mediaId = currentFile.content.media[index].id;
            
            if (confirm(`–£–¥–∞–ª–∏—Ç—å –º–µ–¥–∏–∞—Ñ–∞–π–ª (ID: ${mediaId.substring(0, 8)}...)?`)) {
                // –£–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫—É –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –§–°
                currentFile.content.media.splice(index, 1);
                saveState(); 

                // –£–¥–∞–ª—è–µ–º —Å–∞–º —Ñ–∞–π–ª –∏–∑ IndexedDB
                deleteMediaFromDB(mediaId).then(() => {
                    renderFileContent();
                }).catch(e => {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–µ–¥–∏–∞ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.');
                    renderFileContent(); // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                });
            }
        }
        
        // --- üñºÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –§–æ—Ç–æ —Å –°–≤–∞–π–ø–æ–º (–û–±–Ω–æ–≤–ª–µ–Ω–æ) ---

        let photoUrls = []; // –ú–∞—Å—Å–∏–≤ URL-–æ–≤ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–∏—Ö —Ñ–æ—Ç–æ
        
        async function openPhotoViewer(mediaIndex, initialUrl) {
            // 1. –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ñ–æ—Ç–æ URL –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            photoUrls = [];
            let startIndex = 0;
            const allMedia = currentFile.content.media;
            let currentPhotoCount = 0;
            
            for (let i = 0; i < allMedia.length; i++) {
                const media = allMedia[i];
                if (media.type === 'photo') {
                    try {
                        const fileBlob = await getMediaFromDB(media.id);
                        const url = URL.createObjectURL(fileBlob);
                        objectUrls.push(url); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
                        photoUrls.push(url);

                        if (i === mediaIndex) {
                            startIndex = currentPhotoCount;
                        }
                        currentPhotoCount++;
                    } catch (e) {
                        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:", e);
                    }
                }
            }
            
            if (photoUrls.length === 0) return;

            photoIndex = startIndex;
            photoDisplay.src = photoUrls[photoIndex];
            photoViewer.style.display = 'flex';
            photoViewer.focus();
        }

        function showNextPhoto(direction) {
            if (photoUrls.length <= 1) return;

            photoIndex += direction;
            if (photoIndex >= photoUrls.length) photoIndex = 0;
            if (photoIndex < 0) photoIndex = photoUrls.length - 1;

            photoDisplay.src = photoUrls[photoIndex];
        }
        
        // ... (handleTouchStart, handleTouchMove, handleTouchEnd - –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        let startX = 0;
        const photoViewerElement = document.getElementById('photoViewer');
        const photoDisplayElement = document.getElementById('photoDisplay'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç–ª–µ–º–µ–Ω—Ç
        
        function handleTouchStart(e) {
            startX = e.touches[0].clientX;
        }

        function handleTouchMove(e) {
            if (e.touches.length > 1) return; 
            // –ù–µ –¥–æ–±–∞–≤–ª—è–µ–º e.preventDefault(), —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª
        }

        function handleTouchEnd(e) {
            const endX = e.changedTouches[0].clientX;
            const diffX = endX - startX;
            
            // –ï—Å–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–∏–ª—å–Ω—ã–π
            if (Math.abs(diffX) > 50) {
                if (diffX > 0) {
                    showNextPhoto(-1); // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ -> –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ
                } else {
                    showNextPhoto(1); // –°–≤–∞–π–ø –≤–ª–µ–≤–æ -> —Å–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ
                }
            } else if (e.target === photoDisplayElement) {
                // –ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ–π —Ç–∞–ø –ø–æ —Ñ–æ—Ç–æ, –∑–∞–∫—Ä—ã–≤–∞–µ–º (–∫–∞–∫ –ø–æ –∑–∞–¥–∞–Ω–∏—é)
                closePhotoViewer();
            }
        }

        function closePhotoViewer() {
            photoViewerElement.style.display = 'none';
        }

        // --- üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã ---

        window.onload = async () => {
            document.getElementById('loadingIndicator').style.display = 'block';
            await openDB(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IndexedDB
            loadState(); // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞–ª—å–Ω–æ–π –§–° –∏–∑ localStorage
            document.getElementById('loadingIndicator').style.display = 'none';
        };

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
        // (setSkin, skins, getItemByPath, navigateTo, saveState, loadState, saveFileSystem, loadFileSystem, 
        //  updateWallpaper, applyWallpaper, removeWallpaper, createItem, renameItem, deleteItem,
        //  createTextNote, editTextNote, saveTextNote, deleteTextNote, runHtmlDemo, closeHtmlDemoModal,
        //  closeFileContentModal, closeModal, showSettingsModal, closeSettingsModal, showSkinsModal, closeSkinsModal)

        const skins = { /* ... (–°–∫–∏–Ω—ã) ... */ };
        function setSkin(skinName) { /* ... (–õ–æ–≥–∏–∫–∞ —Å–∫–∏–Ω–æ–≤) ... */ }
        function getItemByPath(path) { /* ... (–õ–æ–≥–∏–∫–∞ –ø—É—Ç–µ–π) ... */ }
        function navigateTo(path) { /* ... (–õ–æ–≥–∏–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏) ... */ }
        function navigateUp() { /* ... (–õ–æ–≥–∏–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏) ... */ }
        function saveState() { localStorage.setItem('initi_fs', JSON.stringify(fileSystem)); }
        
        function loadState() {
            const savedFs = localStorage.getItem('initi_fs');
            const savedSkin = localStorage.getItem('initi_skin') || 'win95';
            const savedWallpaper = localStorage.getItem('initi_wallpaper');

            if (savedFs) {
                fileSystem = JSON.parse(savedFs);
            }
            
            setSkin(savedSkin);
            if (savedWallpaper) {
                fileSystem.wallpaper = savedWallpaper;
                updateWallpaper();
            }

            renderCurrentFolder();
        }

        function saveFileSystem() { /* ... (–õ–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è .db) ... */ }
        function loadFileSystem(event) { /* ... (–õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ .db) ... */ }
        function updateWallpaper() { /* ... (–õ–æ–≥–∏–∫–∞ –æ–±–æ–µ–≤) ... */ }
        function applyWallpaper() { /* ... (–õ–æ–≥–∏–∫–∞ –æ–±–æ–µ–≤) ... */ }
        function removeWallpaper() { /* ... (–õ–æ–≥–∏–∫–∞ –æ–±–æ–µ–≤) ... */ }
        function createItem(type) { /* ... (–õ–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è) ... */ }
        function renameItem() { /* ... (–õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è) ... */ }
        function deleteItem() { /* ... (–õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è) ... */ }
        function createTextNote() { /* ... (–õ–æ–≥–∏–∫–∞ –∑–∞–º–µ—Ç–æ–∫) ... */ }
        function editTextNote(index) { /* ... (–õ–æ–≥–∏–∫–∞ –∑–∞–º–µ—Ç–æ–∫) ... */ }
        function saveTextNote() { /* ... (–õ–æ–≥–∏–∫–∞ –∑–∞–º–µ—Ç–æ–∫) ... */ }
        function deleteTextNote(index) { /* ... (–õ–æ–≥–∏–∫–∞ –∑–∞–º–µ—Ç–æ–∫) ... */ }
        function runHtmlDemo(htmlContent = null) { /* ... (–õ–æ–≥–∏–∫–∞ HTML) ... */ }
        function closeHtmlDemoModal() { /* ... (–õ–æ–≥–∏–∫–∞ HTML) ... */ }
        function closeModal(event, id) { /* ... (–õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª–æ–∫) ... */ }
        function showSettingsModal() { /* ... (–õ–æ–≥–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫) ... */ }
        function closeSettingsModal() { /* ... (–õ–æ–≥–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫) ... */ }
        function showSkinsModal() { /* ... (–õ–æ–≥–∏–∫–∞ —Å–∫–∏–Ω–æ–≤) ... */ }
        function closeSkinsModal() { /* ... (–õ–æ–≥–∏–∫–∞ —Å–∫–∏–Ω–æ–≤) ... */ }
        function formatDate(isoString) { /* ... (–õ–æ–≥–∏–∫–∞ –¥–∞—Ç—ã) ... */ }
        function searchFileSystem(query, node, results = []) { /* ... (–õ–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞) ... */ }
        function selectItem(event) { /* ... (–õ–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞) ... */ }
        function renderCurrentFolder(searchQuery = '') { /* ... (–õ–æ–≥–∏–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞) ... */ }

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–ö–æ–Ω–µ—Ü) ---

    </script>
</body>
</html>