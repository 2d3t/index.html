<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройщик гитары</title>
    <style>
        body { font-family: Arial, sans-serif; }
        button { margin: 5px; }
        #indicator-container {
            display: flex;
            align-items: center;
        }
        #indicator {
            width: 20px; 
            height: 300px; 
            border: 2px solid #000; 
            position: relative; 
            margin-right: 20px; 
        }
        #targetLine {
            position: absolute; 
            bottom: 50%; 
            left: 0; 
            right: 0; 
            height: 2px; 
            background: green; 
        }
        #pointer {
            width: 20px; 
            height: 10px; 
            background: red; 
            position: absolute; 
            transition: bottom 0.1s;
        }
        #status { margin-top: 20px; }
    </style>
</head>
<body>
    <h1>Настройщик гитары</h1>
    <div>
        <button onclick="setTarget('E')">1. Струна E</button>
        <button onclick="setTarget('A')">2. Струна A</button>
        <button onclick="setTarget('D')">3. Струна D</button>
        <button onclick="setTarget('G')">4. Струна G</button>
        <button onclick="setTarget('B')">5. Струна B</button>
        <button onclick="setTarget('e')">6. Струна e</button>
    </div>

    <div id="indicator-container">
        <div id="indicator">
            <div id="targetLine"></div>
            <div id="pointer"></div>
        </div>
        <div id="message"></div>
    </div>
    <div id="frequencies"></div>

    <script>
        const context = new (window.AudioContext || window.webkitAudioContext)();
        let analyser = context.createAnalyser();
        let microphone;

        const frequencies = {
            'E': 82.41,
            'A': 110.00,
            'D': 146.83,
            'G': 196.00,
            'B': 246.94,
            'e': 329.63
        };

        let targetNote = null;

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                microphone = context.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 2048;
                analyzePitch();
            });

        function setTarget(note) {
            targetNote = note;
            document.getElementById('message').innerText = `Настройка: ${note}`;
        }

        function analyzePitch() {
            if (!targetNote) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            const frequency = getFrequency(dataArray);
            const targetFrequency = frequencies[targetNote];
            const deviation = frequency - targetFrequency;

            const pointer = document.getElementById('pointer');
            const message = document.getElementById('message');
            const frequenciesDisplay = document.getElementById('frequencies');

            frequenciesDisplay.innerText = `Текущая частота: ${frequency.toFixed(2)} Hz | Целевая частота: ${targetFrequency.toFixed(2)} Hz`;

            // Установка позиции указателя
            const position = (frequency / targetFrequency) * 100;
            pointer.style.bottom = `${Math.min(100, Math.max(0, 100 - position))}%`;

            // Сообщение о состоянии
            if (Math.abs(deviation) < 5) {
                message.innerText = `Состояние: Нормально`;
            } else if (deviation > 0) {
                message.innerText = `Ослабьте натяжение`;
            } else {
                message.innerText = `Подтяните струну`;
            }

            requestAnimationFrame(analyzePitch);
        }

        function getFrequency(dataArray) {
            const maxIndex = dataArray.indexOf(Math.max(...dataArray));
            const nyquist = context.sampleRate / 2;
            return maxIndex * nyquist / (dataArray.length);
        }
    </script>
</body>
</html>
