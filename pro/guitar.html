<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройщик гитары</title>
    <style>
        body { font-family: Arial, sans-serif; }
        button { margin: 5px; }
        #indicator { 
            width: 200px; 
            height: 200px; 
            position: relative; 
            margin: 20px auto; 
            border: 2px solid #000; 
            border-radius: 50%; 
        }
        #arrow {
            width: 4px; 
            height: 100px; 
            background: red; 
            position: absolute; 
            bottom: 100px; 
            left: 98px; 
            transform-origin: bottom;
            transition: transform 0.1s;
        }
    </style>
</head>
<body>
    <h1>Настройщик гитары</h1>
    <div>
        <button onclick="setTarget('E')">1. Струна E</button>
        <button onclick="setTarget('A')">2. Струна A</button>
        <button onclick="setTarget('D')">3. Струна D</button>
        <button onclick="setTarget('G')">4. Струна G</button>
        <button onclick="setTarget('B')">5. Струна B</button>
        <button onclick="setTarget('e')">6. Струна e</button>
    </div>

    <div id="indicator">
        <div id="arrow"></div>
    </div>
    <div id="status">Состояние: Нормально</div>
    <div id="frequencies"></div>

    <script>
        const context = new (window.AudioContext || window.webkitAudioContext)();
        let analyser = context.createAnalyser();
        let microphone;

        const frequencies = {
            'E': 82.41,
            'A': 110.00,
            'D': 146.83,
            'G': 196.00,
            'B': 246.94,
            'e': 329.63
        };

        let targetNote = null;

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                microphone = context.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 2048;
            });

        function setTarget(note) {
            targetNote = note;
            document.getElementById('status').innerText = `Настройка: ${note}`;
            analyzePitch();
        }

        function analyzePitch() {
            if (!targetNote) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            const frequency = getFrequency(dataArray);
            const targetFrequency = frequencies[targetNote];
            const deviation = frequency - targetFrequency;

            const indicator = document.getElementById('arrow');
            const status = document.getElementById('status');
            const frequenciesDisplay = document.getElementById('frequencies');

            frequenciesDisplay.innerText = `Текущая частота: ${frequency.toFixed(2)} Hz | Целевая частота: ${targetFrequency.toFixed(2)} Hz`;

            if (Math.abs(deviation) < 5) {
                status.innerText = `Состояние: Нормально`;
                indicator.style.transform = 'rotate(0deg)';
            } else {
                status.innerText = `Отклонение: ${deviation.toFixed(2)} Hz`;
                const rotation = (deviation > 0) ? 30 : -30; // угол отклонения
                indicator.style.transform = `rotate(${rotation}deg)`;
            }

            requestAnimationFrame(analyzePitch);
        }

        function getFrequency(dataArray) {
            const maxIndex = dataArray.indexOf(Math.max(...dataArray));
            const nyquist = context.sampleRate / 2;
            return maxIndex * nyquist / dataArray.length;
        }
    </script>
</body>
</html>
