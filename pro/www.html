<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Файловый менеджер</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        
        body {
            background-color: #c0c0c0;
            padding: 5px;
            font-size: 14px;
            position: relative;
            min-height: 100vh;
        }
        
        /* Рабочий стол с фоном */
        .desktop-container {
            position: relative;
            border: 2px outset #c0c0c0;
            background-color: #c0c0c0;
            margin-bottom: 5px;
            overflow: hidden;
        }
        
        .desktop-area {
            position: relative;
            height: 400px;
            overflow-y: auto;
            padding: 5px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        /* Темы оформления */
        body.win95 {
            background-color: #c0c0c0;
        }
        
        body.winxp {
            background-color: #ece9d8;
        }
        
        body.win7 {
            background-color: #d6e6ff;
        }
        
        .window {
            border: 2px outset #c0c0c0;
            background-color: #c0c0c0;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }
        
        .winxp .window {
            border: 1px solid #aca899;
            background-color: #ece9d8;
        }
        
        .win7 .window {
            border: 1px solid #a5b4c2;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        
        .title-bar {
            background: linear-gradient(90deg, #000080, #1084d0);
            color: white;
            padding: 2px 4px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .winxp .title-bar {
            background: linear-gradient(90deg, #0a246a, #a2b8d0);
        }
        
        .win7 .title-bar {
            background: linear-gradient(90deg, #0050ef, #3a7be0);
            border-radius: 4px 4px 0 0;
        }
        
        .title-bar-controls {
            display: flex;
        }
        
        .title-bar-button {
            width: 16px;
            height: 14px;
            background-color: #c0c0c0;
            border: 1px outset #c0c0c0;
            text-align: center;
            font-size: 10px;
            line-height: 12px;
            margin-left: 2px;
        }
        
        .winxp .title-bar-button {
            background-color: #d4d0c8;
            border: 1px solid #808080;
        }
        
        .win7 .title-bar-button {
            background-color: #e5f3ff;
            border: 1px solid #7a96df;
            border-radius: 3px;
        }
        
        .menu-bar {
            background-color: #c0c0c0;
            border: 1px inset #c0c0c0;
            padding: 2px;
            display: flex;
        }
        
        .winxp .menu-bar {
            background-color: #ece9d8;
            border: none;
        }
        
        .win7 .menu-bar {
            background-color: #f0f0f0;
            border: none;
        }
        
        .menu-item {
            padding: 2px 8px;
            margin-right: 2px;
        }
        
        .menu-item:hover {
            background-color: #000080;
            color: white;
        }
        
        .winxp .menu-item:hover {
            background-color: #316ac5;
        }
        
        .win7 .menu-item:hover {
            background-color: #c2d6f0;
            color: black;
        }
        
        .toolbar {
            background-color: #c0c0c0;
            border: 1px inset #c0c0c0;
            padding: 2px;
            display: flex;
            flex-wrap: wrap;
        }
        
        .winxp .toolbar {
            background-color: #ece9d8;
            border: none;
        }
        
        .win7 .toolbar {
            background-color: #f0f0f0;
            border: none;
        }
        
        .button {
            background-color: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 3px 8px;
            margin-right: 4px;
            font-size: 12px;
            margin-bottom: 2px;
        }
        
        .button:active {
            border: 2px inset #c0c0c0;
        }
        
        .winxp .button {
            background-color: #ece9d8;
            border: 1px solid #aca899;
        }
        
        .win7 .button {
            background-color: #e1e1e1;
            border: 1px solid #adadad;
            border-radius: 3px;
        }
        
        .search-bar {
            display: flex;
            align-items: center;
            padding: 2px;
            background-color: #c0c0c0;
            border: 1px inset #c0c0c0;
            flex-wrap: wrap;
        }
        
        .winxp .search-bar {
            background-color: #ece9d8;
            border: none;
        }
        
        .win7 .search-bar {
            background-color: #f0f0f0;
            border: none;
        }
        
        .search-input {
            flex-grow: 1;
            border: 1px inset #c0c0c0;
            padding: 2px;
            background-color: white;
            margin-right: 5px;
            min-width: 150px;
        }
        
        .search-options {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            margin-left: 10px;
            font-size: 12px;
        }
        
        .sort-options {
            display: flex;
            align-items: center;
            padding: 2px;
            background-color: #c0c0c0;
            border: 1px inset #c0c0c0;
            flex-wrap: wrap;
        }
        
        .winxp .sort-options {
            background-color: #ece9d8;
            border: none;
        }
        
        .win7 .sort-options {
            background-color: #f0f0f0;
            border: none;
        }
        
        .sort-select {
            margin-left: 5px;
            border: 1px inset #c0c0c0;
            background-color: white;
            padding: 2px;
        }
        
        .address-bar {
            display: flex;
            align-items: center;
            padding: 2px;
            background-color: #c0c0c0;
        }
        
        .winxp .address-bar {
            background-color: #ece9d8;
        }
        
        .win7 .address-bar {
            background-color: #f0f0f0;
        }
        
        .address-input {
            flex-grow: 1;
            border: 1px inset #c0c0c0;
            padding: 2px;
            background-color: white;
        }
        
        .file-list {
            display: flex;
            flex-wrap: wrap;
        }
        
        .file-item, .folder-item {
            width: 80px;
            margin: 5px;
            text-align: center;
            cursor: pointer;
            padding: 5px;
            position: relative;
        }
        
        .file-item:hover, .folder-item:hover {
            background-color: rgba(0, 0, 128, 0.7);
            color: white;
        }
        
        .winxp .file-item:hover, .winxp .folder-item:hover {
            background-color: rgba(49, 106, 197, 0.7);
        }
        
        .win7 .file-item:hover, .win7 .folder-item:hover {
            background-color: rgba(194, 214, 240, 0.7);
            color: black;
        }
        
        .file-icon, .folder-icon {
            width: 32px;
            height: 32px;
            margin: 0 auto 5px;
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        .folder-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ffcc00"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>');
        }
        
        .file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ffffff"><path d="M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6H6zm7 7V3.5L18.5 9H13z"/></svg>');
        }
        
        .text-file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23008000"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>');
        }
        
        .image-file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23008080"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>');
        }
        
        .audio-file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23800080"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>');
        }
        
        .file-name {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 2px;
            word-break: break-word;
        }
        
        .file-date {
            font-size: 10px;
            color: #ddd;
            margin-top: 2px;
        }
        
        .selected {
            background-color: rgba(0, 0, 128, 0.5) !important;
            border: 1px dashed yellow;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 0;
            width: 90%;
            max-width: 500px;
        }
        
        .winxp .modal-content {
            background-color: #ece9d8;
            border: 1px solid #aca899;
        }
        
        .win7 .modal-content {
            background-color: #f0f0f0;
            border: 1px solid #a5b4c2;
            border-radius: 5px;
        }
        
        .modal-body {
            padding: 10px;
            background-color: white;
        }
        
        .input-field {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
            border: 1px inset #c0c0c0;
        }
        
        .text-editor {
            width: 100%;
            height: 300px;
            border: 1px inset #c0c0c0;
            padding: 5px;
            font-family: monospace;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            display: block;
            margin: 0 auto;
        }
        
        .audio-player {
            width: 100%;
            margin: 10px 0;
        }
        
        .status-bar {
            background-color: #c0c0c0;
            border: 1px inset #c0c0c0;
            padding: 2px;
            display: flex;
            justify-content: space-between;
        }
        
        .winxp .status-bar {
            background-color: #ece9d8;
            border: none;
        }
        
        .win7 .status-bar {
            background-color: #e1e5ee;
            border: none;
        }
        
        .hidden {
            display: none;
        }
        
        .context-menu {
            position: absolute;
            background-color: #c0c0c0;
            border: 2px outset #c0c0c0;
            z-index: 100;
            min-width: 150px;
        }
        
        .winxp .context-menu {
            background-color: #ece9d8;
            border: 1px solid #aca899;
        }
        
        .win7 .context-menu {
            background-color: #f0f0f0;
            border: 1px solid #a5b4c2;
            border-radius: 3px;
        }
        
        .context-menu-item {
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .context-menu-item:hover {
            background-color: #000080;
            color: white;
        }
        
        .winxp .context-menu-item:hover {
            background-color: #316ac5;
        }
        
        .win7 .context-menu-item:hover {
            background-color: #c2d6f0;
            color: black;
        }
        
        .text-documents-list {
            margin-top: 10px;
            border-top: 1px solid #c0c0c0;
            padding-top: 10px;
        }
        
        .text-document-item {
            padding: 5px;
            border: 1px solid #c0c0c0;
            margin-bottom: 5px;
            cursor: pointer;
            position: relative;
        }
        
        .text-document-item:hover {
            background-color: #e0e0e0;
        }
        
        .text-document-preview {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .media-item {
            position: relative;
            margin-bottom: 10px;
            border: 1px solid #c0c0c0;
            padding: 5px;
        }
        
        .delete-media-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #c0c0c0;
            border: 1px outset #c0c0c0;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 18px;
            cursor: pointer;
        }
        
        .delete-media-btn:hover {
            background-color: #ff0000;
            color: white;
        }
        
        .delete-text-doc-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #c0c0c0;
            border: 1px outset #c0c0c0;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 18px;
            cursor: pointer;
        }
        
        .delete-text-doc-btn:hover {
            background-color: #ff0000;
            color: white;
        }
        
        .image-viewer {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .image-viewer img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .image-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
        }
        
        .image-nav.prev {
            left: 10px;
        }
        
        .image-nav.next {
            right: 10px;
        }
        
        .theme-selector {
            position: absolute;
            top: 30px;
            left: 80px;
            background-color: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 5px;
            z-index: 10;
        }
        
        .theme-option {
            padding: 5px 10px;
            cursor: pointer;
            margin-bottom: 2px;
        }
        
        .theme-option:hover {
            background-color: #000080;
            color: white;
        }
        
        .theme-option.active {
            background-color: #000080;
            color: white;
        }
        
        /* HTML Preview */
        .html-preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }
        
        .html-preview-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        /* Desktop Background Settings */
        .desktop-settings {
            position: absolute;
            top: 30px;
            left: 150px;
            background-color: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 5px;
            z-index: 10;
        }
        
        .desktop-option {
            padding: 5px 10px;
            cursor: pointer;
            margin-bottom: 2px;
        }
        
        .desktop-option:hover {
            background-color: #000080;
            color: white;
        }
        
        /* Загрузчик */
        .loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
        }
        
        .loader-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="win95">
    <!-- Загрузчик -->
    <div class="loader" id="loader">
        <div class="loader-spinner"></div>
        <div>Загрузка файловой системы...</div>
    </div>

    <div class="window">
        <div class="title-bar">
            <div class="title-bar-text">Файловый менеджер</div>
            <div class="title-bar-controls">
                <button class="title-bar-button">-</button>
                <button class="title-bar-button">□</button>
                <button class="title-bar-button">×</button>
            </div>
        </div>
        <div class="menu-bar">
            <div class="menu-item">Файл</div>
            <div class="menu-item">Правка</div>
            <div class="menu-item" id="view-menu">Вид</div>
            <div class="menu-item" id="desktop-menu">Рабочий стол</div>
            <div class="menu-item">Справка</div>
        </div>
        <div class="toolbar">
            <button class="button" id="btn-back">Назад</button>
            <button class="button" id="btn-up">Вверх</button>
            <button class="button" id="btn-new-folder">Новая папка</button>
            <button class="button" id="btn-new-file">Новый файл</button>
            <button class="button" id="btn-copy">Копировать</button>
            <button class="button" id="btn-cut">Вырезать</button>
            <button class="button" id="btn-paste">Вставить</button>
            <button class="button" id="btn-save">Сохранить</button>
            <button class="button" id="btn-load">Загрузить</button>
            <button class="button" id="btn-load-latest">Загрузить последнюю</button>
        </div>
        <div class="search-bar">
            <span>Поиск:</span>
            <input type="text" class="search-input" id="search-input" placeholder="Введите название файла или папки">
            <div class="search-options">
                <label class="checkbox-label">
                    <input type="checkbox" id="deep-search"> Расширенный поиск
                </label>
                <button class="button" id="btn-clear-search" style="margin-left: 10px;">Очистить</button>
            </div>
        </div>
        <div class="sort-options">
            <span>Сортировка:</span>
            <select class="sort-select" id="sort-select">
                <option value="name">По названию</option>
                <option value="date">По дате</option>
                <option value="type">По типу</option>
            </select>
            <select class="sort-select" id="sort-order">
                <option value="asc">По возрастанию</option>
                <option value="desc">По убыванию</option>
            </select>
        </div>
        <div class="address-bar">
            <span>Адрес:</span>
            <input type="text" class="address-input" id="current-path" readonly>
        </div>
        <div class="desktop-container">
            <div class="desktop-area" id="desktop-area">
                <!-- Содержимое файлового менеджера -->
            </div>
        </div>
        <div class="status-bar">
            <div class="status-bar-field" id="clipboard-status">Буфер обмена: пуст</div>
            <div class="status-bar-field" id="file-count">Файлов: 0</div>
            <div class="status-bar-field" id="last-save-info">Последнее сохранение: нет</div>
        </div>
    </div>

    <!-- Модальное окно для создания папки -->
    <div class="modal hidden" id="folder-modal">
        <div class="modal-content">
            <div class="title-bar">
                <div class="title-bar-text">Новая папка</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-folder-modal">×</button>
                </div>
            </div>
            <div class="modal-body">
                <p>Введите имя папки:</p>
                <input type="text" class="input-field" id="folder-name" placeholder="Имя папки">
                <div style="text-align: right; margin-top: 10px;">
                    <button class="button" id="cancel-folder">Отмена</button>
                    <button class="button" id="create-folder">Создать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания файла -->
    <div class="modal hidden" id="file-modal">
        <div class="modal-content">
            <div class="title-bar">
                <div class="title-bar-text">Новый файл</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-file-modal">×</button>
                </div>
            </div>
            <div class="modal-body">
                <p>Введите имя файла:</p>
                <input type="text" class="input-field" id="file-name" placeholder="Имя файла">
                <div style="text-align: right; margin-top: 10px;">
                    <button class="button" id="cancel-file">Отмена</button>
                    <button class="button" id="create-file">Создать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для редактирования файла -->
    <div class="modal hidden" id="editor-modal">
        <div class="modal-content" style="width: 95%; height: 90%;">
            <div class="title-bar">
                <div class="title-bar-text" id="editor-title">Редактор</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-editor-modal">×</button>
                </div>
            </div>
            <div class="toolbar">
                <button class="button" id="btn-save-file">Сохранить</button>
                <button class="button" id="btn-copy-file">Копировать</button>
                <button class="button" id="btn-open-in-editor">Открыть в редакторе</button>
                <button class="button" id="btn-add-image">Добавить изображения</button>
                <button class="button" id="btn-add-audio">Добавить аудио</button>
                <button class="button" id="btn-add-text-doc">Добавить текстовый документ</button>
                <button class="button" id="btn-preview-html" class="hidden">Просмотр HTML</button>
                <button class="button" id="btn-exit-preview" class="hidden">Выйти из просмотра</button>
            </div>
            <div class="modal-body" style="height: calc(100% - 60px); overflow: auto;">
                <textarea class="text-editor" id="file-editor"></textarea>
                <div id="file-content" class="hidden"></div>
                <div id="media-container"></div>
                <div class="text-documents-list" id="text-documents-list"></div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания текстового документа -->
    <div class="modal hidden" id="text-doc-modal">
        <div class="modal-content">
            <div class="title-bar">
                <div class="title-bar-text">Новый текстовый документ</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-text-doc-modal">×</button>
                </div>
            </div>
            <div class="modal-body">
                <p>Введите имя документа:</p>
                <input type="text" class="input-field" id="text-doc-name" placeholder="Имя документа">
                <p>Содержимое:</p>
                <textarea class="input-field" id="text-doc-content" placeholder="Введите текст документа" rows="5"></textarea>
                <div style="text-align: right; margin-top: 10px;">
                    <button class="button" id="cancel-text-doc">Отмена</button>
                    <button class="button" id="create-text-doc">Создать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно просмотра изображения -->
    <div class="modal hidden" id="image-viewer-modal">
        <div class="modal-content" style="width: 95%; height: 95%;">
            <div class="title-bar">
                <div class="title-bar-text" id="image-viewer-title">Просмотр изображения</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-image-viewer-modal">×</button>
                </div>
            </div>
            <div class="modal-body" style="height: calc(100% - 30px); padding: 0; position: relative;">
                <div class="image-viewer" id="image-viewer">
                    <button class="image-nav prev" id="prev-image">‹</button>
                    <img id="viewed-image" src="" alt="Просматриваемое изображение">
                    <button class="image-nav next" id="next-image">›</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно просмотра HTML -->
    <div class="modal hidden" id="html-preview-modal">
        <div class="modal-content" style="width: 95%; height: 95%;">
            <div class="title-bar">
                <div class="title-bar-text" id="html-preview-title">Просмотр HTML</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-html-preview-modal">×</button>
                </div>
            </div>
            <div class="toolbar">
                <button class="button" id="btn-refresh-html">Обновить</button>
                <button class="button" id="btn-open-html-external">Открыть в новой вкладке</button>
            </div>
            <div class="modal-body" style="height: calc(100% - 60px); padding: 0;">
                <div class="html-preview-container">
                    <iframe class="html-preview-frame" id="html-preview-frame" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Контекстное меню -->
    <div class="context-menu hidden" id="context-menu">
        <div class="context-menu-item" id="context-copy">Копировать</div>
        <div class="context-menu-item" id="context-cut">Вырезать</div>
        <div class="context-menu-item" id="context-paste">Вставить</div>
        <div class="context-menu-item" id="context-rename">Переименовать</div>
        <div class="context-menu-item" id="context-delete">Удалить</div>
    </div>

    <!-- Меню выбора темы -->
    <div class="theme-selector hidden" id="theme-selector">
        <div class="theme-option" data-theme="win95">Windows 95</div>
        <div class="theme-option" data-theme="winxp">Windows XP</div>
        <div class="theme-option" data-theme="win7">Windows 7</div>
    </div>

    <!-- Меню рабочего стола -->
    <div class="desktop-settings hidden" id="desktop-settings">
        <div class="desktop-option" id="set-desktop-bg">Установить фон рабочего стола</div>
        <div class="desktop-option" id="clear-desktop-bg">Убрать фон</div>
    </div>

    <script>
        // Глобальные переменные
        let fileSystem = {
            name: "root",
            type: "folder",
            children: [],
            path: "/"
        };
        
        let currentFolder = fileSystem;
        let pathHistory = [];
        let currentHistoryIndex = -1;
        let searchQuery = "";
        let sortBy = "name";
        let sortOrder = "asc";
        let deepSearch = false;
        let currentTheme = "win95";
        let currentImageIndex = 0;
        let currentImages = [];
        
        // Буфер обмена для операций копирования/вырезания
        let clipboard = {
            items: [],
            operation: null // 'copy' или 'cut'
        };

        // История сохранений
        let saveHistory = [];

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            initializeFileSystem();
            loadSaveHistory();
            autoLoadLatestSave();
        });

        // Инициализация файловой системы
        function initializeFileSystem() {
            // Создаем несколько примеров для демонстрации
            const examplesFolder = createFolder("Примеры");
            currentFolder.children.push(examplesFolder);
            
            const textFile = createFile("пример.txt", "text");
            textFile.content = "Это пример текстового файла.\nВы можете редактировать этот текст.";
            examplesFolder.children.push(textFile);
            
            const htmlFile = createFile("пример.html", "text");
            htmlFile.content = `<!DOCTYPE html>
<html>
<head>
    <title>Пример HTML</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 10px; margin: 5px; }
        .container { max-width: 600px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Демонстрация HTML</h1>
        <p>Это пример HTML документа, который можно редактировать и тестировать.</p>
        <button onclick="alert('Привет, мир!')">Нажми меня</button>
        <button onclick="document.getElementById('demo').innerHTML = 'Текст изменен!'">Изменить текст</button>
        <p id="demo">Исходный текст</p>
        <input type="text" id="inputField" placeholder="Введите текст">
        <button onclick="document.getElementById('output').innerHTML = document.getElementById('inputField').value">Показать введенный текст</button>
        <p id="output"></p>
    </div>
</body>
</html>`;
            examplesFolder.children.push(htmlFile);
            
            updateFileCount();
        }

        // Автоматическая загрузка последнего сохранения
        function autoLoadLatestSave() {
            if (saveHistory.length > 0) {
                // Сортируем историю по дате (новейшие сначала)
                saveHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Берем самое последнее сохранение
                const latestSave = saveHistory[0];
                
                // Показываем диалог подтверждения
                if (confirm(`Обнаружено сохранение от ${new Date(latestSave.timestamp).toLocaleString()}.\nЗагрузить его?`)) {
                    loadFileSystemFromData(latestSave.data);
                    hideLoader();
                    return;
                }
            }
            
            // Если сохранений нет или пользователь отказался
            hideLoader();
            setupEventListeners();
            renderFileExplorer();
        }

        // Скрытие загрузчика
        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
        }

        // Загрузка файловой системы из данных
        function loadFileSystemFromData(data) {
            try {
                fileSystem = JSON.parse(data);
                currentFolder = fileSystem;
                pathHistory = [];
                currentHistoryIndex = -1;
                
                loadTheme();
                loadDesktopBackground();
                setupEventListeners();
                renderFileExplorer();
                
                updateLastSaveInfo();
                alert('Последняя файловая система загружена успешно!');
            } catch (error) {
                alert('Ошибка при загрузке файловой системы: ' + error.message);
                setupEventListeners();
                renderFileExplorer();
            }
        }

        // Загрузка истории сохранений
        function loadSaveHistory() {
            const savedHistory = localStorage.getItem('fileManagerSaveHistory');
            if (savedHistory) {
                try {
                    saveHistory = JSON.parse(savedHistory);
                } catch (error) {
                    console.error('Ошибка при загрузке истории сохранений:', error);
                    saveHistory = [];
                }
            }
        }

        // Сохранение истории
        function saveSaveHistory() {
            localStorage.setItem('fileManagerSaveHistory', JSON.stringify(saveHistory));
        }

        // Добавление сохранения в историю
        function addToSaveHistory(data) {
            const timestamp = new Date().toISOString();
            
            // Добавляем новое сохранение
            saveHistory.unshift({
                timestamp: timestamp,
                data: data
            });
            
            // Ограничиваем историю 10 последними сохранениями
            if (saveHistory.length > 10) {
                saveHistory = saveHistory.slice(0, 10);
            }
            
            saveSaveHistory();
            updateLastSaveInfo();
        }

        // Обновление информации о последнем сохранении
        function updateLastSaveInfo() {
            const lastSaveInfo = document.getElementById('last-save-info');
            if (saveHistory.length > 0) {
                const latestSave = saveHistory[0];
                lastSaveInfo.textContent = `Последнее сохранение: ${new Date(latestSave.timestamp).toLocaleString()}`;
            } else {
                lastSaveInfo.textContent = 'Последнее сохранение: нет';
            }
        }

        // Создание объекта папки
        function createFolder(name) {
            return {
                name: name,
                type: "folder",
                children: [],
                path: currentFolder.path + name + "/",
                created: new Date().toLocaleString()
            };
        }

        // Создание объекта файла
        function createFile(name, type) {
            return {
                name: name,
                type: type,
                content: "",
                path: currentFolder.path + name,
                created: new Date().toLocaleString(),
                media: [],
                textDocuments: []
            };
        }

        // Создание объекта текстового документа
        function createTextDocument(name, content = "") {
            return {
                name: name,
                content: content,
                created: new Date().toLocaleString()
            };
        }

        // Отрисовка файлового менеджера
        function renderFileExplorer() {
            const explorer = document.getElementById('desktop-area');
            explorer.innerHTML = '';
            
            // Получаем отфильтрованный и отсортированный список элементов
            let items = getFilteredAndSortedItems();
            
            // Отображаем родительскую папку, если это не корневая
            if (currentFolder !== fileSystem) {
                const parentItem = document.createElement('div');
                parentItem.className = 'folder-item';
                parentItem.innerHTML = `
                    <div class="folder-icon"></div>
                    <div class="file-name">..</div>
                `;
                parentItem.addEventListener('click', function() {
                    navigateToParent();
                });
                explorer.appendChild(parentItem);
            }
            
            // Отображаем папки
            items.filter(item => item.type === 'folder').forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item';
                folderItem.innerHTML = `
                    <div class="folder-icon"></div>
                    <div class="file-name">${folder.name}</div>
                    <div class="file-date">${folder.created}</div>
                `;
                folderItem.addEventListener('click', function(e) {
                    if (e.ctrlKey) {
                        // Выбор нескольких элементов с Ctrl
                        folderItem.classList.toggle('selected');
                    } else {
                        // Одиночный выбор
                        clearSelection();
                        folderItem.classList.add('selected');
                        navigateToFolder(folder);
                    }
                });
                folderItem.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    clearSelection();
                    folderItem.classList.add('selected');
                    showContextMenu(e, folder);
                });
                explorer.appendChild(folderItem);
            });
            
            // Отображаем файлы
            items.filter(item => item.type !== 'folder').forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                let iconClass = 'file-icon';
                if (file.name.endsWith('.txt')) {
                    iconClass = 'text-file-icon';
                } else if (file.name.endsWith('.jpg') || file.name.endsWith('.png') || file.name.endsWith('.gif')) {
                    iconClass = 'image-file-icon';
                } else if (file.name.endsWith('.mp3') || file.name.endsWith('.wav')) {
                    iconClass = 'audio-file-icon';
                }
                
                fileItem.innerHTML = `
                    <div class="${iconClass}"></div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-date">${file.created}</div>
                `;
                fileItem.addEventListener('click', function(e) {
                    if (e.ctrlKey) {
                        // Выбор нескольких элементов с Ctrl
                        fileItem.classList.toggle('selected');
                    } else {
                        // Одиночный выбор
                        clearSelection();
                        fileItem.classList.add('selected');
                        openFile(file);
                    }
                });
                fileItem.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    clearSelection();
                    fileItem.classList.add('selected');
                    showContextMenu(e, file);
                });
                explorer.appendChild(fileItem);
            });
            
            // Обновляем путь в адресной строке
            document.getElementById('current-path').value = currentFolder.path;
        }

        // Очистка выделения
        function clearSelection() {
            document.querySelectorAll('.file-item.selected, .folder-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
        }

        // Получение отфильтрованного и отсортированного списка элементов
        function getFilteredAndSortedItems() {
            let items = [];
            
            // Если включен расширенный поиск, ищем во всей файловой системе
            if (deepSearch && searchQuery) {
                items = searchInFileSystem(fileSystem, searchQuery.toLowerCase());
            } else {
                // Иначе работаем только с текущей папкой
                items = [...currentFolder.children];
                
                // Применяем фильтрацию по поисковому запросу
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    items = items.filter(item => 
                        item.name.toLowerCase().includes(query)
                    );
                }
            }
            
            // Применяем сортировку
            items.sort((a, b) => {
                let aValue, bValue;
                
                if (sortBy === 'name') {
                    aValue = a.name.toLowerCase();
                    bValue = b.name.toLowerCase();
                } else if (sortBy === 'date') {
                    aValue = new Date(a.created);
                    bValue = new Date(b.created);
                } else if (sortBy === 'type') {
                    aValue = a.type === 'folder' ? 0 : 1;
                    bValue = b.type === 'folder' ? 0 : 1;
                }
                
                if (aValue < bValue) return sortOrder === 'asc' ? -1 : 1;
                if (aValue > bValue) return sortOrder === 'asc' ? 1 : -1;
                return 0;
            });
            
            return items;
        }

        // Рекурсивный поиск во всей файловой системе
        function searchInFileSystem(folder, query) {
            let results = [];
            
            for (let item of folder.children) {
                if (item.name.toLowerCase().includes(query)) {
                    results.push(item);
                }
                
                if (item.type === 'folder') {
                    results = results.concat(searchInFileSystem(item, query));
                }
            }
            
            return results;
        }

        // Навигация в папку
        function navigateToFolder(folder) {
            pathHistory = pathHistory.slice(0, currentHistoryIndex + 1);
            pathHistory.push(currentFolder);
            currentHistoryIndex++;
            currentFolder = folder;
            renderFileExplorer();
        }

        // Навигация к родительской папке
        function navigateToParent() {
            if (currentFolder === fileSystem) return;
            
            let parent = findParent(fileSystem, currentFolder);
            if (parent) {
                pathHistory = pathHistory.slice(0, currentHistoryIndex + 1);
                pathHistory.push(currentFolder);
                currentHistoryIndex++;
                currentFolder = parent;
                renderFileExplorer();
            }
        }

        // Поиск родительской папки
        function findParent(root, folder) {
            if (root.children.includes(folder)) {
                return root;
            }
            
            for (let child of root.children) {
                if (child.type === 'folder') {
                    const result = findParent(child, folder);
                    if (result) return result;
                }
            }
            
            return null;
        }

        // Копирование элементов
        function copyItems() {
            const selectedItems = document.querySelectorAll('.file-item.selected, .folder-item.selected');
            if (selectedItems.length === 0) return;
            
            // Копируем выделенные элементы
            clipboard.items = Array.from(selectedItems).map(item => {
                const itemName = item.querySelector('.file-name').textContent;
                if (itemName === '..') return null;
                
                return currentFolder.children.find(child => child.name === itemName);
            }).filter(item => item !== null);
            
            clipboard.operation = 'copy';
            updateClipboardStatus();
        }

        // Вырезание элементов
        function cutItems() {
            const selectedItems = document.querySelectorAll('.file-item.selected, .folder-item.selected');
            if (selectedItems.length === 0) return;
            
            // Вырезаем выделенные элементы
            clipboard.items = Array.from(selectedItems).map(item => {
                const itemName = item.querySelector('.file-name').textContent;
                if (itemName === '..') return null;
                
                return currentFolder.children.find(child => child.name === itemName);
            }).filter(item => item !== null);
            
            clipboard.operation = 'cut';
            updateClipboardStatus();
        }

        // Вставка элементов
        function pasteItems() {
            if (clipboard.items.length === 0) return;
            
            clipboard.items.forEach(item => {
                if (item) {
                    if (clipboard.operation === 'copy') {
                        // Создаем копию элемента
                        const copiedItem = JSON.parse(JSON.stringify(item));
                        copiedItem.name = findUniqueName(copiedItem.name);
                        currentFolder.children.push(copiedItem);
                    } else if (clipboard.operation === 'cut') {
                        // Перемещаем элемент
                        const originalParent = findParent(fileSystem, item);
                        if (originalParent) {
                            const index = originalParent.children.indexOf(item);
                            if (index !== -1) {
                                originalParent.children.splice(index, 1);
                                
                                // Изменяем имя если нужно
                                item.name = findUniqueName(item.name);
                                currentFolder.children.push(item);
                            }
                        }
                    }
                }
            });
            
            // Очищаем буфер после вставки
            if (clipboard.operation === 'cut') {
                clipboard.items = [];
                clipboard.operation = null;
                updateClipboardStatus();
            }
            
            renderFileExplorer();
            autoSave();
        }

        // Поиск уникального имени
        function findUniqueName(originalName) {
            let name = originalName;
            let counter = 1;
            
            while (currentFolder.children.some(item => item.name === name)) {
                const dotIndex = originalName.lastIndexOf('.');
                if (dotIndex !== -1) {
                    const baseName = originalName.substring(0, dotIndex);
                    const extension = originalName.substring(dotIndex);
                    name = `${baseName} (${counter})${extension}`;
                } else {
                    name = `${originalName} (${counter})`;
                }
                counter++;
            }
            
            return name;
        }

        // Обновление статуса буфера обмена
        function updateClipboardStatus() {
            const statusElement = document.getElementById('clipboard-status');
            if (clipboard.items.length > 0) {
                const itemNames = clipboard.items.map(item => item.name).join(', ');
                statusElement.textContent = `Буфер обмена: ${clipboard.operation === 'copy' ? 'Копирование' : 'Вырезание'} - ${itemNames}`;
            } else {
                statusElement.textContent = 'Буфер обмена: пуст';
            }
        }

        // Открытие файла
        function openFile(file) {
            const editor = document.getElementById('file-editor');
            const contentView = document.getElementById('file-content');
            const mediaContainer = document.getElementById('media-container');
            const textDocumentsList = document.getElementById('text-documents-list');
            const previewBtn = document.getElementById('btn-preview-html');
            const exitPreviewBtn = document.getElementById('btn-exit-preview');
            
            // Скрываем кнопки просмотра по умолчанию
            previewBtn.classList.add('hidden');
            exitPreviewBtn.classList.add('hidden');
            editor.classList.remove('hidden');
            contentView.classList.add('hidden');
            
            // Очищаем контейнер медиа
            mediaContainer.innerHTML = '';
            textDocumentsList.innerHTML = '';
            
            // Устанавливаем заголовок
            document.getElementById('editor-title').textContent = file.name;
            
            // Загружаем содержимое файла
            editor.value = file.content || '';
            
            // Отображаем медиа-файлы, если они есть
            if (file.media && file.media.length > 0) {
                file.media.forEach((media, index) => {
                    const mediaItem = document.createElement('div');
                    mediaItem.className = 'media-item';
                    
                    if (media.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = media.data;
                        img.className = 'image-preview';
                        img.addEventListener('click', function() {
                            openImageViewer(file.media, index);
                        });
                        mediaItem.appendChild(img);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-media-btn';
                        deleteBtn.innerHTML = '×';
                        deleteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            deleteMedia(file, index);
                        });
                        mediaItem.appendChild(deleteBtn);
                    } else if (media.type.startsWith('audio/')) {
                        const audio = document.createElement('audio');
                        audio.controls = true;
                        audio.src = media.data;
                        audio.className = 'audio-player';
                        mediaItem.appendChild(audio);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-media-btn';
                        deleteBtn.innerHTML = '×';
                        deleteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            deleteMedia(file, index);
                        });
                        mediaItem.appendChild(deleteBtn);
                    }
                    
                    mediaContainer.appendChild(mediaItem);
                });
            }
            
            // Отображаем текстовые документы, если они есть
            if (file.textDocuments && file.textDocuments.length > 0) {
                const title = document.createElement('h4');
                title.textContent = 'Текстовые документы:';
                textDocumentsList.appendChild(title);
                
                file.textDocuments.forEach((doc, index) => {
                    const docItem = document.createElement('div');
                    docItem.className = 'text-document-item';
                    docItem.innerHTML = `
                        <div><strong>${doc.name}</strong></div>
                        <div class="file-date">Создан: ${doc.created}</div>
                        <div class="text-document-preview">${doc.content || '(пустой документ)'}</div>
                    `;
                    docItem.addEventListener('click', function() {
                        openTextDocument(file, doc, index);
                    });
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-text-doc-btn';
                    deleteBtn.innerHTML = '×';
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteTextDocument(file, index);
                    });
                    docItem.appendChild(deleteBtn);
                    
                    textDocumentsList.appendChild(docItem);
                });
            }
            
            // Показываем кнопку предпросмотра для HTML файлов
            if (file.name.endsWith('.html')) {
                previewBtn.classList.remove('hidden');
            }
            
            // Показываем модальное окно редактора
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        // Удаление медиа-файла
        function deleteMedia(file, index) {
            if (file && file.media) {
                file.media.splice(index, 1);
                openFile(file); // Перезагружаем отображение
                autoSave();
            }
        }

        // Удаление текстового документа
        function deleteTextDocument(file, index) {
            if (file && file.textDocuments) {
                file.textDocuments.splice(index, 1);
                openFile(file); // Перезагружаем отображение
                autoSave();
            }
        }

        // Открытие текстового документа
        function openTextDocument(file, doc, index) {
            const content = prompt(`Содержимое документа "${doc.name}":`, doc.content);
            if (content !== null) {
                doc.content = content;
                autoSave();
                // Обновляем предпросмотр
                const docItems = document.querySelectorAll('.text-document-item');
                if (docItems[index]) {
                    const preview = docItems[index].querySelector('.text-document-preview');
                    if (preview) {
                        preview.textContent = content || '(пустой документ)';
                    }
                }
            }
        }

        // Открытие просмотрщика изображений
        function openImageViewer(images, startIndex) {
            currentImages = images.filter(img => img.type.startsWith('image/'));
            currentImageIndex = startIndex;
            
            if (currentImages.length === 0) return;
            
            const imageViewerModal = document.getElementById('image-viewer-modal');
            const viewedImage = document.getElementById('viewed-image');
            
            viewedImage.src = currentImages[currentImageIndex].data;
            document.getElementById('image-viewer-title').textContent = `Изображение ${currentImageIndex + 1} из ${currentImages.length}`;
            
            imageViewerModal.classList.remove('hidden');
            
            // Добавляем обработчики для перелистывания
            document.getElementById('prev-image').addEventListener('click', showPrevImage);
            document.getElementById('next-image').addEventListener('click', showNextImage);
            
            // Добавляем обработчики для свайпов
            let startX = 0;
            viewedImage.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
            });
            
            viewedImage.addEventListener('touchend', function(e) {
                if (!startX) return;
                
                const endX = e.changedTouches[0].clientX;
                const diffX = startX - endX;
                
                if (Math.abs(diffX) > 50) { // Минимальное расстояние для свайпа
                    if (diffX > 0) {
                        showNextImage();
                    } else {
                        showPrevImage();
                    }
                }
                
                startX = 0;
            });
        }

        // Показать предыдущее изображение
        function showPrevImage() {
            if (currentImages.length === 0) return;
            
            currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
            document.getElementById('viewed-image').src = currentImages[currentImageIndex].data;
            document.getElementById('image-viewer-title').textContent = `Изображение ${currentImageIndex + 1} из ${currentImages.length}`;
        }

        // Показать следующее изображение
        function showNextImage() {
            if (currentImages.length === 0) return;
            
            currentImageIndex = (currentImageIndex + 1) % currentImages.length;
            document.getElementById('viewed-image').src = currentImages[currentImageIndex].data;
            document.getElementById('image-viewer-title').textContent = `Изображение ${currentImageIndex + 1} из ${currentImages.length}`;
        }

        // Открытие HTML в полнофункциональном просмотрщике
        function openHtmlPreview() {
            const selectedItems = document.querySelectorAll('.file-item.selected');
            if (selectedItems.length === 0) return;
            
            const itemName = selectedItems[0].querySelector('.file-name').textContent;
            const file = currentFolder.children.find(child => child.name === itemName);
            
            if (!file || !file.name.endsWith('.html')) return;
            
            const htmlPreviewModal = document.getElementById('html-preview-modal');
            const htmlPreviewFrame = document.getElementById('html-preview-frame');
            
            document.getElementById('html-preview-title').textContent = `Просмотр: ${file.name}`;
            
            // Создаем Blob из HTML содержимого
            const blob = new Blob([file.content], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            
            htmlPreviewFrame.src = url;
            htmlPreviewModal.classList.remove('hidden');
        }

        // Обновление HTML просмотра
        function refreshHtmlPreview() {
            const htmlPreviewFrame = document.getElementById('html-preview-frame');
            const selectedItems = document.querySelectorAll('.file-item.selected');
            if (selectedItems.length === 0) return;
            
            const itemName = selectedItems[0].querySelector('.file-name').textContent;
            const file = currentFolder.children.find(child => child.name === itemName);
            
            if (file) {
                const blob = new Blob([file.content], {type: 'text/html'});
                const url = URL.createObjectURL(blob);
                htmlPreviewFrame.src = url;
            }
        }

        // Открытие HTML во внешней вкладке
        function openHtmlExternal() {
            const selectedItems = document.querySelectorAll('.file-item.selected');
            if (selectedItems.length === 0) return;
            
            const itemName = selectedItems[0].querySelector('.file-name').textContent;
            const file = currentFolder.children.find(child => child.name === itemName);
            
            if (file) {
                const blob = new Blob([file.content], {type: 'text/html'});
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
            }
        }

        // Установка фона рабочего стола
        function setDesktopBackground() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const desktopArea = document.getElementById('desktop-area');
                    desktopArea.style.backgroundImage = `url(${e.target.result})`;
                    
                    // Сохраняем фон в localStorage
                    localStorage.setItem('fileManagerDesktopBg', e.target.result);
                };
                reader.readAsDataURL(file);
            });
            
            input.click();
        }

        // Очистка фона рабочего стола
        function clearDesktopBackground() {
            const desktopArea = document.getElementById('desktop-area');
            desktopArea.style.backgroundImage = 'none';
            localStorage.removeItem('fileManagerDesktopBg');
        }

        // Загрузка фона рабочего стола
        function loadDesktopBackground() {
            const savedBg = localStorage.getItem('fileManagerDesktopBg');
            if (savedBg) {
                const desktopArea = document.getElementById('desktop-area');
                desktopArea.style.backgroundImage = `url(${savedBg})`;
            }
        }

        // Открытие в редакторе
        function openInEditor() {
            const selectedItems = document.querySelectorAll('.file-item.selected');
            if (selectedItems.length === 0) return;
            
            const itemName = selectedItems[0].querySelector('.file-name').textContent;
            const file = currentFolder.children.find(child => child.name === itemName);
            
            if (file) {
                // Копируем содержимое файла в буфер обмена
                const editor = document.getElementById('file-editor');
                editor.value = file.content;
                editor.select();
                document.execCommand('copy');
                
                // Открываем редактор в новой вкладке
                window.open('https://2d3t.github.io/index.html/pro/redactor.html', '_blank');
            }
        }

        // Показать контекстное меню
        function showContextMenu(e, item) {
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            contextMenu.classList.remove('hidden');
            
            // Закрываем контекстное меню при клике вне его
            document.addEventListener('click', closeContextMenu);
        }

        // Закрыть контекстное меню
        function closeContextMenu() {
            document.getElementById('context-menu').classList.add('hidden');
            document.removeEventListener('click', closeContextMenu);
        }

        // Переименование элемента
        function renameItem() {
            const selectedItems = document.querySelectorAll('.file-item.selected, .folder-item.selected');
            if (selectedItems.length === 0) return;
            
            const itemName = selectedItems[0].querySelector('.file-name').textContent;
            const item = currentFolder.children.find(child => child.name === itemName);
            
            if (!item) return;
            
            const newName = prompt('Введите новое имя:', item.name);
            if (newName && newName.trim() !== '') {
                item.name = newName.trim();
                renderFileExplorer();
                autoSave();
            }
            
            closeContextMenu();
        }

        // Удаление элемента
        function deleteItem() {
            const selectedItems = document.querySelectorAll('.file-item.selected, .folder-item.selected');
            if (selectedItems.length === 0) return;
            
            const itemNames = Array.from(selectedItems).map(item => 
                item.querySelector('.file-name').textContent
            ).filter(name => name !== '..');
            
            if (itemNames.length === 0) return;
            
            const message = itemNames.length === 1 
                ? `Вы уверены, что хотите удалить "${itemNames[0]}"?`
                : `Вы уверены, что хотите удалить ${itemNames.length} элементов?`;
            
            if (confirm(message)) {
                itemNames.forEach(itemName => {
                    const index = currentFolder.children.findIndex(child => child.name === itemName);
                    if (index !== -1) {
                        currentFolder.children.splice(index, 1);
                    }
                });
                
                renderFileExplorer();
                updateFileCount();
                autoSave();
            }
            
            closeContextMenu();
        }

        // Обновление счетчика файлов
        function updateFileCount() {
            const fileCount = currentFolder.children.filter(item => item.type !== 'folder').length;
            const folderCount = currentFolder.children.filter(item => item.type === 'folder').length;
            document.getElementById('file-count').textContent = `Папок: ${folderCount}, Файлов: ${fileCount}`;
        }

        // Сохранение файловой системы
        function saveFileSystem() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const fileName = `${timestamp}.db`;
            
            const dataStr = JSON.stringify(fileSystem);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = fileName;
            link.click();
            
            URL.revokeObjectURL(link.href);
            
            // Добавляем в историю сохранений
            addToSaveHistory(dataStr);
        }

        // Загрузка файловой системы
        function loadFileSystem() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.db';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        fileSystem = data;
                        currentFolder = fileSystem;
                        pathHistory = [];
                        currentHistoryIndex = -1;
                        renderFileExplorer();
                        
                        // Добавляем в историю сохранений
                        addToSaveHistory(e.target.result);
                        
                        alert('Файловая система загружена успешно!');
                    } catch (error) {
                        alert('Ошибка при загрузке файловой системы: ' + error.message);
                    }
                };
                reader.readAsText(file);
            });
            
            input.click();
        }

        // Загрузка последнего сохранения
        function loadLatestSave() {
            if (saveHistory.length > 0) {
                // Сортируем историю по дате (новейшие сначала)
                saveHistory.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Берем самое последнее сохранение
                const latestSave = saveHistory[0];
                loadFileSystemFromData(latestSave.data);
            } else {
                alert('История сохранений пуста!');
            }
        }

        // Автосохранение при выходе
        function autoSave() {
            const dataStr = JSON.stringify(fileSystem);
            localStorage.setItem('fileManagerAutoSave', dataStr);
            
            // Также добавляем в историю при значительных изменениях
            addToSaveHistory(dataStr);
        }

        // Загрузка автосохранения
        function loadAutoSave() {
            const saved = localStorage.getItem('fileManagerAutoSave');
            if (saved) {
                try {
                    fileSystem = JSON.parse(saved);
                    currentFolder = fileSystem;
                    renderFileExplorer();
                } catch (error) {
                    console.error('Ошибка при загрузке автосохранения:', error);
                }
            }
        }

        // Сохранение темы
        function saveTheme() {
            localStorage.setItem('fileManagerTheme', currentTheme);
        }

        // Загрузка темы
        function loadTheme() {
            const savedTheme = localStorage.getItem('fileManagerTheme');
            if (savedTheme) {
                setTheme(savedTheme);
            }
        }

        // Установка темы
        function setTheme(theme) {
            currentTheme = theme;
            document.body.className = theme;
            saveTheme();
            
            // Обновляем активную тему в меню
            const themeOptions = document.querySelectorAll('.theme-option');
            themeOptions.forEach(option => {
                if (option.dataset.theme === theme) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Кнопки навигации
            document.getElementById('btn-back').addEventListener('click', function() {
                if (currentHistoryIndex > 0) {
                    currentHistoryIndex--;
                    currentFolder = pathHistory[currentHistoryIndex];
                    pathHistory = pathHistory.slice(0, currentHistoryIndex + 1);
                    renderFileExplorer();
                }
            });
            
            document.getElementById('btn-up').addEventListener('click', navigateToParent);
            
            // Кнопки создания
            document.getElementById('btn-new-folder').addEventListener('click', function() {
                document.getElementById('folder-modal').classList.remove('hidden');
                document.getElementById('folder-name').focus();
            });
            
            document.getElementById('btn-new-file').addEventListener('click', function() {
                document.getElementById('file-modal').classList.remove('hidden');
                document.getElementById('file-name').focus();
            });
            
            // Кнопки операций с файлами
            document.getElementById('btn-copy').addEventListener('click', copyItems);
            document.getElementById('btn-cut').addEventListener('click', cutItems);
            document.getElementById('btn-paste').addEventListener('click', pasteItems);
            
            // Кнопки сохранения/загрузки
            document.getElementById('btn-save').addEventListener('click', saveFileSystem);
            document.getElementById('btn-load').addEventListener('click', loadFileSystem);
            document.getElementById('btn-load-latest').addEventListener('click', loadLatestSave);
            
            // Поиск
            document.getElementById('search-input').addEventListener('input', function(e) {
                searchQuery = e.target.value;
                renderFileExplorer();
            });
            
            document.getElementById('btn-clear-search').addEventListener('click', function() {
                document.getElementById('search-input').value = '';
                searchQuery = '';
                renderFileExplorer();
            });
            
            document.getElementById('deep-search').addEventListener('change', function(e) {
                deepSearch = e.target.checked;
                if (searchQuery) {
                    renderFileExplorer();
                }
            });
            
            // Сортировка
            document.getElementById('sort-select').addEventListener('change', function(e) {
                sortBy = e.target.value;
                renderFileExplorer();
            });
            
            document.getElementById('sort-order').addEventListener('change', function(e) {
                sortOrder = e.target.value;
                renderFileExplorer();
            });
            
            // Меню вида (темы)
            document.getElementById('view-menu').addEventListener('click', function(e) {
                const themeSelector = document.getElementById('theme-selector');
                themeSelector.classList.toggle('hidden');
                e.stopPropagation();
            });
            
            // Меню рабочего стола
            document.getElementById('desktop-menu').addEventListener('click', function(e) {
                const desktopSettings = document.getElementById('desktop-settings');
                desktopSettings.classList.toggle('hidden');
                e.stopPropagation();
            });
            
            document.addEventListener('click', function() {
                document.getElementById('theme-selector').classList.add('hidden');
                document.getElementById('desktop-settings').classList.add('hidden');
            });
            
            // Выбор темы
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    setTheme(this.dataset.theme);
                    document.getElementById('theme-selector').classList.add('hidden');
                });
            });
            
            // Настройки рабочего стола
            document.getElementById('set-desktop-bg').addEventListener('click', setDesktopBackground);
            document.getElementById('clear-desktop-bg').addEventListener('click', clearDesktopBackground);
            
            // Модальное окно папки
            document.getElementById('close-folder-modal').addEventListener('click', function() {
                document.getElementById('folder-modal').classList.add('hidden');
            });
            
            document.getElementById('cancel-folder').addEventListener('click', function() {
                document.getElementById('folder-modal').classList.add('hidden');
            });
            
            document.getElementById('create-folder').addEventListener('click', function() {
                const folderName = document.getElementById('folder-name').value.trim();
                if (folderName) {
                    const newFolder = createFolder(folderName);
                    currentFolder.children.push(newFolder);
                    renderFileExplorer();
                    updateFileCount();
                    document.getElementById('folder-modal').classList.add('hidden');
                    document.getElementById('folder-name').value = '';
                    autoSave();
                }
            });
            
            // Модальное окно файла
            document.getElementById('close-file-modal').addEventListener('click', function() {
                document.getElementById('file-modal').classList.add('hidden');
            });
            
            document.getElementById('cancel-file').addEventListener('click', function() {
                document.getElementById('file-modal').classList.add('hidden');
            });
            
            document.getElementById('create-file').addEventListener('click', function() {
                const fileName = document.getElementById('file-name').value.trim();
                if (fileName) {
                    const fileType = fileName.endsWith('.html') ? 'html' : 'text';
                    const newFile = createFile(fileName, fileType);
                    currentFolder.children.push(newFile);
                    renderFileExplorer();
                    updateFileCount();
                    document.getElementById('file-modal').classList.add('hidden');
                    document.getElementById('file-name').value = '';
                    autoSave();
                }
            });
            
            // Модальное окно редактора
            document.getElementById('close-editor-modal').addEventListener('click', function() {
                document.getElementById('editor-modal').classList.add('hidden');
                const selectedItems = document.querySelectorAll('.file-item.selected');
                if (selectedItems.length > 0) {
                    const itemName = selectedItems[0].querySelector('.file-name').textContent;
                    const file = currentFolder.children.find(child => child.name === itemName);
                    if (file) {
                        file.content = document.getElementById('file-editor').value;
                        autoSave();
                    }
                }
            });
            
            document.getElementById('btn-save-file').addEventListener('click', function() {
                const selectedItems = document.querySelectorAll('.file-item.selected');
                if (selectedItems.length > 0) {
                    const itemName = selectedItems[0].querySelector('.file-name').textContent;
                    const file = currentFolder.children.find(child => child.name === itemName);
                    if (file) {
                        file.content = document.getElementById('file-editor').value;
                        autoSave();
                        alert('Файл сохранен!');
                    }
                }
            });
            
            document.getElementById('btn-copy-file').addEventListener('click', function() {
                const editor = document.getElementById('file-editor');
                editor.select();
                document.execCommand('copy');
                alert('Содержимое скопировано в буфер обмена!');
            });
            
            document.getElementById('btn-open-in-editor').addEventListener('click', openInEditor);
            
            document.getElementById('btn-add-image').addEventListener('click', function() {
                const selectedItems = document.querySelectorAll('.file-item.selected');
                if (selectedItems.length === 0) return;
                
                const itemName = selectedItems[0].querySelector('.file-name').textContent;
                const file = currentFolder.children.find(child => child.name === itemName);
                
                if (!file) return;
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.multiple = true;
                
                input.addEventListener('change', function(e) {
                    const files = e.target.files;
                    if (!files || files.length === 0) return;
                    
                    let loadedCount = 0;
                    
                    for (let i = 0; i < files.length; i++) {
                        const fileItem = files[i];
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            if (file) {
                                if (!file.media) file.media = [];
                                file.media.push({
                                    type: fileItem.type,
                                    data: e.target.result
                                });
                                
                                loadedCount++;
                                
                                // После загрузки всех файлов обновляем отображение
                                if (loadedCount === files.length) {
                                    openFile(file);
                                    autoSave();
                                }
                            }
                        };
                        reader.readAsDataURL(fileItem);
                    }
                });
                
                input.click();
            });
            
            document.getElementById('btn-add-audio').addEventListener('click', function() {
                const selectedItems = document.querySelectorAll('.file-item.selected');
                if (selectedItems.length === 0) return;
                
                const itemName = selectedItems[0].querySelector('.file-name').textContent;
                const file = currentFolder.children.find(child => child.name === itemName);
                
                if (!file) return;
                
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'audio/*';
                
                input.addEventListener('change', function(e) {
                    const fileItem = e.target.files[0];
                    if (!fileItem) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (file) {
                            if (!file.media) file.media = [];
                            file.media.push({
                                type: fileItem.type,
                                data: e.target.result
                            });
                            
                            // Обновляем отображение
                            openFile(file);
                            autoSave();
                        }
                    };
                    reader.readAsDataURL(fileItem);
                });
                
                input.click();
            });
            
            document.getElementById('btn-add-text-doc').addEventListener('click', function() {
                const selectedItems = document.querySelectorAll('.file-item.selected');
                if (selectedItems.length === 0) return;
                
                const itemName = selectedItems[0].querySelector('.file-name').textContent;
                const file = currentFolder.children.find(child => child.name === itemName);
                
                if (!file) return;
                
                document.getElementById('text-doc-modal').classList.remove('hidden');
                document.getElementById('text-doc-name').focus();
            });
            
            document.getElementById('btn-preview-html').addEventListener('click', openHtmlPreview);
            
            document.getElementById('btn-exit-preview').addEventListener('click', function() {
                const editor = document.getElementById('file-editor');
                const contentView = document.getElementById('file-content');
                const previewBtn = document.getElementById('btn-preview-html');
                const exitPreviewBtn = document.getElementById('btn-exit-preview');
                
                editor.classList.remove('hidden');
                contentView.classList.add('hidden');
                previewBtn.classList.remove('hidden');
                exitPreviewBtn.classList.add('hidden');
            });
            
            // Модальное окно текстового документа
            document.getElementById('close-text-doc-modal').addEventListener('click', function() {
                document.getElementById('text-doc-modal').classList.add('hidden');
            });
            
            document.getElementById('cancel-text-doc').addEventListener('click', function() {
                document.getElementById('text-doc-modal').classList.add('hidden');
            });
            
            document.getElementById('create-text-doc').addEventListener('click', function() {
                const selectedItems = document.querySelectorAll('.file-item.selected');
                if (selectedItems.length === 0) return;
                
                const itemName = selectedItems[0].querySelector('.file-name').textContent;
                const file = currentFolder.children.find(child => child.name === itemName);
                
                if (!file) return;
                
                const docName = document.getElementById('text-doc-name').value.trim();
                const docContent = document.getElementById('text-doc-content').value;
                
                if (docName) {
                    if (!file.textDocuments) file.textDocuments = [];
                    const newDoc = createTextDocument(docName, docContent);
                    file.textDocuments.push(newDoc);
                    
                    // Обновляем отображение
                    openFile(file);
                    
                    document.getElementById('text-doc-modal').classList.add('hidden');
                    document.getElementById('text-doc-name').value = '';
                    document.getElementById('text-doc-content').value = '';
                    autoSave();
                }
            });
            
            // Модальное окно просмотра изображений
            document.getElementById('close-image-viewer-modal').addEventListener('click', function() {
                document.getElementById('image-viewer-modal').classList.add('hidden');
            });
            
            // Модальное окно просмотра HTML
            document.getElementById('close-html-preview-modal').addEventListener('click', function() {
                document.getElementById('html-preview-modal').classList.add('hidden');
            });
            
            document.getElementById('btn-refresh-html').addEventListener('click', refreshHtmlPreview);
            
            document.getElementById('btn-open-html-external').addEventListener('click', openHtmlExternal);
            
            // Контекстное меню
            document.getElementById('context-copy').addEventListener('click', copyItems);
            document.getElementById('context-cut').addEventListener('click', cutItems);
            document.getElementById('context-paste').addEventListener('click', pasteItems);
            document.getElementById('context-rename').addEventListener('click', renameItem);
            document.getElementById('context-delete').addEventListener('click', deleteItem);
            
            // Автосохранение при закрытии страницы
            window.addEventListener('beforeunload', autoSave);
        }
    </script>
</body>
</html>