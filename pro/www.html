<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Файловый менеджер</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'MS Sans Serif', Arial, sans-serif;
        }
        
        body {
            background-color: #c0c0c0;
            padding: 5px;
            font-size: 14px;
            position: relative;
            min-height: 100vh;
        }
        
        /* Рабочий стол с фоном */
        .desktop-container {
            position: relative;
            border: 2px outset #c0c0c0;
            background-color: #c0c0c0;
            margin-bottom: 5px;
            overflow: hidden;
        }
        
        .desktop-area {
            position: relative;
            height: 400px;
            overflow-y: auto;
            padding: 5px;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        
        /* Темы оформления */
        body.win95 {
            background-color: #c0c0c0;
        }
        
        body.winxp {
            background-color: #ece9d8;
        }
        
        body.win7 {
            background-color: #d6e6ff;
        }
        
        body.dark {
            background-color: #2d2d2d;
            color: #ffffff;
        }
        
        .window {
            border: 2px outset #c0c0c0;
            background-color: #c0c0c0;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }
        
        .winxp .window {
            border: 1px solid #aca899;
            background-color: #ece9d8;
        }
        
        .win7 .window {
            border: 1px solid #a5b4c2;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        
        .dark .window {
            border: 2px outset #555555;
            background-color: #3c3c3c;
            color: #ffffff;
        }
        
        .title-bar {
            background: linear-gradient(90deg, #000080, #1084d0);
            color: white;
            padding: 2px 4px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .winxp .title-bar {
            background: linear-gradient(90deg, #0a246a, #a2b8d0);
        }
        
        .win7 .title-bar {
            background: linear-gradient(90deg, #0050ef, #3a7be0);
            border-radius: 4px 4px 0 0;
        }
        
        .dark .title-bar {
            background: linear-gradient(90deg, #1a1a1a, #404040);
            color: #00ff00;
        }
        
        .title-bar-controls {
            display: flex;
        }
        
        .title-bar-button {
            width: 16px;
            height: 14px;
            background-color: #c0c0c0;
            border: 1px outset #c0c0c0;
            text-align: center;
            font-size: 10px;
            line-height: 12px;
            margin-left: 2px;
            cursor: pointer;
        }
        
        .winxp .title-bar-button {
            background-color: #d4d0c8;
            border: 1px solid #808080;
        }
        
        .win7 .title-bar-button {
            background-color: #e5f3ff;
            border: 1px solid #7a96df;
            border-radius: 3px;
        }
        
        .dark .title-bar-button {
            background-color: #555555;
            border: 1px solid #777777;
            color: #ffffff;
        }
        
        .menu-bar {
            background-color: #c0c0c0;
            border: 1px inset #c0c0c0;
            padding: 2px;
            display: flex;
        }
        
        .winxp .menu-bar {
            background-color: #ece9d8;
            border: none;
        }
        
        .win7 .menu-bar {
            background-color: #f0f0f0;
            border: none;
        }
        
        .dark .menu-bar {
            background-color: #4a4a4a;
            border: 1px inset #666666;
            color: #ffffff;
        }
        
        .menu-item {
            padding: 2px 8px;
            margin-right: 2px;
            position: relative;
            cursor: pointer;
        }
        
        .menu-item:hover {
            background-color: #000080;
            color: white;
        }
        
        .winxp .menu-item:hover {
            background-color: #316ac5;
        }
        
        .win7 .menu-item:hover {
            background-color: #c2d6f0;
            color: black;
        }
        
        .dark .menu-item:hover {
            background-color: #006600;
            color: #00ff00;
        }
        
        .menu-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #c0c0c0;
            border: 2px outset #c0c0c0;
            min-width: 200px;
            z-index: 100;
            display: none;
        }
        
        .winxp .menu-dropdown {
            background-color: #ece9d8;
            border: 1px solid #aca899;
        }
        
        .win7 .menu-dropdown {
            background-color: #f0f0f0;
            border: 1px solid #a5b4c2;
            border-radius: 3px;
        }
        
        .dark .menu-dropdown {
            background-color: #3c3c3c;
            border: 2px outset #555555;
            color: #ffffff;
        }
        
        .menu-dropdown-item {
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .menu-dropdown-item:hover {
            background-color: #000080;
            color: white;
        }
        
        .winxp .menu-dropdown-item:hover {
            background-color: #316ac5;
        }
        
        .win7 .menu-dropdown-item:hover {
            background-color: #c2d6f0;
            color: black;
        }
        
        .dark .menu-dropdown-item:hover {
            background-color: #006600;
            color: #00ff00;
        }
        
        .menu-dropdown-separator {
            height: 1px;
            background-color: #808080;
            margin: 2px 0;
        }
        
        .dark .menu-dropdown-separator {
            background-color: #666666;
        }
        
        .toolbar {
            background-color: #c0c0c0;
            border: 1px inset #c0c0c0;
            padding: 2px;
            display: flex;
            flex-wrap: wrap;
        }
        
        .winxp .toolbar {
            background-color: #ece9d8;
            border: none;
        }
        
        .win7 .toolbar {
            background-color: #f0f0f0;
            border: none;
        }
        
        .dark .toolbar {
            background-color: #4a4a4a;
            border: 1px inset #666666;
        }
        
        .button {
            background-color: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 3px 8px;
            margin-right: 4px;
            font-size: 12px;
            margin-bottom: 2px;
            cursor: pointer;
        }
        
        .button:active {
            border: 2px inset #c0c0c0;
        }
        
        .winxp .button {
            background-color: #ece9d8;
            border: 1px solid #aca899;
        }
        
        .win7 .button {
            background-color: #e1e1e1;
            border: 1px solid #adadad;
            border-radius: 3px;
        }
        
        .dark .button {
            background-color: #555555;
            border: 2px outset #777777;
            color: #ffffff;
        }
        
        .dark .button:active {
            border: 2px inset #777777;
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .search-bar {
            display: flex;
            align-items: center;
            padding: 2px;
            background-color: #c0c0c0;
            border: 1px inset #c0c0c0;
            flex-wrap: wrap;
        }
        
        .winxp .search-bar {
            background-color: #ece9d8;
            border: none;
        }
        
        .win7 .search-bar {
            background-color: #f0f0f0;
            border: none;
        }
        
        .dark .search-bar {
            background-color: #4a4a4a;
            border: 1px inset #666666;
        }
        
        .search-input {
            flex-grow: 1;
            border: 1px inset #c0c0c0;
            padding: 2px;
            background-color: white;
            margin-right: 5px;
            min-width: 150px;
        }
        
        .dark .search-input {
            border: 1px inset #666666;
            background-color: #2d2d2d;
            color: #ffffff;
        }
        
        .search-options {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            margin-left: 10px;
            font-size: 12px;
        }
        
        .dark .checkbox-label {
            color: #ffffff;
        }
        
        .sort-options {
            display: flex;
            align-items: center;
            padding: 2px;
            background-color: #c0c0c0;
            border: 1px inset #c0c0c0;
            flex-wrap: wrap;
        }
        
        .winxp .sort-options {
            background-color: #ece9d8;
            border: none;
        }
        
        .win7 .sort-options {
            background-color: #f0f0f0;
            border: none;
        }
        
        .dark .sort-options {
            background-color: #4a4a4a;
            border: 1px inset #666666;
        }
        
        .sort-select {
            margin-left: 5px;
            border: 1px inset #c0c0c0;
            background-color: white;
            padding: 2px;
        }
        
        .dark .sort-select {
            border: 1px inset #666666;
            background-color: #2d2d2d;
            color: #ffffff;
        }
        
        .address-bar {
            display: flex;
            align-items: center;
            padding: 2px;
            background-color: #c0c0c0;
        }
        
        .winxp .address-bar {
            background-color: #ece9d8;
        }
        
        .win7 .address-bar {
            background-color: #f0f0f0;
        }
        
        .dark .address-bar {
            background-color: #4a4a4a;
        }
        
        .address-input {
            flex-grow: 1;
            border: 1px inset #c0c0c0;
            padding: 2px;
            background-color: white;
        }
        
        .dark .address-input {
            border: 1px inset #666666;
            background-color: #2d2d2d;
            color: #ffffff;
        }
        
        .file-list {
            display: flex;
            flex-wrap: wrap;
        }
        
        .file-item, .folder-item {
            width: 80px;
            margin: 5px;
            text-align: center;
            cursor: pointer;
            padding: 5px;
            position: relative;
        }
        
        .file-item:hover, .folder-item:hover {
            background-color: rgba(0, 0, 128, 0.7);
            color: white;
        }
        
        .winxp .file-item:hover, .winxp .folder-item:hover {
            background-color: rgba(49, 106, 197, 0.7);
        }
        
        .win7 .file-item:hover, .win7 .folder-item:hover {
            background-color: rgba(194, 214, 240, 0.7);
            color: black;
        }
        
        .dark .file-item:hover, .dark .folder-item:hover {
            background-color: rgba(0, 102, 0, 0.7);
            color: #00ff00;
        }
        
        .file-icon, .folder-icon {
            width: 32px;
            height: 32px;
            margin: 0 auto 5px;
            background-size: contain;
            background-repeat: no-repeat;
        }
        
        .folder-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ffcc00"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>');
        }
        
        .dark .folder-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2300ff00"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>');
        }
        
        .file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ffffff"><path d="M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6H6zm7 7V3.5L18.5 9H13z"/></svg>');
        }
        
        .dark .file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2300ff00"><path d="M6 2c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6H6zm7 7V3.5L18.5 9H13z"/></svg>');
        }
        
        .text-file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23008000"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>');
        }
        
        .dark .text-file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2300cc00"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>');
        }
        
        .html-file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ff6600"><path d="M12 17.56l4.07-1.13.55-6.1H9.38L9.2 8.3h7.6l.2-1.99H7l.56 6.01h6.89l-.23 2.58-2.22.6-2.22-.6-.14-1.66h-2l.29 4.19L12 17.56M4.07 3h15.86L18.5 19.2 12 21l-6.5-1.8L4.07 3z"/></svg>');
        }
        
        .dark .html-file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23ff9900"><path d="M12 17.56l4.07-1.13.55-6.1H9.38L9.2 8.3h7.6l.2-1.99H7l.56 6.01h6.89l-.23 2.58-2.22.6-2.22-.6-.14-1.66h-2l.29 4.19L12 17.56M4.07 3h15.86L18.5 19.2 12 21l-6.5-1.8L4.07 3z"/></svg>');
        }
        
        .image-file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23008080"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>');
        }
        
        .dark .image-file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2300cccc"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>');
        }
        
        .audio-file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23800080"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>');
        }
        
        .dark .audio-file-icon {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23cc00cc"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>');
        }
        
        .file-name {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 2px;
            word-break: break-word;
        }
        
        .dark .file-name {
            background-color: rgba(0, 0, 0, 0.8);
            color: #00ff00;
        }
        
        .file-date {
            font-size: 10px;
            color: #ddd;
            margin-top: 2px;
        }
        
        .dark .file-date {
            color: #888888;
        }
        
        .selected {
            background-color: rgba(0, 0, 128, 0.5) !important;
            border: 1px dashed yellow;
        }
        
        .dark .selected {
            background-color: rgba(0, 102, 0, 0.5) !important;
            border: 1px dashed #00ff00;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 0;
            width: 90%;
            max-width: 500px;
        }
        
        .winxp .modal-content {
            background-color: #ece9d8;
            border: 1px solid #aca899;
        }
        
        .win7 .modal-content {
            background-color: #f0f0f0;
            border: 1px solid #a5b4c2;
            border-radius: 5px;
        }
        
        .dark .modal-content {
            background-color: #3c3c3c;
            border: 2px outset #555555;
            color: #ffffff;
        }
        
        .modal-body {
            padding: 10px;
            background-color: white;
        }
        
        .winxp .modal-body, .win7 .modal-body {
            background-color: white;
        }
        
        .dark .modal-body {
            background-color: #2d2d2d;
            color: #ffffff;
        }
        
        .input-field {
            width: 100%;
            padding: 5px;
            margin-bottom: 10px;
            border: 1px inset #c0c0c0;
            background-color: white;
        }
        
        .dark .input-field {
            border: 1px inset #666666;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        .text-editor {
            width: 100%;
            height: 300px;
            border: 1px inset #c0c0c0;
            padding: 5px;
            font-family: monospace;
            background-color: white;
        }
        
        .dark .text-editor {
            border: 1px inset #666666;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            display: block;
            margin: 0 auto;
        }
        
        .audio-player {
            width: 100%;
            margin: 10px 0;
        }
        
        .status-bar {
            background-color: #c0c0c0;
            border: 1px inset #c0c0c0;
            padding: 2px;
            display: flex;
            justify-content: space-between;
        }
        
        .winxp .status-bar {
            background-color: #ece9d8;
            border: none;
        }
        
        .win7 .status-bar {
            background-color: #e1e5ee;
            border: none;
        }
        
        .dark .status-bar {
            background-color: #4a4a4a;
            border: 1px inset #666666;
            color: #ffffff;
        }
        
        .hidden {
            display: none;
        }
        
        .context-menu {
            position: absolute;
            background-color: #c0c0c0;
            border: 2px outset #c0c0c0;
            z-index: 100;
            min-width: 150px;
        }
        
        .winxp .context-menu {
            background-color: #ece9d8;
            border: 1px solid #aca899;
        }
        
        .win7 .context-menu {
            background-color: #f0f0f0;
            border: 1px solid #a5b4c2;
            border-radius: 3px;
        }
        
        .dark .context-menu {
            background-color: #3c3c3c;
            border: 2px outset #555555;
            color: #ffffff;
        }
        
        .context-menu-item {
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .context-menu-item:hover {
            background-color: #000080;
            color: white;
        }
        
        .winxp .context-menu-item:hover {
            background-color: #316ac5;
        }
        
        .win7 .context-menu-item:hover {
            background-color: #c2d6f0;
            color: black;
        }
        
        .dark .context-menu-item:hover {
            background-color: #006600;
            color: #00ff00;
        }
        
        .context-menu-separator {
            height: 1px;
            background-color: #808080;
            margin: 2px 0;
        }
        
        .dark .context-menu-separator {
            background-color: #666666;
        }
        
        .text-documents-list {
            margin-top: 10px;
            border-top: 1px solid #c0c0c0;
            padding-top: 10px;
        }
        
        .dark .text-documents-list {
            border-top: 1px solid #666666;
        }
        
        .text-document-item {
            padding: 5px;
            border: 1px solid #c0c0c0;
            margin-bottom: 5px;
            cursor: pointer;
            position: relative;
        }
        
        .dark .text-document-item {
            border: 1px solid #666666;
        }
        
        .text-document-item:hover {
            background-color: #e0e0e0;
        }
        
        .dark .text-document-item:hover {
            background-color: #4a4a4a;
        }
        
        .text-document-preview {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            max-height: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .dark .text-document-preview {
            color: #888888;
        }
        
        .media-item {
            position: relative;
            margin-bottom: 10px;
            border: 1px solid #c0c0c0;
            padding: 5px;
        }
        
        .dark .media-item {
            border: 1px solid #666666;
        }
        
        .delete-media-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #c0c0c0;
            border: 1px outset #c0c0c0;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 18px;
            cursor: pointer;
        }
        
        .delete-media-btn:hover {
            background-color: #ff0000;
            color: white;
        }
        
        .dark .delete-media-btn {
            background-color: #555555;
            border: 1px outset #777777;
            color: #ffffff;
        }
        
        .delete-text-doc-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: #c0c0c0;
            border: 1px outset #c0c0c0;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 18px;
            cursor: pointer;
        }
        
        .delete-text-doc-btn:hover {
            background-color: #ff0000;
            color: white;
        }
        
        .dark .delete-text-doc-btn {
            background-color: #555555;
            border: 1px outset #777777;
            color: #ffffff;
        }
        
        .image-viewer {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .image-viewer img {
            max-width: 100%;
            max-height: 100%;
        }
        
        .image-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
        }
        
        .image-nav.prev {
            left: 10px;
        }
        
        .image-nav.next {
            right: 10px;
        }
        
        .theme-selector {
            position: absolute;
            top: 30px;
            left: 80px;
            background-color: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 5px;
            z-index: 10;
        }
        
        .winxp .theme-selector {
            background-color: #ece9d8;
            border: 1px solid #aca899;
        }
        
        .win7 .theme-selector {
            background-color: #f0f0f0;
            border: 1px solid #a5b4c2;
            border-radius: 3px;
        }
        
        .dark .theme-selector {
            background-color: #3c3c3c;
            border: 2px outset #555555;
            color: #ffffff;
        }
        
        .theme-option {
            padding: 5px 10px;
            cursor: pointer;
            margin-bottom: 2px;
        }
        
        .theme-option:hover {
            background-color: #000080;
            color: white;
        }
        
        .winxp .theme-option:hover {
            background-color: #316ac5;
        }
        
        .win7 .theme-option:hover {
            background-color: #c2d6f0;
            color: black;
        }
        
        .dark .theme-option:hover {
            background-color: #006600;
            color: #00ff00;
        }
        
        .theme-option.active {
            background-color: #000080;
            color: white;
        }
        
        .winxp .theme-option.active {
            background-color: #316ac5;
        }
        
        .win7 .theme-option.active {
            background-color: #c2d6f0;
            color: black;
        }
        
        .dark .theme-option.active {
            background-color: #006600;
            color: #00ff00;
        }
        
        /* HTML Preview */
        .html-preview-frame {
            width: 100%;
            height: 100%;
            border: none;
            background-color: white;
        }
        
        .html-preview-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        /* Desktop Background Settings */
        .desktop-settings {
            position: absolute;
            top: 30px;
            left: 150px;
            background-color: #c0c0c0;
            border: 2px outset #c0c0c0;
            padding: 5px;
            z-index: 10;
        }
        
        .winxp .desktop-settings {
            background-color: #ece9d8;
            border: 1px solid #aca899;
        }
        
        .win7 .desktop-settings {
            background-color: #f0f0f0;
            border: 1px solid #a5b4c2;
            border-radius: 3px;
        }
        
        .dark .desktop-settings {
            background-color: #3c3c3c;
            border: 2px outset #555555;
            color: #ffffff;
        }
        
        .desktop-option {
            padding: 5px 10px;
            cursor: pointer;
            margin-bottom: 2px;
        }
        
        .desktop-option:hover {
            background-color: #000080;
            color: white;
        }
        
        .winxp .desktop-option:hover {
            background-color: #316ac5;
        }
        
        .win7 .desktop-option:hover {
            background-color: #c2d6f0;
            color: black;
        }
        
        .dark .desktop-option:hover {
            background-color: #006600;
            color: #00ff00;
        }
        
        /* Новые стили для выбора типа файла */
        .file-type-selector {
            margin: 10px 0;
        }
        
        .file-type-option {
            display: inline-block;
            padding: 5px 10px;
            margin-right: 5px;
            border: 1px solid #c0c0c0;
            cursor: pointer;
        }
        
        .file-type-option.selected {
            background-color: #000080;
            color: white;
        }
        
        .winxp .file-type-option.selected {
            background-color: #316ac5;
        }
        
        .win7 .file-type-option.selected {
            background-color: #c2d6f0;
            color: black;
        }
        
        .dark .file-type-option {
            border: 1px solid #666666;
        }
        
        .dark .file-type-option.selected {
            background-color: #006600;
            color: #00ff00;
        }
        
        .file-extension-hint {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .dark .file-extension-hint {
            color: #888888;
        }
        
        .help-content {
            padding: 10px;
            line-height: 1.5;
        }
        
        .help-section {
            margin-bottom: 15px;
        }
        
        .help-section h3 {
            margin-bottom: 5px;
            color: #000080;
        }
        
        .dark .help-section h3 {
            color: #00ff00;
        }
        
        .share-options {
            margin: 10px 0;
        }
        
        .share-option {
            padding: 8px 12px;
            margin: 5px 0;
            border: 1px solid #c0c0c0;
            cursor: pointer;
            background-color: #e0e0e0;
        }
        
        .share-option:hover {
            background-color: #d0d0d0;
        }
        
        .dark .share-option {
            border: 1px solid #666666;
            background-color: #4a4a4a;
        }
        
        .dark .share-option:hover {
            background-color: #555555;
        }
        
        .share-url {
            width: 100%;
            padding: 5px;
            margin: 10px 0;
            border: 1px inset #c0c0c0;
            background-color: white;
        }
        
        .dark .share-url {
            border: 1px inset #666666;
            background-color: #2d2d2d;
            color: #ffffff;
        }
        
        .share-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .dark .share-info {
            color: #888888;
        }

        /* Мобильная адаптация */
        @media (max-width: 768px) {
            .menu-bar {
                flex-wrap: wrap;
            }
            
            .menu-item {
                padding: 4px 6px;
                font-size: 12px;
            }
            
            .toolbar {
                justify-content: center;
            }
            
            .button {
                padding: 4px 6px;
                font-size: 11px;
                margin: 2px;
            }
            
            .search-bar, .sort-options, .address-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .search-input {
                width: 100%;
                margin-bottom: 5px;
            }
            
            .file-item, .folder-item {
                width: 70px;
                margin: 3px;
            }
            
            .file-name {
                font-size: 10px;
            }
            
            .share-options {
                display: flex;
                flex-direction: column;
            }
            
            .share-option {
                padding: 12px;
                margin: 3px 0;
                font-size: 14px;
            }
        }

        /* Улучшенные стили для мобильных устройств */
        @media (max-width: 480px) {
            .menu-item {
                padding: 3px 5px;
                font-size: 11px;
            }
            
            .button {
                padding: 3px 5px;
                font-size: 10px;
                margin: 1px;
            }
            
            .file-item, .folder-item {
                width: 65px;
                margin: 2px;
            }
        }
    </style>
</head>
<body class="win95">
    <div class="window">
        <div class="title-bar">
            <div class="title-bar-text">Файловый менеджер</div>
            <div class="title-bar-controls">
                <button class="title-bar-button">-</button>
                <button class="title-bar-button">□</button>
                <button class="title-bar-button">×</button>
            </div>
        </div>
        <div class="menu-bar">
            <div class="menu-item" id="file-menu">
                Файл
                <div class="menu-dropdown" id="file-dropdown">
                    <div class="menu-dropdown-item" id="menu-new-folder">Новая папка</div>
                    <div class="menu-dropdown-item" id="menu-new-file">Новый файл</div>
                    <div class="menu-dropdown-separator"></div>
                    <div class="menu-dropdown-item" id="menu-save-system">Сохранить файловую систему</div>
                    <div class="menu-dropdown-item" id="menu-load-system">Загрузить файловую систему</div>
                    <div class="menu-dropdown-separator"></div>
                    <div class="menu-dropdown-item" id="menu-export-file">Экспортировать файл</div>
                    <div class="menu-dropdown-item" id="menu-import-file">Импортировать файл</div>
                </div>
            </div>
            <div class="menu-item" id="edit-menu">
                Правка
                <div class="menu-dropdown" id="edit-dropdown">
                    <div class="menu-dropdown-item" id="menu-undo">Отменить</div>
                    <div class="menu-dropdown-item" id="menu-redo">Повторить</div>
                    <div class="menu-dropdown-separator"></div>
                    <div class="menu-dropdown-item" id="menu-select-all">Выделить все</div>
                    <div class="menu-dropdown-separator"></div>
                    <div class="menu-dropdown-item" id="menu-copy">Копировать</div>
                    <div class="menu-dropdown-item" id="menu-cut">Вырезать</div>
                    <div class="menu-dropdown-item" id="menu-paste">Вставить</div>
                </div>
            </div>
            <div class="menu-item" id="view-menu">Вид</div>
            <div class="menu-item" id="desktop-menu">Рабочий стол</div>
            <div class="menu-item" id="help-menu">Справка</div>
        </div>
        <div class="toolbar">
            <button class="button" id="btn-back">Назад</button>
            <button class="button" id="btn-up">Вверх</button>
            <button class="button" id="btn-new-folder">Новая папка</button>
            <button class="button" id="btn-new-file">Новый файл</button>
            <button class="button" id="btn-copy">Копировать</button>
            <button class="button" id="btn-cut">Вырезать</button>
            <button class="button" id="btn-paste">Вставить</button>
            <button class="button" id="btn-undo" disabled>Отменить</button>
            <button class="button" id="btn-redo" disabled>Повторить</button>
            <button class="button" id="btn-save">Сохранить</button>
            <button class="button" id="btn-load">Загрузить</button>
        </div>
        <div class="search-bar">
            <span>Поиск:</span>
            <input type="text" class="search-input" id="search-input" placeholder="Введите название файла или папки">
            <div class="search-options">
                <label class="checkbox-label">
                    <input type="checkbox" id="deep-search"> Расширенный поиск
                </label>
                <button class="button" id="btn-clear-search" style="margin-left: 10px;">Очистить</button>
            </div>
        </div>
        <div class="sort-options">
            <span>Сортировка:</span>
            <select class="sort-select" id="sort-select">
                <option value="name">По названию</option>
                <option value="date">По дате</option>
                <option value="type">По типу</option>
            </select>
            <select class="sort-select" id="sort-order">
                <option value="asc">По возрастанию</option>
                <option value="desc">По убыванию</option>
            </select>
        </div>
        <div class="address-bar">
            <span>Адрес:</span>
            <input type="text" class="address-input" id="current-path" readonly>
        </div>
        <div class="desktop-container">
            <div class="desktop-area" id="desktop-area">
                <!-- Содержимое файлового менеджера -->
            </div>
        </div>
        <div class="status-bar">
            <div class="status-bar-field" id="clipboard-status">Буфер обмена: пуст</div>
            <div class="status-bar-field" id="undo-status">Отмена: недоступно</div>
            <div class="status-bar-field" id="file-count">Файлов: 0</div>
        </div>
    </div>

    <!-- Модальное окно для создания папки -->
    <div class="modal hidden" id="folder-modal">
        <div class="modal-content">
            <div class="title-bar">
                <div class="title-bar-text">Новая папка</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-folder-modal">×</button>
                </div>
            </div>
            <div class="modal-body">
                <p>Введите имя папки:</p>
                <input type="text" class="input-field" id="folder-name" placeholder="Имя папки">
                <div style="text-align: right; margin-top: 10px;">
                    <button class="button" id="cancel-folder">Отмена</button>
                    <button class="button" id="create-folder">Создать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания файла -->
    <div class="modal hidden" id="file-modal">
        <div class="modal-content">
            <div class="title-bar">
                <div class="title-bar-text">Новый файл</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-file-modal">×</button>
                </div>
            </div>
            <div class="modal-body">
                <p>Введите имя файла:</p>
                <input type="text" class="input-field" id="file-name" placeholder="Имя файла">
                <div class="file-type-selector">
                    <p>Выберите тип файла:</p>
                    <div class="file-type-option selected" data-type="txt">Текстовый файл (.txt)</div>
                    <div class="file-type-option" data-type="html">HTML документ (.html)</div>
                </div>
                <div class="file-extension-hint">
                    Расширение файла будет добавлено автоматически
                </div>
                <div style="text-align: right; margin-top: 10px;">
                    <button class="button" id="cancel-file">Отмена</button>
                    <button class="button" id="create-file">Создать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для редактирования файла -->
    <div class="modal hidden" id="editor-modal">
        <div class="modal-content" style="width: 95%; height: 90%;">
            <div class="title-bar">
                <div class="title-bar-text" id="editor-title">Редактор</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-editor-modal">×</button>
                </div>
            </div>
            <div class="toolbar">
                <button class="button" id="btn-save-file">Сохранить</button>
                <button class="button" id="btn-copy-file">Копировать</button>
                <button class="button" id="btn-open-in-editor">Открыть в редакторе</button>
                <button class="button" id="btn-add-image">Добавить изображения</button>
                <button class="button" id="btn-add-audio">Добавить аудио</button>
                <button class="button" id="btn-add-text-doc">Добавить текстовый документ</button>
                <button class="button" id="btn-preview-html" class="hidden">Просмотр HTML</button>
                <button class="button" id="btn-exit-preview" class="hidden">Выйти из просмотра</button>
            </div>
            <div class="modal-body" style="height: calc(100% - 60px); overflow: auto;">
                <textarea class="text-editor" id="file-editor"></textarea>
                <div id="file-content" class="hidden"></div>
                <div id="media-container"></div>
                <div class="text-documents-list" id="text-documents-list"></div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для создания текстового документа -->
    <div class="modal hidden" id="text-doc-modal">
        <div class="modal-content">
            <div class="title-bar">
                <div class="title-bar-text">Новый текстовый документ</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-text-doc-modal">×</button>
                </div>
            </div>
            <div class="modal-body">
                <p>Введите имя документа:</p>
                <input type="text" class="input-field" id="text-doc-name" placeholder="Имя документа">
                <p>Содержимое:</p>
                <textarea class="input-field" id="text-doc-content" placeholder="Введите текст документа" rows="5"></textarea>
                <div style="text-align: right; margin-top: 10px;">
                    <button class="button" id="cancel-text-doc">Отмена</button>
                    <button class="button" id="create-text-doc">Создать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно просмотра изображения -->
    <div class="modal hidden" id="image-viewer-modal">
        <div class="modal-content" style="width: 95%; height: 95%;">
            <div class="title-bar">
                <div class="title-bar-text" id="image-viewer-title">Просмотр изображения</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-image-viewer-modal">×</button>
                </div>
            </div>
            <div class="modal-body" style="height: calc(100% - 30px); padding: 0; position: relative;">
                <div class="image-viewer" id="image-viewer">
                    <button class="image-nav prev" id="prev-image">‹</button>
                    <img id="viewed-image" src="" alt="Просматриваемое изображение">
                    <button class="image-nav next" id="next-image">›</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно просмотра HTML -->
    <div class="modal hidden" id="html-preview-modal">
        <div class="modal-content" style="width: 95%; height: 95%;">
            <div class="title-bar">
                <div class="title-bar-text" id="html-preview-title">Просмотр HTML</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-html-preview-modal">×</button>
                </div>
            </div>
            <div class="toolbar">
                <button class="button" id="btn-refresh-html">Обновить</button>
                <button class="button" id="btn-open-html-external">Открыть в новой вкладке</button>
            </div>
            <div class="modal-body" style="height: calc(100% - 60px); padding: 0;">
                <div class="html-preview-container">
                    <iframe class="html-preview-frame" id="html-preview-frame" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно справки -->
    <div class="modal hidden" id="help-modal">
        <div class="modal-content" style="width: 80%; height: 80%;">
            <div class="title-bar">
                <div class="title-bar-text">Справка - Файловый менеджер</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-help-modal">×</button>
                </div>
            </div>
            <div class="modal-body" style="height: calc(100% - 30px); overflow: auto;">
                <div class="help-content">
                    <div class="help-section">
                        <h3>О программе</h3>
                        <p>Файловый менеджер - это веб-приложение для управления файлами и папками в вашем браузере. 
                        Все данные сохраняются локально в вашем браузере.</p>
                    </div>
                    
                    <div class="help-section">
                        <h3>Основные возможности</h3>
                        <ul>
                            <li><strong>Создание папок и файлов</strong> - используйте кнопки "Новая папка" и "Новый файл"</li>
                            <li><strong>Копирование, вырезание и вставка</strong> - стандартные операции с файлами</li>
                            <li><strong>Отмена и повтор действий</strong> - кнопки "Отменить" и "Повторить" в меню "Правка"</li>
                            <li><strong>Поиск файлов</strong> - поиск по имени с возможностью расширенного поиска во всех папках</li>
                            <li><strong>Сортировка</strong> - по имени, дате или типу файла</li>
                            <li><strong>Редактирование файлов</strong> - встроенный текстовый редактор</li>
                            <li><strong>Просмотр изображений</strong> - встроенный просмотрщик с возможностью перелистывания</li>
                            <li><strong>Просмотр HTML</strong> - предпросмотр HTML файлов</li>
                            <li><strong>Добавление медиа</strong> - возможность добавлять изображения и аудио в файлы</li>
                            <li><strong>Текстовые документы</strong> - создание отдельных текстовых документов внутри файлов</li>
                            <li><strong>Сохранение и загрузка</strong> - возможность сохранить файловую систему и загрузить ее позже</li>
                            <li><strong>Экспорт и импорт</strong> - возможность экспортировать и импортировать отдельные файлы</li>
                            <li><strong>Темы оформления</strong> - 4 различные темы: Windows 95, Windows XP, Windows 7 и Тёмная</li>
                        </ul>
                    </div>
                    
                    <div class="help-section">
                        <h3>Создание файлов</h3>
                        <p>При создании файла выберите тип файла:</p>
                        <ul>
                            <li><strong>Текстовый файл (.txt)</strong> - обычный текстовый файл</li>
                            <li><strong>HTML документ (.html)</strong> - файл с HTML разметкой, который можно просматривать в браузере</li>
                        </ul>
                        <p>Расширение файла добавляется автоматически в зависимости от выбранного типа.</p>
                    </div>
                    
                    <div class="help-section">
                        <h3>Горячие клавиши</h3>
                        <ul>
                            <li><strong>Enter</strong> - создание папки/файла в диалоговых окнах</li>
                            <li><strong>Ctrl+Click</strong> - множественное выделение файлов</li>
                            <li><strong>Правая кнопка мыши</strong> - контекстное меню</li>
                            <li><strong>Ctrl+Z</strong> - отменить последнее действие</li>
                            <li><strong>Ctrl+Y</strong> - повторить отмененное действие</li>
                        </ul>
                    </div>
                    
                    <div class="help-section">
                        <h3>Темы оформления</h3>
                        <p>Вы можете изменить внешний вид файлового менеджера, выбрав одну из четырех тем:</p>
                        <ul>
                            <li><strong>Windows 95</strong> - классический стиль Windows 95</li>
                            <li><strong>Windows XP</strong> - стиль Windows XP</li>
                            <li><strong>Windows 7</strong> - стиль Windows 7</li>
                            <li><strong>Тёмная</strong> - контрастная тёмная тема для комфортной работы в ночное время</li>
                        </ul>
                    </div>
                    
                    <div class="help-section">
                        <h3>Важно</h3>
                        <p>Все данные хранятся локально в вашем браузере. Для сохранения данных на длительный срок используйте функцию "Сохранить" в меню.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для экспорта файла -->
    <div class="modal hidden" id="export-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="title-bar">
                <div class="title-bar-text">Экспорт файла</div>
                <div class="title-bar-controls">
                    <button class="title-bar-button" id="close-export-modal">×</button>
                </div>
            </div>
            <div class="modal-body">
                <p>Выберите файл для экспорта:</p>
                <select class="input-field" id="export-file-select">
                    <!-- Список файлов будет заполнен динамически -->
                </select>
                <div style="text-align: right; margin-top: 10px;">
                    <button class="button" id="cancel-export">Отмена</button>
                    <button class="button" id="export-file">Экспортировать</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Контекстное меню -->
    <div class="context-menu hidden" id="context-menu">
        <div class="context-menu-item" id="context-copy">Копировать</div>
        <div class="context-menu-item" id="context-cut">Вырезать</div>
        <div class="context-menu-item" id="context-paste">Вставить</div>
        <div class="context-menu-item" id="context-rename">Переименовать</div>
        <div class="context-menu-item" id="context-delete">Удалить</div>
        <div class="context-menu-separator"></div>
        <div class="context-menu-item" id="context-export">Экспортировать</div>
    </div>

    <!-- Меню выбора темы -->
    <div class="theme-selector hidden" id="theme-selector">
        <div class="theme-option" data-theme="win95">Windows 95</div>
        <div class="theme-option" data-theme="winxp">Windows XP</div>
        <div class="theme-option" data-theme="win7">Windows 7</div>
        <div class="theme-option" data-theme="dark">Тёмная</div>
    </div>

    <!-- Меню рабочего стола -->
    <div class="desktop-settings hidden" id="desktop-settings">
        <div class="desktop-option" id="set-desktop-bg">Установить фон рабочего стола</div>
        <div class="desktop-option" id="clear-desktop-bg">Убрать фон</div>
    </div>

    <script>
        // Глобальные переменные
        let fileSystem = {
            name: "root",
            type: "folder",
            children: [],
            path: "/"
        };
        
        let currentFolder = fileSystem;
        let selectedItem = null;
        let pathHistory = [];
        let currentHistoryIndex = -1;
        let searchQuery = "";
        let sortBy = "name";
        let sortOrder = "asc";
        let deepSearch = false;
        let currentTheme = "win95";
        let currentImageIndex = 0;
        let currentImages = [];
        let selectedFileType = "txt";
        
        // Система отмены действий
        let actionHistory = [];
        let currentActionIndex = -1;
        const MAX_HISTORY = 50;
        
        // Буфер обмена для операций копирования/вырезания
        let clipboard = {
            items: [],
            operation: null // 'copy' или 'cut'
        };

        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            initializeFileSystem();
            loadTheme();
            loadDesktopBackground();
            renderFileExplorer();
            setupEventListeners();
            updateClipboardStatus();
            updateUndoRedoButtons();
        });

        // Система отмены действий
        function saveAction(action) {
            // Удаляем действия после текущего индекса (если мы отменили некоторые действия)
            if (currentActionIndex < actionHistory.length - 1) {
                actionHistory = actionHistory.slice(0, currentActionIndex + 1);
            }
            
            // Добавляем новое действие
            actionHistory.push({
                type: action.type,
                data: JSON.parse(JSON.stringify(action.data)),
                timestamp: new Date().toISOString()
            });
            
            // Ограничиваем размер истории
            if (actionHistory.length > MAX_HISTORY) {
                actionHistory.shift();
            }
            
            currentActionIndex = actionHistory.length - 1;
            updateUndoRedoButtons();
        }

        function undo() {
            if (currentActionIndex < 0) return;
            
            const action = actionHistory[currentActionIndex];
            
            switch (action.type) {
                case 'create_folder':
                case 'create_file':
                    // Удаляем созданный элемент
                    const createdItem = action.data.item;
                    const parent = findParent(fileSystem, createdItem);
                    if (parent) {
                        const index = parent.children.indexOf(createdItem);
                        if (index !== -1) {
                            parent.children.splice(index, 1);
                        }
                    }
                    break;
                    
                case 'delete_item':
                    // Восстанавливаем удаленный элемент
                    const deletedItem = action.data.item;
                    const deletedParent = findParent(fileSystem, action.data.originalParent);
                    if (deletedParent) {
                        deletedParent.children.push(deletedItem);
                    }
                    break;
                    
                case 'rename_item':
                    // Возвращаем старое имя
                    const renamedItem = action.data.item;
                    renamedItem.name = action.data.oldName;
                    break;
                    
                case 'move_item':
                    // Возвращаем элемент на старое место
                    const movedItem = action.data.item;
                    const newParent = findParent(fileSystem, action.data.newParent);
                    const oldParent = findParent(fileSystem, action.data.oldParent);
                    
                    if (newParent && oldParent) {
                        const index = newParent.children.indexOf(movedItem);
                        if (index !== -1) {
                            newParent.children.splice(index, 1);
                            oldParent.children.push(movedItem);
                        }
                    }
                    break;
            }
            
            currentActionIndex--;
            updateUndoRedoButtons();
            renderFileExplorer();
            autoSave();
        }

        function redo() {
            if (currentActionIndex >= actionHistory.length - 1) return;
            
            currentActionIndex++;
            const action = actionHistory[currentActionIndex];
            
            switch (action.type) {
                case 'create_folder':
                case 'create_file':
                    // Восстанавливаем создание элемента
                    const createdItem = action.data.item;
                    const parent = findParent(fileSystem, action.data.parent);
                    if (parent) {
                        parent.children.push(createdItem);
                    }
                    break;
                    
                case 'delete_item':
                    // Повторяем удаление
                    const deletedItem = action.data.item;
                    const deletedParent = findParent(fileSystem, deletedItem);
                    if (deletedParent) {
                        const index = deletedParent.children.indexOf(deletedItem);
                        if (index !== -1) {
                            deletedParent.children.splice(index, 1);
                        }
                    }
                    break;
                    
                case 'rename_item':
                    // Повторяем переименование
                    const renamedItem = action.data.item;
                    renamedItem.name = action.data.newName;
                    break;
                    
                case 'move_item':
                    // Повторяем перемещение
                    const movedItem = action.data.item;
                    const oldParent = findParent(fileSystem, action.data.oldParent);
                    const newParent = findParent(fileSystem, action.data.newParent);
                    
                    if (oldParent && newParent) {
                        const index = oldParent.children.indexOf(movedItem);
                        if (index !== -1) {
                            oldParent.children.splice(index, 1);
                            newParent.children.push(movedItem);
                        }
                    }
                    break;
            }
            
            updateUndoRedoButtons();
            renderFileExplorer();
            autoSave();
        }

        function updateUndoRedoButtons() {
            const undoBtn = document.getElementById('btn-undo');
            const redoBtn = document.getElementById('btn-redo');
            const undoStatus = document.getElementById('undo-status');
            
            const canUndo = currentActionIndex >= 0;
            const canRedo = currentActionIndex < actionHistory.length - 1;
            
            undoBtn.disabled = !canUndo;
            redoBtn.disabled = !canRedo;
            
            if (canUndo) {
                const lastAction = actionHistory[currentActionIndex];
                undoStatus.textContent = `Отмена: ${getActionDescription(lastAction)}`;
            } else {
                undoStatus.textContent = 'Отмена: недоступно';
            }
        }

        function getActionDescription(action) {
            switch (action.type) {
                case 'create_folder': return 'Создание папки';
                case 'create_file': return 'Создание файла';
                case 'delete_item': return 'Удаление';
                case 'rename_item': return 'Переименование';
                case 'move_item': return 'Перемещение';
                default: return 'Действие';
            }
        }

        // Инициализация файловой системы
        function initializeFileSystem() {
            // Создаем несколько примеров для демонстрации
            const examplesFolder = createFolder("Примеры");
            currentFolder.children.push(examplesFolder);
            
            const textFile = createFile("пример.txt", "text");
            textFile.content = "Это пример текстового файла.\nВы можете редактировать этот текст.";
            examplesFolder.children.push(textFile);
            
            const htmlFile = createFile("пример.html", "html");
            htmlFile.content = `<!DOCTYPE html>
<html>
<head>
    <title>Пример HTML</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        button { padding: 10px; margin: 5px; }
        .container { max-width: 600px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Демонстрация HTML</h1>
        <p>Это пример HTML документа, который можно редактировать и тестировать.</p>
        <button onclick="alert('Привет, мир!')">Нажми меня</button>
        <button onclick="document.getElementById('demo').innerHTML = 'Текст изменен!'">Изменить текст</button>
        <p id="demo">Исходный текст</p>
        <input type="text" id="inputField" placeholder="Введите текст">
        <button onclick="document.getElementById('output').innerHTML = document.getElementById('inputField').value">Показать введенный текст</button>
        <p id="output"></p>
    </div>
</body>
</html>`;
            examplesFolder.children.push(htmlFile);
            
            // Создаем файл справки
            const helpFile = createFile("справка.txt", "text");
            helpFile.content = `ФАЙЛОВЫЙ МЕНЕДЖЕР - СПРАВКА

Основные возможности:
- Создание папок и файлов
- Копирование, вырезание и вставка
- Отмена и повтор действий
- Поиск файлов
- Сортировка по различным параметрам
- Редактирование файлов
- Просмотр изображений и HTML
- Добавление медиафайлов
- Текстовые документы
- Сохранение и загрузка файловой системы
- Экспорт и импорт файлов
- Темы оформления

Для получения подробной информации откройте меню "Справка".`;
            currentFolder.children.push(helpFile);
            
            updateFileCount();
        }

        // Создание объекта папки
        function createFolder(name) {
            return {
                name: name,
                type: "folder",
                children: [],
                path: currentFolder.path + name + "/",
                created: new Date().toLocaleString()
            };
        }

        // Создание объекта файла
        function createFile(name, type) {
            // Добавляем расширение, если его нет
            let fileName = name;
            if (type === "html" && !fileName.endsWith('.html')) {
                fileName += '.html';
            } else if (type === "text" && !fileName.endsWith('.txt')) {
                fileName += '.txt';
            }
            
            return {
                name: fileName,
                type: type,
                content: "",
                path: currentFolder.path + fileName,
                created: new Date().toLocaleString(),
                media: [],
                textDocuments: []
            };
        }

        // Создание объекта текстового документа
        function createTextDocument(name, content = "") {
            return {
                name: name,
                content: content,
                created: new Date().toLocaleString()
            };
        }

        // Отрисовка файлового менеджера
        function renderFileExplorer() {
            const explorer = document.getElementById('desktop-area');
            explorer.innerHTML = '';
            
            // Получаем отфильтрованный и отсортированный список элементов
            let items = getFilteredAndSortedItems();
            
            // Отображаем родительскую папку, если это не корневая
            if (currentFolder !== fileSystem) {
                const parentItem = document.createElement('div');
                parentItem.className = 'folder-item';
                parentItem.innerHTML = `
                    <div class="folder-icon"></div>
                    <div class="file-name">..</div>
                `;
                parentItem.addEventListener('click', function() {
                    navigateToParent();
                });
                explorer.appendChild(parentItem);
            }
            
            // Отображаем папки
            items.filter(item => item.type === 'folder').forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item';
                folderItem.innerHTML = `
                    <div class="folder-icon"></div>
                    <div class="file-name">${folder.name}</div>
                    <div class="file-date">${folder.created}</div>
                `;
                folderItem.addEventListener('click', function(e) {
                    if (e.ctrlKey) {
                        // Выбор нескольких элементов с Ctrl
                        folderItem.classList.toggle('selected');
                    } else {
                        // Одиночный выбор
                        clearSelection();
                        folderItem.classList.add('selected');
                        navigateToFolder(folder);
                    }
                });
                folderItem.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    clearSelection();
                    folderItem.classList.add('selected');
                    showContextMenu(e, folder);
                });
                explorer.appendChild(folderItem);
            });
            
            // Отображаем файлы
            items.filter(item => item.type !== 'folder').forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                
                let iconClass = 'file-icon';
                if (file.name.endsWith('.txt')) {
                    iconClass = 'text-file-icon';
                } else if (file.name.endsWith('.html')) {
                    iconClass = 'html-file-icon';
                } else if (file.name.endsWith('.jpg') || file.name.endsWith('.png') || file.name.endsWith('.gif')) {
                    iconClass = 'image-file-icon';
                } else if (file.name.endsWith('.mp3') || file.name.endsWith('.wav')) {
                    iconClass = 'audio-file-icon';
                }
                
                fileItem.innerHTML = `
                    <div class="${iconClass}"></div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-date">${file.created}</div>
                `;
                fileItem.addEventListener('click', function(e) {
                    if (e.ctrlKey) {
                        // Выбор нескольких элементов с Ctrl
                        fileItem.classList.toggle('selected');
                    } else {
                        // Одиночный выбор
                        clearSelection();
                        fileItem.classList.add('selected');
                        openFile(file);
                    }
                });
                fileItem.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    clearSelection();
                    fileItem.classList.add('selected');
                    showContextMenu(e, file);
                });
                explorer.appendChild(fileItem);
            });
            
            // Обновляем путь в адресной строке
            document.getElementById('current-path').value = currentFolder.path;
            
            updateFileCount();
        }

        // Очистка выделения
        function clearSelection() {
            document.querySelectorAll('.file-item.selected, .folder-item.selected').forEach(item => {
                item.classList.remove('selected');
            });
        }

        // Получение отфильтрованного и отсортированного списка элементов
        function getFilteredAndSortedItems() {
            let items = [];
            
            // Если включен расширенный поиск, ищем во всей файловой системе
            if (deepSearch && searchQuery) {
                items = searchInFileSystem(fileSystem, searchQuery.toLowerCase());
            } else {
                // Иначе работаем только с текущей папкой
                items = [...currentFolder.children];
                
                // Применяем фильтрацию по поисковому запросу
                if (searchQuery) {
                    const query = searchQuery.toLowerCase();
                    items = items.filter(item => 
                        item.name.toLowerCase().includes(query)
                    );
                }
            }
            
            // Применяем сортировку
            items.sort((a, b) => {
                let aValue, bValue;
                
                if (sortBy === 'name') {
                    aValue = a.name.toLowerCase();
                    bValue = b.name.toLowerCase();
                } else if (sortBy === 'date') {
                    aValue = new Date(a.created);
                    bValue = new Date(b.created);
                } else if (sortBy === 'type') {
                    aValue = a.type === 'folder' ? 0 : 1;
                    bValue = b.type === 'folder' ? 0 : 1;
                }
                
                if (aValue < bValue) return sortOrder === 'asc' ? -1 : 1;
                if (aValue > bValue) return sortOrder === 'asc' ? 1 : -1;
                return 0;
            });
            
            return items;
        }

        // Рекурсивный поиск во всей файловой системе
        function searchInFileSystem(folder, query) {
            let results = [];
            
            for (let item of folder.children) {
                if (item.name.toLowerCase().includes(query)) {
                    results.push(item);
                }
                
                if (item.type === 'folder') {
                    results = results.concat(searchInFileSystem(item, query));
                }
            }
            
            return results;
        }

        // Навигация в папку
        function navigateToFolder(folder) {
            pathHistory = pathHistory.slice(0, currentHistoryIndex + 1);
            pathHistory.push(currentFolder);
            currentHistoryIndex++;
            currentFolder = folder;
            renderFileExplorer();
        }

        // Навигация к родительской папке
        function navigateToParent() {
            if (currentFolder === fileSystem) return;
            
            let parent = findParent(fileSystem, currentFolder);
            if (parent) {
                pathHistory = pathHistory.slice(0, currentHistoryIndex + 1);
                pathHistory.push(currentFolder);
                currentHistoryIndex++;
                currentFolder = parent;
                renderFileExplorer();
            }
        }

        // Поиск родительской папки
        function findParent(root, folder) {
            if (root.children.includes(folder)) {
                return root;
            }
            
            for (let child of root.children) {
                if (child.type === 'folder') {
                    const result = findParent(child, folder);
                    if (result) return result;
                }
            }
            
            return null;
        }

        // Копирование элементов
        function copyItems() {
            const selectedItems = document.querySelectorAll('.file-item.selected, .folder-item.selected');
            if (selectedItems.length === 0 && selectedItem) {
                // Если нет выделенных элементов, но есть выбранный элемент
                clipboard.items = [selectedItem];
            } else {
                // Копируем выделенные элементы
                clipboard.items = Array.from(selectedItems).map(item => {
                    const itemName = item.querySelector('.file-name').textContent;
                    if (itemName === '..') return null;
                    
                    return currentFolder.children.find(child => child.name === itemName);
                }).filter(item => item !== null);
            }
            
            clipboard.operation = 'copy';
            updateClipboardStatus();
        }

        // Вырезание элементов
        function cutItems() {
            const selectedItems = document.querySelectorAll('.file-item.selected, .folder-item.selected');
            if (selectedItems.length === 0 && selectedItem) {
                // Если нет выделенных элементов, но есть выбранный элемент
                clipboard.items = [selectedItem];
            } else {
                // Вырезаем выделенные элементы
                clipboard.items = Array.from(selectedItems).map(item => {
                    const itemName = item.querySelector('.file-name').textContent;
                    if (itemName === '..') return null;
                    
                    return currentFolder.children.find(child => child.name === itemName);
                }).filter(item => item !== null);
            }
            
            clipboard.operation = 'cut';
            updateClipboardStatus();
        }

        // Вставка элементов
        function pasteItems() {
            if (clipboard.items.length === 0) return;
            
            // Сохраняем действие в историю
            saveAction({
                type: 'move_item',
                data: {
                    item: clipboard.items[0],
                    oldParent: findParent(fileSystem, clipboard.items[0]),
                    newParent: currentFolder
                }
            });
            
            clipboard.items.forEach(item => {
                if (item) {
                    if (clipboard.operation === 'copy') {
                        // Создаем копию элемента
                        const copiedItem = JSON.parse(JSON.stringify(item));
                        copiedItem.name = findUniqueName(copiedItem.name);
                        currentFolder.children.push(copiedItem);
                    } else if (clipboard.operation === 'cut') {
                        // Перемещаем элемент
                        const originalParent = findParent(fileSystem, item);
                        if (originalParent) {
                            const index = originalParent.children.indexOf(item);
                            if (index !== -1) {
                                originalParent.children.splice(index, 1);
                                
                                // Изменяем имя если нужно
                                item.name = findUniqueName(item.name);
                                currentFolder.children.push(item);
                            }
                        }
                    }
                }
            });
            
            // Очищаем буфер после вставки
            if (clipboard.operation === 'cut') {
                clipboard.items = [];
                clipboard.operation = null;
                updateClipboardStatus();
            }
            
            renderFileExplorer();
            autoSave();
        }

        // Поиск уникального имени
        function findUniqueName(originalName) {
            let name = originalName;
            let counter = 1;
            
            while (currentFolder.children.some(item => item.name === name)) {
                const dotIndex = originalName.lastIndexOf('.');
                if (dotIndex !== -1) {
                    const baseName = originalName.substring(0, dotIndex);
                    const extension = originalName.substring(dotIndex);
                    name = `${baseName} (${counter})${extension}`;
                } else {
                    name = `${originalName} (${counter})`;
                }
                counter++;
            }
            
            return name;
        }

        // Обновление статуса буфера обмена
        function updateClipboardStatus() {
            const statusElement = document.getElementById('clipboard-status');
            if (clipboard.items.length > 0) {
                const itemNames = clipboard.items.map(item => item.name).join(', ');
                statusElement.textContent = `Буфер обмена: ${clipboard.operation === 'copy' ? 'Копирование' : 'Вырезание'} - ${itemNames}`;
            } else {
                statusElement.textContent = 'Буфер обмена: пуст';
            }
        }

        // Открытие файла
        function openFile(file) {
            selectedItem = file;
            const editor = document.getElementById('file-editor');
            const contentView = document.getElementById('file-content');
            const mediaContainer = document.getElementById('media-container');
            const textDocumentsList = document.getElementById('text-documents-list');
            const previewBtn = document.getElementById('btn-preview-html');
            const exitPreviewBtn = document.getElementById('btn-exit-preview');
            
            // Скрываем кнопки просмотра по умолчанию
            previewBtn.classList.add('hidden');
            exitPreviewBtn.classList.add('hidden');
            editor.classList.remove('hidden');
            contentView.classList.add('hidden');
            
            // Очищаем контейнер медиа
            mediaContainer.innerHTML = '';
            textDocumentsList.innerHTML = '';
            
            // Устанавливаем заголовок
            document.getElementById('editor-title').textContent = file.name;
            
            // Загружаем содержимое файла
            editor.value = file.content || '';
            
            // Отображаем медиа-файлы, если они есть
            if (file.media && file.media.length > 0) {
                file.media.forEach((media, index) => {
                    const mediaItem = document.createElement('div');
                    mediaItem.className = 'media-item';
                    
                    if (media.type.startsWith('image/')) {
                        const img = document.createElement('img');
                        img.src = media.data;
                        img.className = 'image-preview';
                        img.addEventListener('click', function() {
                            openImageViewer(file.media, index);
                        });
                        mediaItem.appendChild(img);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-media-btn';
                        deleteBtn.innerHTML = '×';
                        deleteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            deleteMedia(index);
                        });
                        mediaItem.appendChild(deleteBtn);
                    } else if (media.type.startsWith('audio/')) {
                        const audio = document.createElement('audio');
                        audio.controls = true;
                        audio.src = media.data;
                        audio.className = 'audio-player';
                        mediaItem.appendChild(audio);
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-media-btn';
                        deleteBtn.innerHTML = '×';
                        deleteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            deleteMedia(index);
                        });
                        mediaItem.appendChild(deleteBtn);
                    }
                    
                    mediaContainer.appendChild(mediaItem);
                });
            }
            
            // Отображаем текстовые документы, если они есть
            if (file.textDocuments && file.textDocuments.length > 0) {
                const title = document.createElement('h4');
                title.textContent = 'Текстовые документы:';
                textDocumentsList.appendChild(title);
                
                file.textDocuments.forEach((doc, index) => {
                    const docItem = document.createElement('div');
                    docItem.className = 'text-document-item';
                    docItem.innerHTML = `
                        <div><strong>${doc.name}</strong></div>
                        <div class="file-date">Создан: ${doc.created}</div>
                        <div class="text-document-preview">${doc.content || '(пустой документ)'}</div>
                    `;
                    docItem.addEventListener('click', function() {
                        openTextDocument(doc, index);
                    });
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-text-doc-btn';
                    deleteBtn.innerHTML = '×';
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        deleteTextDocument(index);
                    });
                    docItem.appendChild(deleteBtn);
                    
                    textDocumentsList.appendChild(docItem);
                });
            }
            
            // Показываем кнопку предпросмотра для HTML файлов
            if (file.name.endsWith('.html')) {
                previewBtn.classList.remove('hidden');
            }
            
            // Показываем модальное окно редактора
            document.getElementById('editor-modal').classList.remove('hidden');
        }

        // Удаление медиа-файла
        function deleteMedia(index) {
            if (selectedItem && selectedItem.media) {
                selectedItem.media.splice(index, 1);
                openFile(selectedItem); // Перезагружаем отображение
                autoSave();
            }
        }

        // Удаление текстового документа
        function deleteTextDocument(index) {
            if (selectedItem && selectedItem.textDocuments) {
                selectedItem.textDocuments.splice(index, 1);
                openFile(selectedItem); // Перезагружаем отображение
                autoSave();
            }
        }

        // Открытие текстового документа
        function openTextDocument(doc, index) {
            const content = prompt(`Содержимое документа "${doc.name}":`, doc.content);
            if (content !== null) {
                doc.content = content;
                autoSave();
                // Обновляем предпросмотр
                const docItems = document.querySelectorAll('.text-document-item');
                if (docItems[index]) {
                    const preview = docItems[index].querySelector('.text-document-preview');
                    if (preview) {
                        preview.textContent = content || '(пустой документ)';
                    }
                }
            }
        }

        // Открытие просмотрщика изображений
        function openImageViewer(images, startIndex) {
            currentImages = images.filter(img => img.type.startsWith('image/'));
            currentImageIndex = startIndex;
            
            if (currentImages.length === 0) return;
            
            const imageViewerModal = document.getElementById('image-viewer-modal');
            const viewedImage = document.getElementById('viewed-image');
            
            viewedImage.src = currentImages[currentImageIndex].data;
            document.getElementById('image-viewer-title').textContent = `Изображение ${currentImageIndex + 1} из ${currentImages.length}`;
            
            imageViewerModal.classList.remove('hidden');
            
            // Добавляем обработчики для перелистывания
            document.getElementById('prev-image').addEventListener('click', showPrevImage);
            document.getElementById('next-image').addEventListener('click', showNextImage);
            
            // Добавляем обработчики для свайпов
            let startX = 0;
            viewedImage.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
            });
            
            viewedImage.addEventListener('touchend', function(e) {
                if (!startX) return;
                
                const endX = e.changedTouches[0].clientX;
                const diffX = startX - endX;
                
                if (Math.abs(diffX) > 50) { // Минимальное расстояние для свайпа
                    if (diffX > 0) {
                        showNextImage();
                    } else {
                        showPrevImage();
                    }
                }
                
                startX = 0;
            });
        }

        // Показать предыдущее изображение
        function showPrevImage() {
            if (currentImages.length === 0) return;
            
            currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
            document.getElementById('viewed-image').src = currentImages[currentImageIndex].data;
            document.getElementById('image-viewer-title').textContent = `Изображение ${currentImageIndex + 1} из ${currentImages.length}`;
        }

        // Показать следующее изображение
        function showNextImage() {
            if (currentImages.length === 0) return;
            
            currentImageIndex = (currentImageIndex + 1) % currentImages.length;
            document.getElementById('viewed-image').src = currentImages[currentImageIndex].data;
            document.getElementById('image-viewer-title').textContent = `Изображение ${currentImageIndex + 1} из ${currentImages.length}`;
        }

        // Открытие HTML в полнофункциональном просмотрщике
        function openHtmlPreview() {
            if (!selectedItem) return;
            
            const htmlPreviewModal = document.getElementById('html-preview-modal');
            const htmlPreviewFrame = document.getElementById('html-preview-frame');
            
            document.getElementById('html-preview-title').textContent = `Просмотр: ${selectedItem.name}`;
            
            // Создаем Blob из HTML содержимого
            const blob = new Blob([selectedItem.content], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            
            htmlPreviewFrame.src = url;
            htmlPreviewModal.classList.remove('hidden');
        }

        // Обновление HTML просмотра
        function refreshHtmlPreview() {
            const htmlPreviewFrame = document.getElementById('html-preview-frame');
            if (selectedItem) {
                const blob = new Blob([selectedItem.content], {type: 'text/html'});
                const url = URL.createObjectURL(blob);
                htmlPreviewFrame.src = url;
            }
        }

        // Открытие HTML во внешней вкладке
        function openHtmlExternal() {
            if (selectedItem) {
                const blob = new Blob([selectedItem.content], {type: 'text/html'});
                const url = URL.createObjectURL(blob);
                window.open(url, '_blank');
            }
        }

        // Функции для экспорта/импорта файлов
        function exportFile() {
            const fileSelect = document.getElementById('export-file-select');
            fileSelect.innerHTML = '';
            
            // Заполняем список файлов
            function addFilesFromFolder(folder, prefix = '') {
                folder.children.forEach(item => {
                    if (item.type === 'folder') {
                        addFilesFromFolder(item, prefix + item.name + '/');
                    } else {
                        const option = document.createElement('option');
                        option.value = JSON.stringify({path: item.path, name: item.name});
                        option.textContent = prefix + item.name;
                        fileSelect.appendChild(option);
                    }
                });
            }
            
            addFilesFromFolder(fileSystem);
            
            document.getElementById('export-modal').classList.remove('hidden');
        }

        function performExport() {
            const fileSelect = document.getElementById('export-file-select');
            const selectedValue = fileSelect.value;
            
            if (!selectedValue) {
                alert('Выберите файл для экспорта');
                return;
            }
            
            try {
                const fileInfo = JSON.parse(selectedValue);
                const file = findFileByPath(fileInfo.path);
                
                if (file) {
                    const blob = new Blob([file.content], {type: 'text/plain'});
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = file.name;
                    link.click();
                    URL.revokeObjectURL(url);
                    
                    document.getElementById('export-modal').classList.add('hidden');
                    alert(`Файл "${file.name}" успешно экспортирован!`);
                }
            } catch (error) {
                alert('Ошибка при экспорте файла: ' + error.message);
            }
        }

        function importFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.txt,.html,.json';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const content = e.target.result;
                        const fileName = file.name;
                        const fileType = fileName.endsWith('.html') ? 'html' : 'text';
                        
                        const newFile = createFile(fileName, fileType);
                        newFile.content = content;
                        currentFolder.children.push(newFile);
                        
                        // Сохраняем действие в историю
                        saveAction({
                            type: 'create_file',
                            data: {
                                item: newFile,
                                parent: currentFolder
                            }
                        });
                        
                        renderFileExplorer();
                        alert(`Файл "${fileName}" успешно импортирован!`);
                    } catch (error) {
                        alert('Ошибка при импорте файла: ' + error.message);
                    }
                };
                reader.readAsText(file);
            });
            
            input.click();
        }

        function findFileByPath(path) {
            function searchInFolder(folder, targetPath) {
                for (let item of folder.children) {
                    if (item.path === targetPath) {
                        return item;
                    }
                    if (item.type === 'folder') {
                        const result = searchInFolder(item, targetPath);
                        if (result) return result;
                    }
                }
                return null;
            }
            
            return searchInFolder(fileSystem, path);
        }

        // Обновленные функции для работы с историей действий
        function createNewFolder(name) {
            const newFolder = createFolder(name);
            currentFolder.children.push(newFolder);
            
            // Сохраняем действие в историю
            saveAction({
                type: 'create_folder',
                data: {
                    item: newFolder,
                    parent: currentFolder
                }
            });
            
            renderFileExplorer();
            return newFolder;
        }

        function createNewFile(name, type) {
            const newFile = createFile(name, type);
            currentFolder.children.push(newFile);
            
            // Сохраняем действие в историю
            saveAction({
                type: 'create_file',
                data: {
                    item: newFile,
                    parent: currentFolder
                }
            });
            
            renderFileExplorer();
            return newFile;
        }

        function deleteSelectedItem() {
            if (!selectedItem) return;
            
            const parent = findParent(fileSystem, selectedItem);
            if (parent) {
                const index = parent.children.indexOf(selectedItem);
                if (index !== -1) {
                    // Сохраняем действие в историю
                    saveAction({
                        type: 'delete_item',
                        data: {
                            item: selectedItem,
                            originalParent: parent
                        }
                    });
                    
                    parent.children.splice(index, 1);
                    renderFileExplorer();
                }
            }
        }

        function renameSelectedItem(newName) {
            if (!selectedItem) return;
            
            const oldName = selectedItem.name;
            selectedItem.name = newName.trim();
            
            // Сохраняем действие в историю
            saveAction({
                type: 'rename_item',
                data: {
                    item: selectedItem,
                    oldName: oldName,
                    newName: newName.trim()
                }
            });
            
            renderFileExplorer();
        }

        // Установка фона рабочего стола
        function setDesktopBackground() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const desktopArea = document.getElementById('desktop-area');
                    desktopArea.style.backgroundImage = `url(${e.target.result})`;
                    
                    // Сохраняем фон в localStorage
                    localStorage.setItem('fileManagerDesktopBg', e.target.result);
                };
                reader.readAsDataURL(file);
            });
            
            input.click();
        }

        // Очистка фона рабочего стола
        function clearDesktopBackground() {
            const desktopArea = document.getElementById('desktop-area');
            desktopArea.style.backgroundImage = 'none';
            localStorage.removeItem('fileManagerDesktopBg');
        }

        // Загрузка фона рабочего стола
        function loadDesktopBackground() {
            const savedBg = localStorage.getItem('fileManagerDesktopBg');
            if (savedBg) {
                const desktopArea = document.getElementById('desktop-area');
                desktopArea.style.backgroundImage = `url(${savedBg})`;
            }
        }

        // Открытие в редакторе
        function openInEditor() {
            if (selectedItem) {
                // Копируем содержимое файла в буфер обмена
                const editor = document.getElementById('file-editor');
                editor.select();
                document.execCommand('copy');
                
                // Открываем редактор в новой вкладке
                window.open('https://2d3t.github.io/index.html/pro/redactor.html', '_blank');
            }
        }

        // Показать контекстное меню
        function showContextMenu(e, item) {
            selectedItem = item;
            
            const contextMenu = document.getElementById('context-menu');
            contextMenu.style.left = e.pageX + 'px';
            contextMenu.style.top = e.pageY + 'px';
            contextMenu.classList.remove('hidden');
            
            // Закрываем контекстное меню при клике вне его
            document.addEventListener('click', closeContextMenu);
        }

        // Закрыть контекстное меню
        function closeContextMenu() {
            document.getElementById('context-menu').classList.add('hidden');
            document.removeEventListener('click', closeContextMenu);
        }

        // Переименование элемента
        function renameItem() {
            if (!selectedItem) return;
            
            const newName = prompt('Введите новое имя:', selectedItem.name);
            if (newName && newName.trim() !== '') {
                renameSelectedItem(newName);
            }
            
            closeContextMenu();
        }

        // Удаление элемента
        function deleteItem() {
            if (!selectedItem) return;
            
            if (confirm(`Вы уверены, что хотите удалить "${selectedItem.name}"?`)) {
                deleteSelectedItem();
            }
            
            closeContextMenu();
        }

        // Обновление счетчика файлов
        function updateFileCount() {
            const fileCount = currentFolder.children.filter(item => item.type !== 'folder').length;
            const folderCount = currentFolder.children.filter(item => item.type === 'folder').length;
            document.getElementById('file-count').textContent = `Папок: ${folderCount}, Файлов: ${fileCount}`;
        }

        // Сохранение файловой системы
        function saveFileSystem() {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const fileName = `${timestamp}.db`;
            
            const dataStr = JSON.stringify(fileSystem);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = fileName;
            link.click();
            
            URL.revokeObjectURL(link.href);
        }

        // Загрузка файловой системы
        function loadFileSystem() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.db';
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        fileSystem = data;
                        currentFolder = fileSystem;
                        pathHistory = [];
                        currentHistoryIndex = -1;
                        actionHistory = [];
                        currentActionIndex = -1;
                        renderFileExplorer();
                        updateUndoRedoButtons();
                        alert('Файловая система загружена успешно!');
                    } catch (error) {
                        alert('Ошибка при загрузке файловой системы: ' + error.message);
                    }
                };
                reader.readAsText(file);
            });
            
            input.click();
        }

        // Автосохранение при выходе
        function autoSave() {
            localStorage.setItem('fileManagerAutoSave', JSON.stringify(fileSystem));
        }

        // Загрузка автосохранения
        function loadAutoSave() {
            const saved = localStorage.getItem('fileManagerAutoSave');
            if (saved) {
                try {
                    fileSystem = JSON.parse(saved);
                    currentFolder = fileSystem;
                    renderFileExplorer();
                } catch (error) {
                    console.error('Ошибка при загрузке автосохранения:', error);
                }
            }
        }

        // Сохранение темы
        function saveTheme() {
            localStorage.setItem('fileManagerTheme', currentTheme);
        }

        // Загрузка темы
        function loadTheme() {
            const savedTheme = localStorage.getItem('fileManagerTheme');
            if (savedTheme) {
                setTheme(savedTheme);
            }
        }

        // Установка темы
        function setTheme(theme) {
            currentTheme = theme;
            document.body.className = theme;
            saveTheme();
            
            // Обновляем активную тему в меню
            const themeOptions = document.querySelectorAll('.theme-option');
            themeOptions.forEach(option => {
                if (option.dataset.theme === theme) {
                    option.classList.add('active');
                } else {
                    option.classList.remove('active');
                }
            });
        }

        // Выбор типа файла
        function selectFileType(type) {
            selectedFileType = type;
            
            // Обновляем визуальное выделение
            document.querySelectorAll('.file-type-option').forEach(option => {
                if (option.dataset.type === type) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            });
        }

        // Открытие справки
        function openHelp() {
            document.getElementById('help-modal').classList.remove('hidden');
        }

        function selectAll() {
            const items = document.querySelectorAll('.file-item, .folder-item');
            items.forEach(item => {
                if (!item.querySelector('.file-name').textContent === '..') {
                    item.classList.add('selected');
                }
            });
        }

        // Настройка обработчиков событий
        function setupEventListeners() {
            // Глобальные горячие клавиши
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey) {
                    switch (e.key) {
                        case 'z':
                            e.preventDefault();
                            undo();
                            break;
                        case 'y':
                            e.preventDefault();
                            redo();
                            break;
                        case 'a':
                            e.preventDefault();
                            selectAll();
                            break;
                    }
                }
            });

            // Меню "Файл"
            document.getElementById('file-menu').addEventListener('click', function(e) {
                const dropdown = document.getElementById('file-dropdown');
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                e.stopPropagation();
            });

            // Меню "Правка"
            document.getElementById('edit-menu').addEventListener('click', function(e) {
                const dropdown = document.getElementById('edit-dropdown');
                dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
                e.stopPropagation();
            });

            // Закрытие dropdown при клике вне его
            document.addEventListener('click', function() {
                document.getElementById('file-dropdown').style.display = 'none';
                document.getElementById('edit-dropdown').style.display = 'none';
                document.getElementById('theme-selector').classList.add('hidden');
                document.getElementById('desktop-settings').classList.add('hidden');
            });

            // Пункты меню "Правка"
            document.getElementById('menu-undo').addEventListener('click', undo);
            document.getElementById('menu-redo').addEventListener('click', redo);
            document.getElementById('menu-select-all').addEventListener('click', selectAll);
            document.getElementById('menu-copy').addEventListener('click', copyItems);
            document.getElementById('menu-cut').addEventListener('click', cutItems);
            document.getElementById('menu-paste').addEventListener('click', pasteItems);

            // Пункты меню "Файл"
            document.getElementById('menu-new-folder').addEventListener('click', function() {
                document.getElementById('folder-modal').classList.remove('hidden');
                document.getElementById('folder-name').focus();
            });
            
            document.getElementById('menu-new-file').addEventListener('click', function() {
                document.getElementById('file-modal').classList.remove('hidden');
                document.getElementById('file-name').focus();
            });
            
            document.getElementById('menu-save-system').addEventListener('click', saveFileSystem);
            document.getElementById('menu-load-system').addEventListener('click', loadFileSystem);
            document.getElementById('menu-export-file').addEventListener('click', exportFile);
            document.getElementById('menu-import-file').addEventListener('click', importFile);

            // Кнопки отмены/повтора
            document.getElementById('btn-undo').addEventListener('click', undo);
            document.getElementById('btn-redo').addEventListener('click', redo);

            // Обработчики для модального окна экспорта
            document.getElementById('close-export-modal').addEventListener('click', function() {
                document.getElementById('export-modal').classList.add('hidden');
            });
            
            document.getElementById('cancel-export').addEventListener('click', function() {
                document.getElementById('export-modal').classList.add('hidden');
            });
            
            document.getElementById('export-file').addEventListener('click', performExport);

            // Контекстное меню - экспорт
            document.getElementById('context-export').addEventListener('click', function() {
                if (selectedItem && selectedItem.type !== 'folder') {
                    // Экспорт выбранного файла
                    const blob = new Blob([selectedItem.content], {type: 'text/plain'});
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = selectedItem.name;
                    link.click();
                    URL.revokeObjectURL(url);
                }
                closeContextMenu();
            });

            // Кнопки навигации
            document.getElementById('btn-back').addEventListener('click', function() {
                if (currentHistoryIndex > 0) {
                    currentHistoryIndex--;
                    currentFolder = pathHistory[currentHistoryIndex];
                    pathHistory = pathHistory.slice(0, currentHistoryIndex + 1);
                    renderFileExplorer();
                }
            });
            
            document.getElementById('btn-up').addEventListener('click', navigateToParent);
            
            // Кнопки создания
            document.getElementById('btn-new-folder').addEventListener('click', function() {
                document.getElementById('folder-modal').classList.remove('hidden');
                document.getElementById('folder-name').focus();
            });
            
            document.getElementById('btn-new-file').addEventListener('click', function() {
                document.getElementById('file-modal').classList.remove('hidden');
                document.getElementById('file-name').focus();
            });
            
            // Кнопки операций с файлами
            document.getElementById('btn-copy').addEventListener('click', copyItems);
            document.getElementById('btn-cut').addEventListener('click', cutItems);
            document.getElementById('btn-paste').addEventListener('click', pasteItems);
            
            // Кнопки сохранения/загрузки
            document.getElementById('btn-save').addEventListener('click', saveFileSystem);
            document.getElementById('btn-load').addEventListener('click', loadFileSystem);
            
            // Поиск
            document.getElementById('search-input').addEventListener('input', function(e) {
                searchQuery = e.target.value;
                renderFileExplorer();
            });
            
            document.getElementById('btn-clear-search').addEventListener('click', function() {
                document.getElementById('search-input').value = '';
                searchQuery = '';
                renderFileExplorer();
            });
            
            document.getElementById('deep-search').addEventListener('change', function(e) {
                deepSearch = e.target.checked;
                if (searchQuery) {
                    renderFileExplorer();
                }
            });
            
            // Сортировка
            document.getElementById('sort-select').addEventListener('change', function(e) {
                sortBy = e.target.value;
                renderFileExplorer();
            });
            
            document.getElementById('sort-order').addEventListener('change', function(e) {
                sortOrder = e.target.value;
                renderFileExplorer();
            });
            
            // Меню вида (темы)
            document.getElementById('view-menu').addEventListener('click', function(e) {
                const themeSelector = document.getElementById('theme-selector');
                themeSelector.classList.toggle('hidden');
                e.stopPropagation();
            });
            
            // Меню рабочего стола
            document.getElementById('desktop-menu').addEventListener('click', function(e) {
                const desktopSettings = document.getElementById('desktop-settings');
                desktopSettings.classList.toggle('hidden');
                e.stopPropagation();
            });
            
            // Меню справки
            document.getElementById('help-menu').addEventListener('click', openHelp);
            
            // Выбор темы
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    setTheme(this.dataset.theme);
                    document.getElementById('theme-selector').classList.add('hidden');
                });
            });
            
            // Настройки рабочего стола
            document.getElementById('set-desktop-bg').addEventListener('click', setDesktopBackground);
            document.getElementById('clear-desktop-bg').addEventListener('click', clearDesktopBackground);
            
            // Выбор типа файла
            document.querySelectorAll('.file-type-option').forEach(option => {
                option.addEventListener('click', function() {
                    selectFileType(this.dataset.type);
                });
            });
            
            // Модальное окно папки
            document.getElementById('close-folder-modal').addEventListener('click', function() {
                document.getElementById('folder-modal').classList.add('hidden');
            });
            
            document.getElementById('cancel-folder').addEventListener('click', function() {
                document.getElementById('folder-modal').classList.add('hidden');
            });
            
            document.getElementById('create-folder').addEventListener('click', function() {
                const folderName = document.getElementById('folder-name').value.trim();
                if (folderName) {
                    createNewFolder(folderName);
                    document.getElementById('folder-modal').classList.add('hidden');
                    document.getElementById('folder-name').value = '';
                }
            });
            
            // Обработка нажатия Enter в поле ввода имени папки
            document.getElementById('folder-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('create-folder').click();
                }
            });
            
            // Модальное окно файла
            document.getElementById('close-file-modal').addEventListener('click', function() {
                document.getElementById('file-modal').classList.add('hidden');
            });
            
            document.getElementById('cancel-file').addEventListener('click', function() {
                document.getElementById('file-modal').classList.add('hidden');
            });
            
            document.getElementById('create-file').addEventListener('click', function() {
                const fileName = document.getElementById('file-name').value.trim();
                if (fileName) {
                    createNewFile(fileName, selectedFileType);
                    document.getElementById('file-modal').classList.add('hidden');
                    document.getElementById('file-name').value = '';
                }
            });
            
            // Обработка нажатия Enter в поле ввода имени файла
            document.getElementById('file-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('create-file').click();
                }
            });
            
            // Модальное окно редактора
            document.getElementById('close-editor-modal').addEventListener('click', function() {
                document.getElementById('editor-modal').classList.add('hidden');
                if (selectedItem) {
                    selectedItem.content = document.getElementById('file-editor').value;
                    autoSave();
                }
            });
            
            document.getElementById('btn-save-file').addEventListener('click', function() {
                if (selectedItem) {
                    selectedItem.content = document.getElementById('file-editor').value;
                    autoSave();
                    alert('Файл сохранен!');
                }
            });
            
            document.getElementById('btn-copy-file').addEventListener('click', function() {
                const editor = document.getElementById('file-editor');
                editor.select();
                document.execCommand('copy');
                alert('Содержимое скопировано в буфер обмена!');
            });
            
            document.getElementById('btn-open-in-editor').addEventListener('click', openInEditor);
            
            document.getElementById('btn-add-image').addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.multiple = true;
                
                input.addEventListener('change', function(e) {
                    const files = e.target.files;
                    if (!files || files.length === 0) return;
                    
                    let loadedCount = 0;
                    
                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            if (selectedItem) {
                                if (!selectedItem.media) selectedItem.media = [];
                                selectedItem.media.push({
                                    type: file.type,
                                    data: e.target.result
                                });
                                
                                loadedCount++;
                                
                                if (loadedCount === files.length) {
                                    openFile(selectedItem);
                                }
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                input.click();
            });
            
            document.getElementById('btn-add-audio').addEventListener('click', function() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'audio/*';
                
                input.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        if (selectedItem) {
                            if (!selectedItem.media) selectedItem.media = [];
                            selectedItem.media.push({
                                type: file.type,
                                data: e.target.result
                            });
                            
                            openFile(selectedItem);
                        }
                    };
                    reader.readAsDataURL(file);
                });
                
                input.click();
            });
            
            document.getElementById('btn-add-text-doc').addEventListener('click', function() {
                document.getElementById('text-doc-modal').classList.remove('hidden');
                document.getElementById('text-doc-name').focus();
            });
            
            document.getElementById('btn-preview-html').addEventListener('click', openHtmlPreview);
            
            document.getElementById('btn-exit-preview').addEventListener('click', function() {
                const editor = document.getElementById('file-editor');
                const contentView = document.getElementById('file-content');
                const previewBtn = document.getElementById('btn-preview-html');
                const exitPreviewBtn = document.getElementById('btn-exit-preview');
                
                editor.classList.remove('hidden');
                contentView.classList.add('hidden');
                previewBtn.classList.remove('hidden');
                exitPreviewBtn.classList.add('hidden');
            });
            
            // Модальное окно текстового документа
            document.getElementById('close-text-doc-modal').addEventListener('click', function() {
                document.getElementById('text-doc-modal').classList.add('hidden');
            });
            
            document.getElementById('cancel-text-doc').addEventListener('click', function() {
                document.getElementById('text-doc-modal').classList.add('hidden');
            });
            
            document.getElementById('create-text-doc').addEventListener('click', function() {
                const docName = document.getElementById('text-doc-name').value.trim();
                const docContent = document.getElementById('text-doc-content').value;
                
                if (docName && selectedItem) {
                    if (!selectedItem.textDocuments) selectedItem.textDocuments = [];
                    const newDoc = createTextDocument(docName, docContent);
                    selectedItem.textDocuments.push(newDoc);
                    
                    openFile(selectedItem);
                    
                    document.getElementById('text-doc-modal').classList.add('hidden');
                    document.getElementById('text-doc-name').value = '';
                    document.getElementById('text-doc-content').value = '';
                }
            });
            
            // Обработка нажатия Enter в поле ввода имени текстового документа
            document.getElementById('text-doc-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('create-text-doc').click();
                }
            });
            
            // Модальное окно просмотра изображений
            document.getElementById('close-image-viewer-modal').addEventListener('click', function() {
                document.getElementById('image-viewer-modal').classList.add('hidden');
            });
            
            // Модальное окно просмотра HTML
            document.getElementById('close-html-preview-modal').addEventListener('click', function() {
                document.getElementById('html-preview-modal').classList.add('hidden');
            });
            
            document.getElementById('btn-refresh-html').addEventListener('click', refreshHtmlPreview);
            
            document.getElementById('btn-open-html-external').addEventListener('click', openHtmlExternal);
            
            // Модальное окно справки
            document.getElementById('close-help-modal').addEventListener('click', function() {
                document.getElementById('help-modal').classList.add('hidden');
            });
            
            // Контекстное меню
            document.getElementById('context-copy').addEventListener('click', copyItems);
            document.getElementById('context-cut').addEventListener('click', cutItems);
            document.getElementById('context-paste').addEventListener('click', pasteItems);
            document.getElementById('context-rename').addEventListener('click', renameItem);
            document.getElementById('context-delete').addEventListener('click', deleteItem);
            document.getElementById('context-export').addEventListener('click', function() {
                if (selectedItem && selectedItem.type !== 'folder') {
                    const blob = new Blob([selectedItem.content], {type: 'text/plain'});
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = selectedItem.name;
                    link.click();
                    URL.revokeObjectURL(url);
                }
                closeContextMenu();
            });
            
            // Автосохранение при закрытии страницы
            window.addEventListener('beforeunload', autoSave);
            
            // Загрузка автосохранения при запуске
            loadAutoSave();
        }
    </script>
</body>
</html>