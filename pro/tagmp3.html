<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–≥–æ–≤ MP3 ‚Äî —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes pulse-text { 0%{opacity:1}50%{opacity:.4}100%{opacity:1} }
    .pulse-text { animation: pulse-text 1.2s infinite; }
  </style>
</head>
<body class="bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center min-h-screen p-4">
  <div class="w-full max-w-lg bg-white rounded-2xl shadow-lg p-8 space-y-6 relative">
    <h1 class="text-3xl font-bold text-center text-indigo-600">üéµ –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–≥–æ–≤ MP3</h1>

    <div>
      <label class="block text-sm font-medium text-gray-700">–í—ã–±–µ—Ä–∏—Ç–µ MP3</label>
      <input type="file" id="fileInput" accept="audio/mpeg" class="mt-1 block w-full text-sm text-gray-600 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input type="text" id="title" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
      <input type="text" id="artist" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">–ê–ª—å–±–æ–º</label>
      <input type="text" id="album" class="w-full mt-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400" />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">–û–±–ª–æ–∂–∫–∞</label>
      <input type="file" id="coverInput" accept="image/*" class="mt-1 block w-full text-sm text-gray-600 border border-gray-300 rounded-lg" />
      <img id="coverPreview" class="mt-3 rounded-lg shadow max-h-40 mx-auto hidden" />
    </div>

    <button id="saveBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-indigo-700 transition disabled:opacity-50" disabled>
      üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π MP3
    </button>

<button onclick="window.location.href='https://2d3t.github.io/index.html/'">–í—ã—Ö–æ–¥</button>

<button onclick="window.location.href='https://2d3t.github.io/index.html/pro/tagmp3img.html'">–°–∫–∞—á–∞—Ç—å –æ–±–ª–æ–∂–∫—É –ø–µ—Å–Ω–∏</button>

    <div id="loader" class="absolute inset-0 bg-white/90 flex flex-col items-center justify-center hidden rounded-2xl">
      <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div>
      <p id="loaderText" class="mt-3 text-indigo-700 font-semibold pulse-text">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
  </div>

  <script>
    (async () => {
      let ID3WriterCtor = null;

      async function tryLoadESM() {
        try {
          const mod = await import('https://unpkg.com/browser-id3-writer@6.3.1/dist/browser-id3-writer.mjs');
          ID3WriterCtor = mod.ID3Writer;
          console.log('Loaded browser-id3-writer (ESM) OK');
        } catch (err) {
          console.warn('ESM import failed:', err);
          throw err;
        }
      }

      async function tryLoadUMDfallback() {
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = 'https://unpkg.com/browser-id3-writer@5.0.0/dist/browser-id3-writer.umd.js';
          s.crossOrigin = 'anonymous';
          s.onload = () => {
            ID3WriterCtor = window.ID3Writer || window.browserId3Writer || null;
            console.log('Loaded browser-id3-writer UMD fallback:', !!ID3WriterCtor);
            resolve();
          };
          s.onerror = () => reject(new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å UMD fallback'));
          document.head.appendChild(s);
        });
      }

      try {
        await tryLoadESM();
      } catch (_) {
        try {
          await tryLoadUMDfallback();
        } catch (err) {
          console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É ID3Writer –Ω–∏ –∫–∞–∫ ESM, –Ω–∏ –∫–∞–∫ UMD', err);
          alert('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å ID3. –û—Ç–∫—Ä–æ–π –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.');
        }
      }

      const fileInput = document.getElementById('fileInput');
      const coverInput = document.getElementById('coverInput');
      const coverPreview = document.getElementById('coverPreview');
      const saveBtn = document.getElementById('saveBtn');
      const loader = document.getElementById('loader');
      const loaderText = document.getElementById('loaderText');

      let selectedFile = null;
      let coverImageDataUrl = null;

      function showLoader(text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
        loaderText.textContent = text;
        loader.classList.remove('hidden');
      }
      function hideLoader() { loader.classList.add('hidden'); }

      fileInput.addEventListener('change', (e) => {
        selectedFile = e.target.files[0] || null;
        saveBtn.disabled = !selectedFile;
        console.log('–§–∞–π–ª –≤—ã–±—Ä–∞–Ω:', selectedFile && selectedFile.name);
      });

      coverInput.addEventListener('change', (e) => {
        const f = e.target.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = () => {
          coverImageDataUrl = r.result;
          coverPreview.src = coverImageDataUrl;
          coverPreview.classList.remove('hidden');
          console.log('–û–±–ª–æ–∂–∫–∞ –≥–æ—Ç–æ–≤–∞');
        };
        r.onerror = () => {
          console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –æ–±–ª–æ–∂–∫–∏', r.error);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ–±–ª–æ–∂–∫–∏.');
        };
        r.readAsDataURL(f);
        showLoader('–ß–∏—Ç–∞–µ–º –æ–±–ª–æ–∂–∫—É...');
        r.onloadend = () => hideLoader();
      });

      saveBtn.addEventListener('click', async () => {
        if (!selectedFile) { alert('–í—ã–±–µ—Ä–∏—Ç–µ MP3!'); return; }
        if (!ID3WriterCtor) { alert('–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–≥–∞–º–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –û—Ç–∫—Ä–æ–π –∫–æ–Ω—Å–æ–ª—å.'); return; }

        try {
          showLoader('–û–±—Ä–∞–±–æ—Ç–∫–∞ MP3...');

          const arrayBuffer = await selectedFile.arrayBuffer();
          const writer = new ID3WriterCtor(new Uint8Array(arrayBuffer));

          const title = document.getElementById('title').value.trim();
          const artist = document.getElementById('artist').value.trim();
          const album = document.getElementById('album').value.trim();

          if (title) writer.setFrame('TIT2', title);
          if (artist) writer.setFrame('TPE1', artist ? [artist] : []);
          if (album) writer.setFrame('TALB', album);

          if (coverImageDataUrl) {
            showLoader('–î–æ–±–∞–≤–ª—è–µ–º –æ–±–ª–æ–∂–∫—É...');
            const resp = await fetch(coverImageDataUrl);
            const blob = await resp.blob();
            const buf = await blob.arrayBuffer();
            writer.setFrame('APIC', { type: 3, data: new Uint8Array(buf), description: 'Cover' });
          }

          writer.addTag();

          showLoader('–ì–æ—Ç–æ–≤–∏–º —Ñ–∞–π–ª...');
          const blobOut = writer.getBlob ? writer.getBlob() : new Blob([writer.arrayBuffer || writer.arrayBuffer()]);
          const url = URL.createObjectURL(blobOut);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'edited_' + selectedFile.name;
          a.click();
          URL.revokeObjectURL(url);

          console.log('–§–∞–π–ª —Å–æ–∑–¥–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ.');
        } catch (err) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ MP3:', err);
          alert('–û—à–∏–±–∫–∞: ' + (err && err.message ? err.message : String(err)));
        } finally {
          hideLoader();
        }
      });

    })();
  </script>


</body>
</html>
