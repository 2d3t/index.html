<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–≥–æ–≤ MP3</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/browser-id3-writer/dist/browser-id3-writer.umd.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">

  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6 space-y-4 relative">
    <h1 class="text-2xl font-bold text-center text-indigo-600">üéµ –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–≥–æ–≤ MP3</h1>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ MP3 -->
    <div>
      <label class="block text-sm font-medium text-gray-700">–í—ã–±–µ—Ä–∏—Ç–µ MP3</label>
      <input type="file" id="fileInput" accept="audio/mpeg" class="mt-1 block w-full text-sm text-gray-600">
    </div>

    <!-- –ü–æ–ª—è –¥–ª—è —Ç–µ–≥–æ–≤ -->
    <div>
      <label class="block text-sm font-medium text-gray-700">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input type="text" id="title" class="w-full mt-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</label>
      <input type="text" id="artist" class="w-full mt-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">–ê–ª—å–±–æ–º</label>
      <input type="text" id="album" class="w-full mt-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-400">
    </div>

    <!-- –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–ª–æ–∂–∫–∏ -->
    <div>
      <label class="block text-sm font-medium text-gray-700">–û–±–ª–æ–∂–∫–∞</label>
      <input type="file" id="coverInput" accept="image/*" class="mt-1 block w-full text-sm text-gray-600">
      <img id="coverPreview" class="mt-3 rounded-lg shadow max-h-40 mx-auto hidden"/>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ -->
    <button id="saveBtn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow hover:bg-indigo-700 transition disabled:opacity-50" disabled>
      üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤—ã–π MP3
    </button>

    <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loader" class="absolute inset-0 bg-white/80 flex flex-col items-center justify-center hidden rounded-2xl">
      <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div>
      <p id="loaderText" class="mt-3 text-indigo-700 font-semibold">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
    </div>
  </div>

  <script>
    let selectedFile;
    let coverImage;

    const fileInput = document.getElementById("fileInput");
    const coverInput = document.getElementById("coverInput");
    const coverPreview = document.getElementById("coverPreview");
    const saveBtn = document.getElementById("saveBtn");

    const loader = document.getElementById("loader");
    const loaderText = document.getElementById("loaderText");

    function showLoader(text = "–ó–∞–≥—Ä—É–∑–∫–∞...") {
      loaderText.textContent = text;
      loader.classList.remove("hidden");
    }

    function hideLoader() {
      loader.classList.add("hidden");
    }

    fileInput.addEventListener("change", (e) => {
      selectedFile = e.target.files[0];
      if (selectedFile) {
        saveBtn.disabled = false;
        console.log("–í—ã–±—Ä–∞–Ω MP3:", selectedFile.name);
      }
    });

    coverInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(evt) {
          coverImage = evt.target.result;
          coverPreview.src = coverImage;
          coverPreview.classList.remove("hidden");
          console.log("–û–±–ª–æ–∂–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞");
        };
        reader.readAsDataURL(file);
      }
    });

    saveBtn.addEventListener("click", async () => {
      if (!selectedFile) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ MP3!");
        return;
      }

      showLoader("–û–±—Ä–∞–±–æ—Ç–∫–∞ MP3...");

      try {
        const arrayBuffer = await selectedFile.arrayBuffer();
        const writer = new window.ID3Writer(new Uint8Array(arrayBuffer));

        const title = document.getElementById("title").value;
        const artist = document.getElementById("artist").value;
        const album = document.getElementById("album").value;

        if (title) writer.setFrame("TIT2", title);
        if (artist) writer.setFrame("TPE1", [artist]);
        if (album) writer.setFrame("TALB", album);

        if (coverImage) {
          loaderText.textContent = "–î–æ–±–∞–≤–ª—è–µ–º –æ–±–ª–æ–∂–∫—É...";
          const response = await fetch(coverImage);
          const blob = await response.blob();
          const buffer = await blob.arrayBuffer();
          writer.setFrame("APIC", {
            type: 3,
            data: new Uint8Array(buffer),
            description: "Cover"
          });
        }

        writer.addTag();

        loaderText.textContent = "–°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª...";

        const blob = writer.getBlob();
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "edited_" + selectedFile.name;
        a.click();

        URL.revokeObjectURL(url);
        console.log("–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");
      } catch (err) {
        alert("–û—à–∏–±–∫–∞: " + err.message);
        console.error(err);
      } finally {
        hideLoader();
      }
    });
  </script>
</body>
</html>
