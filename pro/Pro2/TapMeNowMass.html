<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tap Balls ¬∑ –ø–æ–π–º–∞–π —à–∞—Ä—ã</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: linear-gradient(145deg, #0B0F1C 0%, #1A1F33 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Space Grotesk', sans-serif;
            padding: 0.5rem;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
        .app-container {
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            position: relative;
        }

        h1 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #A7C0FF, #6D8CFF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
            text-shadow: 0 0 15px rgba(109, 140, 255, 0.3);
            text-align: center;
            margin: 0.2rem 0;
        }

        .scoreboard {
            background: rgba(18, 24, 40, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 40px;
            padding: 0.6rem 1.5rem;
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 1.2rem;
            font-weight: 500;
            color: #E9EDFF;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.7), inset 0 1px 1px rgba(255, 255, 255, 0.1);
            border-bottom: 2px solid #4A5B9F;
        }

        .scoreboard-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .scoreboard-value {
            font-weight: 700;
            background: linear-gradient(135deg, #FFD966, #FFB347);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.6rem;
            line-height: 1;
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è */
        .game-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1.2;
            max-width: 450px;
            margin: 0 auto;
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121827;
            border-radius: 32px;
            border: 1px solid rgba(90, 130, 255, 0.25);
            box-shadow: 
                inset 0 0 30px rgba(0, 0, 0, 0.8),
                0 15px 25px -8px black,
                0 0 0 1px #2F3B66 inset;
            transition: box-shadow 0.2s;
            touch-action: none;
        }

        #gameCanvas.active {
            box-shadow: 
                inset 0 0 40px rgba(90, 130, 255, 0.3),
                0 15px 25px -8px black,
                0 0 0 2px #6D8CFF inset;
        }

        /* –û–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–≤–µ—Ä—Ö –∏–≥—Ä–æ–≤–æ–≥–æ –ø–æ–ª—è */
        #result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 400px;
            background: rgba(12, 18, 34, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid #6380E0;
            border-radius: 40px;
            padding: 2rem 1.5rem;
            text-align: center;
            color: white;
            box-shadow: 0 30px 50px black, 0 0 0 2px #A7C0FF inset;
            animation: pop-result 0.3s ease;
            z-index: 100;
        }

        @keyframes pop-result {
            0% { opacity: 0; transform: translate(-50%, -30%); }
            100% { opacity: 1; transform: translate(-50%, -50%); }
        }

        #result h2 {
            font-size: 2.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #FFB884, #FF8F5E);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 1rem;
        }

        #result p {
            font-size: 1.2rem;
            background: #1E2642;
            padding: 0.6rem 1.2rem;
            border-radius: 40px;
            margin: 0.8rem 0;
            border: 1px solid #6779B5;
            display: flex;
            justify-content: space-between;
        }

        #result span {
            color: #FFE791;
            font-weight: 700;
        }

        #playerName {
            background: #0D1225;
            border: 2px solid #3A4C8C;
            border-radius: 40px;
            padding: 0.8rem 1.5rem;
            width: 100%;
            font-size: 1rem;
            color: white;
            outline: none;
            font-family: 'Space Grotesk', sans-serif;
            margin: 15px 0 10px;
        }

        #playerName:focus {
            border-color: #A7C0FF;
            box-shadow: 0 0 15px #4F72E0;
        }

        #saveBtn {
            background: linear-gradient(145deg, #2C3F88, #1D2C62);
            border: none;
            border-radius: 40px;
            padding: 1rem;
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 8px 0 #0F1635, 0 5px 20px #4160D0;
            transition: 0.05s linear;
            width: 100%;
            border: 1px solid #7E99F0;
        }

        #saveBtn:active {
            transform: translateY(4px);
            box-shadow: 0 4px 0 #0F1635, 0 8px 20px #5270E0;
        }

        /* –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω */
        #startScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .start-content {
            background: rgba(18, 24, 40, 0.8);
            border: 2px solid #6380E0;
            border-radius: 48px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            text-align: center;
            color: white;
            box-shadow: 0 30px 50px black;
        }

        .start-content h1 {
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
        }

        .rules-box {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 32px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #3A4C8C;
        }

        .rules-box h2 {
            color: #FFD966;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .rules-box p {
            margin: 0.5rem 0;
            font-size: 1rem;
            color: #B5C7FF;
        }

        #startBtn {
            background: linear-gradient(145deg, #2C3F88, #1D2C62);
            border: 2px solid #7E99F0;
            border-radius: 60px;
            padding: 1rem 3rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            cursor: pointer;
            box-shadow: 0 8px 0 #0F1635, 0 0 30px #4160D0;
            transition: 0.05s linear;
            width: 100%;
        }

        #startBtn:active {
            transform: translateY(5px);
            box-shadow: 0 3px 0 #0F1635, 0 0 30px #5270E0;
        }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .control-panel {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            justify-content: center;
            margin-top: 0.5rem;
        }

        .control-btn {
            background: linear-gradient(145deg, #2C3F88, #1D2C62);
            border: 2px solid #7E99F0;
            border-radius: 40px;
            padding: 0.5rem 1.2rem;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 0 #0F1635;
            transition: 0.05s linear;
            flex: 1;
            max-width: 120px;
        }

        .control-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #0F1635;
        }

        #soundToggle.muted {
            opacity: 0.7;
            background: linear-gradient(145deg, #444, #222);
            border-color: #666;
        }

        .test-sound-btn {
            background: #3A4C8C;
            border: none;
            border-radius: 30px;
            padding: 0.3rem 1rem;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            box-shadow: 0 2px 0 #1A1F33;
        }

        @media (max-width: 380px) {
            h1 { font-size: 1.8rem; }
            .scoreboard { font-size: 1rem; }
            .scoreboard-value { font-size: 1.4rem; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1>‚ö° TAP BALLS ‚ö°</h1>
        
        <div class="scoreboard">
            <div class="scoreboard-item">‚è±Ô∏è <span class="scoreboard-value" id="timer">10</span></div>
            <div class="scoreboard-item">üìä –£–†–û–í <span class="scoreboard-value" id="level">1</span></div>
        </div>

        <div class="game-wrapper">
            <canvas id="gameCanvas"></canvas>
            
            <!-- –û–∫–Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–≤–µ—Ä—Ö –ø–æ–ª—è -->
            <div id="result" style="display: none;">
                <h2>GAME OVER</h2>
                <p>üèÜ –£—Ä–æ–≤–µ–Ω—å <span id="finalLevel">1</span></p>
                <input type="text" id="playerName" placeholder="–Ω–∏–∫–Ω–µ–π–º" autocomplete="off">
                <button id="saveBtn">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
            </div>
        </div>

        <div class="control-panel">
            <button id="newGameBtn" class="control-btn">üîÑ –ù–û–í–ê–Ø</button>
            <button id="soundToggle" class="control-btn">üîä –ó–í–£–ö</button>
            <button id="testSoundBtn" class="test-sound-btn">üéµ —Ç–µ—Å—Ç</button>
        </div>
    </div>

    <!-- –°—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω -->
    <div id="startScreen">
        <div class="start-content">
            <h1>‚ö° TAP BALLS ‚ö°</h1>
            <div class="rules-box">
                <h2>–ü—Ä–∞–≤–∏–ª–∞</h2>
                <p>üîπ –ù–∞ –∫–∞–∂–¥–æ–º —É—Ä–æ–≤–Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è —à–∞—Ä—ã</p>
                <p>üîπ –õ–æ–≤–∏ –∏—Ö –∫–∞—Å–∞–Ω–∏–µ–º –∑–∞ 10 —Å–µ–∫—É–Ω–¥</p>
                <p>üîπ –£—Å–ø–µ–µ—à—å ‚Äî —É—Ä–æ–≤–µ–Ω—å —Ä–∞—Å—Ç—ë—Ç</p>
                <p>üîπ –° –∫–∞–∂–¥—ã–º —É—Ä–æ–≤–Ω–µ–º —à–∞—Ä–æ–≤ –±–æ–ª—å—à–µ</p>
                <p>üîπ –ù–µ —É—Å–ø–µ–ª ‚Äî –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞</p>
            </div>
            <button id="startBtn">‚ñ∂ –°–¢–ê–†–¢</button>
        </div>
    </div>

    <script>
        (function() {
            // ---------- –ò–ì–†–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ----------
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            let level = 1;
            let timeLeft = 10;
            let gameActive = false;
            let balls = [];
            let animationFrame;
            let countdownInterval;
            
            // –ó–≤—É–∫–∏
            let soundEnabled = true;
            let audioCtx = null;
            
            // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
            const timerDisplay = document.getElementById('timer');
            const levelDisplay = document.getElementById('level');
            const resultDiv = document.getElementById('result');
            const finalLevelSpan = document.getElementById('finalLevel');
            const saveBtn = document.getElementById('saveBtn');
            const playerNameInput = document.getElementById('playerName');
            const startScreen = document.getElementById('startScreen');
            const startBtn = document.getElementById('startBtn');
            const newGameBtn = document.getElementById('newGameBtn');
            const soundToggle = document.getElementById('soundToggle');
            const testSoundBtn = document.getElementById('testSoundBtn');

            // ---------- –ó–í–£–ö–û–í–ê–Ø –°–ò–°–¢–ï–ú–ê ----------
            function initAudio() {
                if (audioCtx) return audioCtx;
                try {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    audioCtx = new AudioContextClass();
                } catch (e) {}
                return audioCtx;
            }

            function playSound(type) {
                if (!soundEnabled) return;
                
                const ctx = initAudio();
                if (!ctx) return;
                
                if (ctx.state === 'suspended') {
                    ctx.resume().then(() => playSound(type));
                    return;
                }
                
                try {
                    const osc = ctx.createOscillator();
                    const gainNode = ctx.createGain();
                    
                    osc.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    
                    switch(type) {
                        case 'catch': // –ü–æ–π–º–∞–ª —à–∞—Ä
                            osc.type = 'sine';
                            osc.frequency.value = 800;
                            gainNode.gain.setValueAtTime(0.1, ctx.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
                            osc.start();
                            osc.stop(ctx.currentTime + 0.1);
                            break;
                            
                        case 'levelUp': // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —É—Ä–æ–≤–µ–Ω—å
                            osc.type = 'sine';
                            osc.frequency.value = 600;
                            gainNode.gain.setValueAtTime(0.15, ctx.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
                            osc.start();
                            osc.stop(ctx.currentTime + 0.2);
                            
                            setTimeout(() => {
                                if (!soundEnabled) return;
                                try {
                                    const osc2 = ctx.createOscillator();
                                    const gain2 = ctx.createGain();
                                    osc2.connect(gain2);
                                    gain2.connect(ctx.destination);
                                    osc2.type = 'sine';
                                    osc2.frequency.value = 800;
                                    gain2.gain.setValueAtTime(0.1, ctx.currentTime);
                                    gain2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.15);
                                    osc2.start();
                                    osc2.stop(ctx.currentTime + 0.15);
                                } catch(e) {}
                            }, 150);
                            break;
                            
                        case 'gameOver': // –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã
                            osc.type = 'sawtooth';
                            osc.frequency.setValueAtTime(300, ctx.currentTime);
                            osc.frequency.exponentialRampToValueAtTime(80, ctx.currentTime + 0.8);
                            gainNode.gain.setValueAtTime(0.2, ctx.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1);
                            osc.start();
                            osc.stop(ctx.currentTime + 1);
                            
                            setTimeout(() => {
                                if (!soundEnabled) return;
                                try {
                                    const osc2 = ctx.createOscillator();
                                    const gain2 = ctx.createGain();
                                    osc2.connect(gain2);
                                    gain2.connect(ctx.destination);
                                    osc2.type = 'sine';
                                    osc2.frequency.setValueAtTime(150, ctx.currentTime);
                                    osc2.frequency.exponentialRampToValueAtTime(70, ctx.currentTime + 0.6);
                                    gain2.gain.setValueAtTime(0.1, ctx.currentTime);
                                    gain2.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.7);
                                    osc2.start();
                                    osc2.stop(ctx.currentTime + 0.7);
                                } catch(e) {}
                            }, 200);
                            break;
                    }
                } catch(e) {}
            }

            // ---------- –†–ê–ó–ú–ï–†–´ –ö–ê–ù–í–ê–°–ê ----------
            function resizeCanvas() {
                const container = canvas.parentElement;
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                drawBalls();
            }

            // ---------- –ö–õ–ê–°–° –®–ê–†–ê ----------
            class Ball {
                constructor(x, y) {
                    this.x = x;
                    this.y = y;
                    this.radius = canvas.width * 0.06; // 6% –æ—Ç —à–∏—Ä–∏–Ω—ã
                    this.vx = (Math.random() - 0.5) * 2;
                    this.vy = (Math.random() - 0.5) * 2;
                }

                update() {
                    this.x += this.vx;
                    this.y += this.vy;
                    
                    // –ì—Ä–∞–Ω–∏—Ü—ã
                    if (this.x - this.radius < 0) {
                        this.x = this.radius;
                        this.vx *= -1;
                    }
                    if (this.x + this.radius > canvas.width) {
                        this.x = canvas.width - this.radius;
                        this.vx *= -1;
                    }
                    if (this.y - this.radius < 0) {
                        this.y = this.radius;
                        this.vy *= -1;
                    }
                    if (this.y + this.radius > canvas.height) {
                        this.y = canvas.height - this.radius;
                        this.vy *= -1;
                    }
                }

                draw() {
                    // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –æ–±—ä—ë–º–∞
                    const gradient = ctx.createRadialGradient(
                        this.x - this.radius * 0.3, 
                        this.y - this.radius * 0.3, 
                        this.radius * 0.2,
                        this.x, 
                        this.y, 
                        this.radius
                    );
                    gradient.addColorStop(0, '#FF8A9F');
                    gradient.addColorStop(1, '#E63E6E');
                    
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fillStyle = gradient;
                    ctx.shadowColor = '#FF4F79';
                    ctx.shadowBlur = 15;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    
                    // –ë–ª–∏–∫
                    ctx.beginPath();
                    ctx.arc(this.x - this.radius * 0.2, this.y - this.radius * 0.2, this.radius * 0.2, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.fill();
                }

                isHit(mx, my) {
                    const dx = mx - this.x;
                    const dy = my - this.y;
                    return Math.sqrt(dx * dx + dy * dy) <= this.radius;
                }
            }

            // ---------- –ò–ì–†–û–í–´–ï –§–£–ù–ö–¶–ò–ò ----------
            function startLevel() {
                if (!gameActive) return;
                
                timeLeft = 10;
                timerDisplay.textContent = timeLeft;
                
                // –°–æ–∑–¥–∞—ë–º —à–∞—Ä—ã
                balls = [];
                for (let i = 0; i < level; i++) {
                    const x = Math.random() * (canvas.width - 60) + 30;
                    const y = Math.random() * (canvas.height - 60) + 30;
                    balls.push(new Ball(x, y));
                }
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                if (animationFrame) cancelAnimationFrame(animationFrame);
                animate();
                
                // –¢–∞–π–º–µ—Ä
                if (countdownInterval) clearInterval(countdownInterval);
                countdownInterval = setInterval(() => {
                    if (!gameActive) return;
                    
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    
                    if (timeLeft <= 0) {
                        endGame();
                    }
                }, 1000);
            }

            function animate() {
                if (!gameActive) return;
                
                // –û—á–∏—Å—Ç–∫–∞
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ —à–∞—Ä–æ–≤
                balls.forEach(ball => {
                    ball.update();
                    ball.draw();
                });
                
                animationFrame = requestAnimationFrame(animate);
            }

            function drawBalls() {
                if (!gameActive) return;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                balls.forEach(ball => ball.draw());
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Å–∞–Ω–∏–π
            canvas.addEventListener('click', handleTap);
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleTap(e.touches[0]);
            });

            function handleTap(e) {
                if (!gameActive) return;
                
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                const mouseX = (e.clientX - rect.left) * scaleX;
                const mouseY = (e.clientY - rect.top) * scaleY;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ø–∞–¥–∞–Ω–∏–µ
                for (let i = balls.length - 1; i >= 0; i--) {
                    if (balls[i].isHit(mouseX, mouseY)) {
                        balls.splice(i, 1);
                        playSound('catch');
                        break;
                    }
                }
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–±–µ–¥—É
                if (balls.length === 0 && gameActive) {
                    // –í—Å–µ —à–∞—Ä—ã –ø–æ–π–º–∞–Ω—ã
                    playSound('levelUp');
                    level++;
                    levelDisplay.textContent = level;
                    startLevel();
                }
            }

            function endGame() {
                gameActive = false;
                canvas.classList.remove('active');
                
                playSound('gameOver');
                
                clearInterval(countdownInterval);
                if (animationFrame) cancelAnimationFrame(animationFrame);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                finalLevelSpan.textContent = level;
                resultDiv.style.display = 'block';
            }

            function startGame() {
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∑–≤—É–∫
                const ctx = initAudio();
                if (ctx && ctx.state === 'suspended') ctx.resume();
                
                gameActive = true;
                canvas.classList.add('active');
                
                level = 1;
                levelDisplay.textContent = level;
                
                resultDiv.style.display = 'none';
                startScreen.style.display = 'none';
                
                startLevel();
                playSound('catch');
            }

            function resetGame() {
                gameActive = false;
                canvas.classList.remove('active');
                
                clearInterval(countdownInterval);
                if (animationFrame) cancelAnimationFrame(animationFrame);
                
                level = 1;
                timeLeft = 10;
                timerDisplay.textContent = timeLeft;
                levelDisplay.textContent = level;
                balls = [];
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                resultDiv.style.display = 'none';
                startScreen.style.display = 'flex';
            }

            // ---------- –°–û–•–†–ê–ù–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–ê ----------
            function saveResult() {
                const name = playerNameInput.value.trim() || '–ê–ù–û–ù–ò–ú';
                
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 250;
                const ctx = canvas.getContext('2d');
                
                // –ì—Ä–∞–¥–∏–µ–Ω—Ç
                const grad = ctx.createLinearGradient(0, 0, 0, canvas.height);
                grad.addColorStop(0, '#0B0F1C');
                grad.addColorStop(1, '#1A1F33');
                ctx.fillStyle = grad;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // –†–∞–º–∫–∞
                ctx.strokeStyle = '#6D8CFF';
                ctx.lineWidth = 3;
                ctx.strokeRect(5, 5, canvas.width - 10, canvas.height - 10);
                
                // –¢–µ–∫—Å—Ç
                ctx.font = 'bold 24px "Space Grotesk", Arial';
                ctx.fillStyle = '#A7C0FF';
                ctx.shadowColor = '#4F72E0';
                ctx.shadowBlur = 8;
                ctx.fillText('‚ö° TAP BALLS ‚ö°', 80, 60);
                ctx.shadowBlur = 0;
                
                ctx.font = '20px "Space Grotesk", monospace';
                ctx.fillStyle = '#FFFFFF';
                ctx.shadowColor = '#000';
                ctx.shadowBlur = 5;
                ctx.fillText(`–ò–≥—Ä–æ–∫: ${name}`, 50, 120);
                ctx.fillStyle = '#FFD966';
                ctx.fillText(`–£—Ä–æ–≤–µ–Ω—å: ${level}`, 50, 160);
                
                const now = new Date();
                ctx.font = '14px monospace';
                ctx.fillStyle = '#9BA9DE';
                ctx.fillText(now.toLocaleString(), 50, 200);
                
                // –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
                const link = document.createElement('a');
                link.download = `tapballs_${name}_lv${level}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                
                // –í–æ–∑–≤—Ä–∞—Ç –∫ —Å—Ç–∞—Ä—Ç—É
                resetGame();
            }

            // ---------- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–í–£–ö–û–ú ----------
            function toggleSound() {
                soundEnabled = !soundEnabled;
                soundToggle.textContent = soundEnabled ? 'üîä –ó–í–£–ö' : 'üîá –¢–ò–•–û';
                if (soundEnabled) playSound('catch');
            }

            function testSound() {
                const ctx = initAudio();
                if (ctx && ctx.state === 'suspended') {
                    ctx.resume().then(() => {
                        playSound('catch');
                        setTimeout(() => playSound('levelUp'), 300);
                        setTimeout(() => playSound('gameOver'), 800);
                    });
                } else {
                    playSound('catch');
                    setTimeout(() => playSound('levelUp'), 300);
                    setTimeout(() => playSound('gameOver'), 800);
                }
            }

            // ---------- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ----------
            window.addEventListener('resize', resizeCanvas);
            
            startBtn.addEventListener('click', startGame);
            newGameBtn.addEventListener('click', resetGame);
            saveBtn.addEventListener('click', saveResult);
            soundToggle.addEventListener('click', toggleSound);
            testSoundBtn.addEventListener('click', testSound);
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∞—É–¥–∏–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∫–∞—Å–∞–Ω–∏–∏
            canvas.addEventListener('click', () => {
                const ctx = initAudio();
                if (ctx && ctx.state === 'suspended') ctx.resume();
            }, { once: true });
            
            resizeCanvas();
        })();
    </script>
</body>
</html>