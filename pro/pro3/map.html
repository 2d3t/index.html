<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –∑–∞–ø–∏—Å–æ–∫ | Everest Me</title>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É Leaflet –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Ü–≤–µ—Ç–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-color-markers@1.0.3/css/leaflet-color-markers.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: sans-serif; padding: 20px; background: #f0f2f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { margin-bottom: 10px; color: #2c3e50; }
        .subtitle { margin-bottom: 20px; color: #7f8c8d; }
        #map { height: 600px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 20px; }
        .instructions, .note { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .note { border-left: 4px solid #3498db; }
        code { background: #eee; padding: 2px 5px; border-radius: 3px; }
        .legend { display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .legend-color { width: 20px; height: 20px; border-radius: 50%; }
        .legend-color.red { background-color: #e74c3c; }
        .legend-color.blue { background-color: #3498db; }
        .legend-color.green { background-color: #2ecc71; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –∑–∞–ø–∏—Å–æ–∫ Everest Me</h1>
        <p class="subtitle">–ú–µ—Å—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ—Å–µ—Ç–∏–ª–∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏, –∏ –∏—Ö –∑–∞–º–µ—Ç–∫–∏.</p>
        
        <div class="note">
            <strong>–û–±–æ–∑–Ω–∞—á–µ–Ω–∏—è:</strong>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color red"></div>
                    <span>–í—ã (–≤–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color blue"></div>
                    <span>–î—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</span>
                </div>
            </div>
        </div>

        <div id="map"></div>

        <div class="note" id="statusNote">
            –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç—ã –∏ –¥–∞–Ω–Ω—ã—Ö...
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –≤ —Ü–µ–Ω—Ç—Ä–µ –†–æ—Å—Å–∏–∏ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
        const map = L.map('map').setView([55.7558, 37.6176], 5);

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π —Å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º–∏ –∫–∞—Ä—Ç–∞–º–∏ OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // –ì—Ä—É–ø–ø–∞ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
        const markersLayer = L.layerGroup().addTo(map);

        // –°–æ–∑–¥–∞–µ–º —Ä–∞–∑–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –º–∞—Ä–∫–µ—Ä–æ–≤
        function createCustomIcon(color) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ Leaflet —Å —Ä–∞–∑–Ω—ã–º–∏ —Ü–≤–µ—Ç–∞–º–∏
            let iconUrl;
            let iconSize = [25, 41];
            let iconAnchor = [12, 41];
            let popupAnchor = [1, -34];
            let shadowUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png';
            let shadowSize = [41, 41];

            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            switch(color) {
                case 'red':
                    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
                    break;
                case 'green':
                    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png';
                    break;
                case 'orange':
                    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png';
                    break;
                case 'blue':
                default:
                    iconUrl = 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png';
            }

            return L.icon({
                iconUrl: iconUrl,
                shadowUrl: shadowUrl,
                iconSize: iconSize,
                iconAnchor: iconAnchor,
                popupAnchor: popupAnchor,
                shadowSize: shadowSize
            });
        }

        // –ü—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –∏–∫–æ–Ω–∫–∏
        const blueIcon = createCustomIcon('blue');
        const redIcon = createCustomIcon('red');
        const greenIcon = createCustomIcon('green');

        // –§–£–ù–ö–¶–ò–Ø: –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ URL
        function getNotesDataFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const dataParam = urlParams.get('data');

            if (!dataParam) {
                console.warn('–ü–∞—Ä–∞–º–µ—Ç—Ä "data" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ URL. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö.');
                return getExampleData(); // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –±–µ–∑ –±–æ—Ç–∞
            }

            try {
                // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∏ –ø–∞—Ä—Å–∏–º JSON —Å—Ç—Ä–æ–∫—É –∏–∑ URL
                const decodedData = decodeURIComponent(dataParam);
                const notes = JSON.parse(decodedData);
                
                // –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', notes);
                console.log('–¢–∏–ø—ã –º–µ—Ç–æ–∫:', notes.map(note => ({
                    username: note.username,
                    type: note.type,
                    color: note.color,
                    text: note.text
                })));
                
                return notes;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ URL:', error);
                document.getElementById('statusNote').innerHTML = '<span style="color:#e74c3c;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Å—Å—ã–ª–∫–∏.</span>';
                return [];
            }
        }

        // –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ç–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ
        function loadMarkers(notesData) {
            if (!notesData || notesData.length === 0) {
                document.getElementById('statusNote').innerHTML = '–ù–∞ –∫–∞—Ä—Ç–µ –Ω–µ—Ç –º–µ—Ç–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.';
                return;
            }

            let bounds = []; // –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∞
            let currentUserMarker = null; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            let otherMarkersCount = 0;
            let currentUserCount = 0;

            notesData.forEach(note => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                if (note.lat && note.lon) {
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏–∫–æ–Ω–∫–∏
                    let markerIcon;
                    let isCurrentUser = false;
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (note.color === 'red' || note.type === 'current' || 
                        (note.username && (note.username.includes('–í—ã') || note.username.includes('User_')) && note.text && note.text.includes('–í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ'))) {
                        markerIcon = redIcon;
                        isCurrentUser = true;
                        currentUserCount++;
                    } else {
                        markerIcon = blueIcon;
                        otherMarkersCount++;
                    }

                    // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞
                    let popupContent = `
                        <div style="min-width: 200px; font-family: sans-serif;">
                            <strong>${isCurrentUser ? 'üìç –í–´ –ó–î–ï–°–¨' : 'üë§ ' + (note.username || '–ê–Ω–æ–Ω–∏–º')}</strong><br>
                            ${note.time ? `<small>üìÖ ${note.time}</small><br>` : ''}
                            <hr style="margin: 5px 0;">
                            <p>${note.text || '...'}</p>
                            <small style="color: gray;">üìç ${note.lat.toFixed(6)}, ${note.lon.toFixed(6)}</small>
                        </div>
                    `;

                    // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
                    const marker = L.marker([note.lat, note.lon], { 
                        icon: markerIcon,
                        title: isCurrentUser ? '–í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ' : note.username || '–ê–Ω–æ–Ω–∏–º'
                    }).addTo(markersLayer).bindPopup(popupContent);

                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –º–∞—Ä–∫–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    if (isCurrentUser) {
                        currentUserMarker = marker;
                    }

                    bounds.push([note.lat, note.lon]);
                }
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–∏—Ä–∞–µ–º –º–∞—Å—à—Ç–∞–±, —á—Ç–æ–±—ã –±—ã–ª–∏ –≤–∏–¥–Ω—ã –≤—Å–µ –º–µ—Ç–∫–∏
            if (bounds.length > 0) {
                map.fitBounds(bounds);
                
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                if (currentUserMarker) {
                    setTimeout(() => {
                        currentUserMarker.openPopup();
                    }, 1000);
                }
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            let statusHtml = `‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ <strong>${notesData.length}</strong> –∑–∞–º–µ—Ç–æ–∫. `;
            if (currentUserCount > 0) {
                statusHtml += `<br>üî¥ –í–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: 1`;
            }
            if (otherMarkersCount > 0) {
                statusHtml += `<br>üîµ –î—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ${otherMarkersCount}`;
            }
            statusHtml += `<br>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∑–Ω–∞—á–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∑–∞–º–µ—Ç–∫—É.`;
            
            document.getElementById('statusNote').innerHTML = statusHtml;
        }

        // –§–£–ù–ö–¶–ò–Ø: –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö (–µ—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä 'data' –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω)
        function getExampleData() {
            return [
                { 
                    username: "–í—ã", 
                    lat: 55.755826, 
                    lon: 37.617300, 
                    text: "–í–∞—à–µ —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ", 
                    time: "–°–µ–π—á–∞—Å",
                    color: "red",
                    type: "current"
                },
                { 
                    username: "–ò–≤–∞–Ω_–ü—É—Ç–µ—à–µ—Å—Ç–≤–µ–Ω–Ω–∏–∫", 
                    lat: 55.755826, 
                    lon: 37.617300, 
                    text: "–ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å! –ù–µ–∑–∞–±—ã–≤–∞–µ–º–æ.", 
                    time: "15-04-2024 12:30",
                    color: "blue",
                    type: "other"
                },
                { 
                    username: "–ê–Ω–Ω–∞_–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å", 
                    lat: 59.934280, 
                    lon: 30.335099, 
                    text: "–≠—Ä–º–∏—Ç–∞–∂ - —Ü–µ–ª—ã–π –º–∏—Ä –∏—Å–∫—É—Å—Å—Ç–≤–∞.", 
                    time: "10-04-2024 15:45",
                    color: "blue",
                    type: "other"
                },
                { 
                    username: "–ú–∞–∫—Å–∏–º_–¢—É—Ä–∏—Å—Ç", 
                    lat: 43.585525, 
                    lon: 39.723062, 
                    text: "–°–æ—á–∏, —Å–æ–ª–Ω–µ—á–Ω—ã–π –¥–µ–Ω—å —É –º–æ—Ä—è.", 
                    time: "05-04-2024 11:20",
                    color: "blue",
                    type: "other"
                }
            ];
        }

        // –ó–ê–ü–£–°–ö: –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É
        document.addEventListener('DOMContentLoaded', function() {
            const notesData = getNotesDataFromUrl();
            loadMarkers(notesData);
        });
    </script>
</body>
</html>