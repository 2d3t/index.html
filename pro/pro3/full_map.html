<!DOCTYPE html>
<html>
<head>
    <title>Everest Me - –ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∞</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; }
        .info { padding: 6px 8px; background: white; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; }
        .info h4 { margin: 0 0 5px; color: #777; }
        .legend { line-height: 18px; color: #555; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
        .popup-content { max-width: 300px; max-height: 400px; overflow-y: auto; }
        .note-item { margin: 8px 0; padding: 8px; background: #f8f9fa; border-left: 3px solid #007bff; border-radius: 3px; }
        .username { font-weight: bold; color: #007bff; }
        .timestamp { font-size: 0.85em; color: #6c757d; }
        .view-details-btn { 
            display: block; width: 100%; padding: 8px; 
            margin-top: 10px; background: #28a745; 
            color: white; border: none; border-radius: 4px; 
            cursor: pointer; text-align: center; 
            text-decoration: none; 
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <script>
        // –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const encodedData = urlParams.get('data');
        
        if (!encodedData) {
            document.getElementById('map').innerHTML = '<h2 style="padding: 20px;">–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</h2>';
            throw new Error('No data provided');
        }
        
        let mapData;
        try {
            mapData = JSON.parse(decodeURIComponent(encodedData));
        } catch (e) {
            document.getElementById('map').innerHTML = '<h2 style="padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h2>';
            throw new Error('Invalid JSON data');
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        const map = L.map('map').setView([55.7558, 37.6176], 3);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–∞–π–ª—ã OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            maxZoom: 19
        }).addTo(map);
        
        // –°–æ–∑–¥–∞–µ–º –∫–ª–∞—Å—Ç–µ—Ä–Ω—É—é –≥—Ä—É–ø–ø—É
        const markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
        });
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–≤–µ—Ç–∞ –º–µ—Ç–∫–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø–∏—Å–æ–∫
        function getMarkerColor(count) {
            if (count >= 10) return '#dc3545'; // red
            if (count >= 5) return '#fd7e14';  // orange
            if (count >= 2) return '#28a745';  // green
            return '#007bff';                   // blue
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –º–µ—Ç–∫–∏
        function getMarkerSize(count) {
            return Math.min(8 + Math.log2(count) * 3, 25);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏
        mapData.locations.forEach(location => {
            const color = getMarkerColor(location.count);
            const size = getMarkerSize(location.count);
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—É—é –∏–∫–æ–Ω–∫—É
            const icon = L.divIcon({
                html: `<div style="
                    width: ${size}px; 
                    height: ${size}px; 
                    background-color: ${color}; 
                    border: 2px solid white; 
                    border-radius: 50%; 
                    box-shadow: 0 0 5px rgba(0,0,0,0.3);
                    display: flex; 
                    align-items: center; 
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: ${Math.max(10, size/2)}px;">
                    ${location.count}
                </div>`,
                className: 'custom-marker',
                iconSize: [size, size],
                iconAnchor: [size/2, size/2]
            });
            
            const marker = L.marker([location.lat, location.lon], { icon: icon });
            
            // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–æ–ø–∞–ø–∞
            let popupContent = `<div class="popup-content">
                <h4 style="margin-top: 0;">üìç –ú–µ—Å—Ç–æ</h4>
                <p><strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong><br>
                ${location.lat.toFixed(6)}, ${location.lon.toFixed(6)}</p>
                <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–æ–∫:</strong> ${location.count}</p>`;
            
            if (location.preview && location.preview.length > 0) {
                popupContent += '<h5>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∫–∏:</h5>';
                location.preview.forEach((note, index) => {
                    popupContent += `
                    <div class="note-item">
                        <div class="username">üë§ ${note.username}</div>
                        <div>${note.note}</div>
                        <div class="timestamp">üïí ${note.time}</div>
                    </div>`;
                });
                
                if (location.count > 3) {
                    popupContent += `<p><em>... –∏ –µ—â–µ ${location.count - 3} –∑–∞–ø–∏—Å–æ–∫</em></p>`;
                }
            }
            
            // –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–æ–∫
            popupContent += `
                <a href="location_details.html?lat=${location.lat}&lon=${location.lon}" 
                   class="view-details-btn" 
                   target="_blank">
                   üë• –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞–ø–∏—Å–∫–∏ (${location.count})
                </a>
            </div>`;
            
            marker.bindPopup(popupContent);
            markers.addLayer(marker);
        });
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Ç–µ—Ä—ã –Ω–∞ –∫–∞—Ä—Ç—É
        map.addLayer(markers);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –º–µ—Ç–∫–∞
        if (mapData.locations.length === 1) {
            const loc = mapData.locations[0];
            map.setView([loc.lat, loc.lon], 15);
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'info legend');
            div.innerHTML = `
                <h4>–õ–µ–≥–µ–Ω–¥–∞ –∫–∞—Ä—Ç—ã</h4>
                <div><i style="background: #007bff"></i> 1 –∑–∞–ø–∏—Å–∫–∞</div>
                <div><i style="background: #28a745"></i> 2-4 –∑–∞–ø–∏—Å–∫–∏</div>
                <div><i style="background: #fd7e14"></i> 5-9 –∑–∞–ø–∏—Å–æ–∫</div>
                <div><i style="background: #dc3545"></i> 10+ –∑–∞–ø–∏—Å–æ–∫</div>
                <hr style="margin: 8px 0;">
                <div><strong>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</strong></div>
                <div>üìù –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–æ–∫: ${mapData.stats.total_notes}</div>
                <div>üìç –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –º–µ—Å—Ç: ${mapData.stats.unique_locations}</div>
                <div>üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${mapData.stats.unique_users}</div>
                <div style="margin-top: 8px; font-size: 0.8em; color: #666;">
                    –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${mapData.timestamp}
                </div>
            `;
            return div;
        };
        legend.addTo(map);
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–∞–Ω–Ω—ã—Ö
        const info = L.control({position: 'topleft'});
        info.onAdd = function(map) {
            const div = L.DomUtil.create('div', 'info');
            div.innerHTML = `
                <h4>üåç Everest Me - –ü–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∞</h4>
                <div>–ü–æ–∫–∞–∑–∞–Ω–æ –º–µ—Å—Ç: ${mapData.locations.length}</div>
                <div>–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –º–µ—Ç–∫—É –¥–ª—è –¥–µ—Ç–∞–ª–µ–π</div>
            `;
            return div;
        };
        info.addTo(map);
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
        map.on('error', function(e) {
            console.error('Map error:', e);
        });
    </script>
</body>
</html>