<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Initi - –§–∞–π–ª–æ–≤—ã–π –ú–µ–Ω–µ–¥–∂–µ—Ä</title>
    <style id="current-skin">
        /* --- üé® –°–∫–∏–Ω Windows 95 (–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é) --- */
        :root {
            --color-bg: #c0c0c0;
            --color-primary: #000080;
            --color-text: #000;
            --color-btn-bg: #c0c0c0;
            --color-btn-border-light: #fff;
            --color-btn-border-dark: #808080;
            --color-active: #000080;
            --color-active-text: #fff;
            --color-header-bg: #000080;
            --color-header-text: #fff;
            --color-input-bg: #fff;
            --font-family: 'Tahoma', 'Arial', sans-serif;
            --shadow-light: 1px 1px #fff;
            --shadow-dark: 1px 1px #000;
        }

        body {
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-family);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-y: auto;
            -webkit-user-select: none; /* –û—Ç–∫–ª—é—á–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ iOS */
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* –û–±—â–µ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –æ–∫–æ–Ω –∏ –∫–Ω–æ–ø–æ–∫ –≤ —Å—Ç–∏–ª–µ 95 */
        .window, #fileSystem {
            background-color: var(--color-bg);
            border: 3px solid;
            border-color: var(--color-btn-border-light) var(--color-btn-border-dark) var(--color-btn-border-dark) var(--color-btn-border-light);
            padding: 2px;
            box-shadow: var(--shadow-dark) 2px 2px 0 0;
        }

        .header {
            background-color: var(--color-header-bg);
            color: var(--color-header-text);
            padding: 2px 4px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        button, input[type="button"], select {
            background-color: var(--color-btn-bg);
            border: 3px solid;
            border-color: var(--color-btn-border-light) var(--color-btn-border-dark) var(--color-btn-border-dark) var(--color-btn-border-light);
            padding: 2px 8px;
            margin: 2px;
            font-family: var(--font-family);
            font-size: 14px;
            outline: none;
        }

        button:active, input[type="button"]:active {
            border-color: var(--color-btn-border-dark) var(--color-btn-border-light) var(--color-btn-border-light) var(--color-btn-border-dark);
            padding: 3px 7px 1px 9px; /* –ò–º–∏—Ç–∞—Ü–∏—è –Ω–∞–∂–∞—Ç–∏—è */
        }

        /* --- –û–±—â–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã UI --- */
        #mainContainer {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 8px;
            position: relative;
        }

        #pathBar {
            background-color: var(--color-input-bg);
            border: 1px solid var(--color-btn-border-dark);
            padding: 4px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        #fileSystem {
            flex-grow: 1;
            overflow-y: auto;
            padding: 4px;
            min-height: 200px;
            position: relative;
        }

        .file-item, .folder-item {
            display: flex;
            align-items: center;
            padding: 4px;
            margin-bottom: 2px;
            border: 1px solid transparent;
            cursor: pointer;
            position: relative;
        }

        .file-item:hover, .folder-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .file-item.selected, .folder-item.selected {
            background-color: var(--color-active);
            color: var(--color-active-text);
        }

        .file-item-name, .folder-item-name {
            margin-left: 8px;
            /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –Ω–∞ –æ–±–æ—è—Ö */
            background-color: rgba(0, 0, 0, 0.5); 
            color: white;
            padding: 1px 4px;
            border-radius: 2px;
        }
        
        /* –ß–µ—Ä–Ω—ã–π —Ñ–æ–Ω –¥–ª—è –Ω–∞–¥–ø–∏—Å–∏ –¥–∞—Ç—ã, —á—Ç–æ–±—ã –±—ã–ª–æ –≤–∏–¥–Ω–æ –Ω–∞ –æ–±–æ—è—Ö */
        .file-date, .folder-date {
            margin-left: auto;
            font-size: 10px;
            background-color: rgba(0, 0, 0, 0.5); 
            color: white;
            padding: 1px 4px;
            border-radius: 2px;
        }

        /* –û–±–æ–∏ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏ */
        #fileSystem.has-wallpaper {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: transparent !important;
        }

        /* –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –æ–∫–Ω–µ */
        .control-panel {
            display: flex;
            flex-wrap: wrap;
            padding: 8px 0;
            border-top: 1px solid var(--color-btn-border-dark);
        }
        
        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            width: 90%;
            max-width: 400px;
        }
        
        /* –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ */
        #textEditor textarea {
            width: 100%;
            min-height: 200px;
            box-sizing: border-box;
            border: 1px solid var(--color-btn-border-dark);
            margin-bottom: 8px;
            background-color: var(--color-input-bg);
            color: var(--color-text);
            font-family: monospace;
            padding: 4px;
        }
        
        /* –ü—Ä–æ—Å–º–æ—Ç—Ä—â–∏–∫ —Ñ–æ—Ç–æ */
        #photoViewer {
            background-color: rgba(0, 0, 0, 0.95);
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            touch-action: pan-y; /* –î–ª—è —Å–≤–∞–π–ø–∞ */
        }

        #photoDisplay {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* –ò–∫–æ–Ω–∫–∏ */
        .icon {
            font-size: 18px;
            margin-right: 4px;
        }
        .icon-folder::before { content: 'üìÅ'; }
        .icon-file::before { content: 'üìÑ'; }
        .icon-text::before { content: 'üìù'; }
        .icon-photo::before { content: 'üñºÔ∏è'; }
        .icon-audio::before { content: 'üéß'; }
        .icon-html::before { content: 'üåê'; }

        /* --- üîç –ü–æ–∏—Å–∫ --- */
        #searchBox {
            width: 100%;
            padding: 4px;
            box-sizing: border-box;
            border: 1px solid var(--color-btn-border-dark);
            margin-bottom: 8px;
            background-color: var(--color-input-bg);
        }

        /* --- üé® –°–∫–∏–Ω—ã --- */
        /* –°–∫–∏–Ω—ã –±—É–¥—É—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è —Å –ø–æ–º–æ—â—å—é JS */

        /* --- üì± –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å --- */
        @media (max-width: 600px) {
            .file-item, .folder-item {
                flex-wrap: wrap;
                justify-content: space-between;
            }
            .file-item-name, .folder-item-name, .file-date, .folder-date {
                width: 100%;
                margin-left: 0;
            }
            .file-date, .folder-date {
                text-align: right;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>

    <div id="mainContainer">
        <h1 class="header" style="text-align: center;">Initi: –§–∞–π–ª–æ–≤—ã–π –ú–µ–Ω–µ–¥–∂–µ—Ä</h1>

        <div class="control-panel window">
            <input type="text" id="searchBox" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...">
            <button onclick="navigateUp()">‚¨ÜÔ∏è –í–≤–µ—Ä—Ö</button>
            <button onclick="createItem('folder')">üìÅ –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>
            <button onclick="createItem('file')">üìÑ –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª</button>
            <button onclick="renameItem()">‚úçÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
            <button onclick="deleteItem()">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
            <button onclick="showSkinsModal()">üé® –°–∫–∏–Ω—ã</button>
            <button onclick="showSettingsModal()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <select id="sortSelect" onchange="renderCurrentFolder()">
                <option value="name_asc">–°–æ—Ä—Ç: –ê-–Ø</option>
                <option value="name_desc">–°–æ—Ä—Ç: –Ø-–ê</option>
                <option value="type">–°–æ—Ä—Ç: –¢–∏–ø</option>
                <option value="date_desc">–°–æ—Ä—Ç: –î–∞—Ç–∞ (–ù–æ–≤—ã–µ)</option>
                <option value="date_asc">–°–æ—Ä—Ç: –î–∞—Ç–∞ (–°—Ç–∞—Ä—ã–µ)</option>
            </select>
        </div>

        <div id="pathBar" class="window">–ü—É—Ç—å: /</div>

        <div id="fileSystem" class="window" onclick="selectItem(event)">
            </div>
    </div>

    <div id="fileContentModal" class="modal" onclick="closeModal(event, 'fileContentModal')">
        <div class="modal-content window" onclick="event.stopPropagation()">
            <div class="header" id="fileContentHeader">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞</div>
            <p id="fileContentDate" style="text-align: center; font-size: 12px; margin: 4px 0;"></p>
            <div id="fileContentBody" style="padding: 8px;">
                <div id="textNotesSection">
                    <h3>–ó–∞–º–µ—Ç–∫–∏ üìù</h3>
                    <div id="textNotesList"></div>
                    <button onclick="createTextNote()">+ –°–æ–∑–¥–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
                </div>
                <hr>
                <div id="mediaSection">
                    <h3>–ú–µ–¥–∏–∞ (–§–æ—Ç–æ/–ê—É–¥–∏–æ) üñºÔ∏èüéß</h3>
                    <button onclick="showMediaUploadModal('photo')">üñºÔ∏è –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ</button>
                    <button onclick="showMediaUploadModal('audio')">üéß –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –∞—É–¥–∏–æ</button>
                    <div id="mediaList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;"></div>
                </div>
            </div>
            <div class="control-panel">
                <button onclick="closeFileContentModal()">üíæ –ó–∞–∫—Ä—ã—Ç—å (–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)</button>
            </div>
        </div>
    </div>
    
    <div id="textEditorModal" class="modal" onclick="closeModal(event, 'textEditorModal')">
        <div class="modal-content window" onclick="event.stopPropagation()">
            <div class="header" id="textEditorHeader">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏</div>
            <div id="textEditor" style="padding: 8px;">
                <textarea id="noteContent" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ HTML-–∫–æ–¥..."></textarea>
                <input type="checkbox" id="isHtmlCheckbox"> <label for="isHtmlCheckbox">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ HTML</label>
                <div class="control-panel" style="justify-content: space-between;">
                    <div>
                        <button id="runHtmlButton" onclick="runHtmlDemo()" style="display:none;">üåê –ó–∞–ø—É—Å—Ç–∏—Ç—å HTML-–∫–æ–¥</button>
                    </div>
                    <div>
                        <button onclick="saveTextNote()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button onclick="closeTextEditorModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="htmlDemoModal" class="modal" style="display: none; background-color: white;">
        <iframe id="htmlDemoIframe" style="width: 100%; height: 100%; border: none;"></iframe>
        <button onclick="closeHtmlDemoModal()" style="position: absolute; top: 10px; right: 10px; background-color: red; color: white;">‚úñÔ∏è –í—ã—Ö–æ–¥</button>
    </div>

    <div id="mediaUploadModal" class="modal" onclick="closeModal(event, 'mediaUploadModal')">
        <div class="modal-content window" onclick="event.stopPropagation()">
            <div class="header">–ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞</div>
            <div style="padding: 8px;">
                <p>–í–≤–µ–¥–∏—Ç–µ URL –∏–ª–∏ Base64 –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–∏—Ç–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏:</p>
                <input type="text" id="mediaUrlInput" style="width: 100%; box-sizing: border-box; margin-bottom: 8px;" placeholder="URL –∏–ª–∏ Base64">
                <p style="font-size: 12px; color: red;">*–í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª –±—ã –≤—ã–±–æ—Ä —Ñ–∞–π–ª–∞ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.</p>
                <div class="control-panel">
                    <button onclick="addMediaItem()">‚úÖ –î–æ–±–∞–≤–∏—Ç—å</button>
                    <button onclick="closeMediaUploadModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <div id="photoViewer" ontouchstart="handleTouchStart(event)" ontouchmove="handleTouchMove(event)" ontouchend="handleTouchEnd(event)">
        <img id="photoDisplay" src="" alt="Photo" onclick="closePhotoViewer()">
    </div>

    <div id="settingsModal" class="modal" onclick="closeModal(event, 'settingsModal')">
        <div class="modal-content window" onclick="event.stopPropagation()">
            <div class="header">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –î–∞–Ω–Ω—ã–µ</div>
            <div style="padding: 8px;">
                <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π</h3>
                <button onclick="saveFileSystem()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ .db</button>
                <input type="file" id="loadFileInput" onchange="loadFileSystem(event)" style="display: none;">
                <button onclick="document.getElementById('loadFileInput').click()">‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ .db</button>

                <h3 style="margin-top: 10px;">–û–±–æ–∏ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–∏</h3>
                <input type="text" id="wallpaperInput" placeholder="URL –∏–ª–∏ Base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è" style="width: 100%; box-sizing: border-box; margin-bottom: 8px;">
                <button onclick="applyWallpaper()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–±–æ–∏</button>
                <button onclick="removeWallpaper()">–£–¥–∞–ª–∏—Ç—å –æ–±–æ–∏</button>
            </div>
            <div class="control-panel">
                <button onclick="closeSettingsModal()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>

    <div id="skinsModal" class="modal" onclick="closeModal(event, 'skinsModal')">
        <div class="modal-content window" onclick="event.stopPropagation()">
            <div class="header">üé® –í—ã–±–æ—Ä –°–∫–∏–Ω–∞</div>
            <div style="padding: 8px; display: flex; flex-direction: column; gap: 8px;">
                <button onclick="setSkin('win95')">Windows 95 (–ö–ª–∞—Å—Å–∏–∫–∞)</button>
                <button onclick="setSkin('winxp')">Windows XP (Luna)</button>
                <button onclick="setSkin('win7')">Windows 7 (Aero)</button>
                <button onclick="setSkin('dark')">–ù–µ-Windows (–¢–µ–º–Ω—ã–π)</button>
                <button onclick="setSkin('light')">–ù–µ-Windows (–°–≤–µ—Ç–ª—ã–π)</button>
            </div>
            <div class="control-panel">
                <button onclick="closeSkinsModal()">‚ùå –ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>


    <script>
        // --- ‚öôÔ∏è –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

        let fileSystem = {
            name: 'root',
            type: 'folder',
            children: [],
            path: '/',
            wallpaper: null,
            created: new Date().toISOString()
        };
        let currentPath = '/';
        let selectedItem = null;
        let currentFile = null; // –¢–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π —Ñ–∞–π–ª-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        let currentNoteIndex = null; // –ò–Ω–¥–µ–∫—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π –∑–∞–º–µ—Ç–∫–∏

        // --- üé® –°—Ç–∏–ª–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Å–∫–∏–Ω–æ–≤ ---

        const skins = {
            'win95': {
                '--color-bg': '#c0c0c0', '--color-primary': '#000080', '--color-text': '#000',
                '--color-btn-bg': '#c0c0c0', '--color-btn-border-light': '#fff', '--color-btn-border-dark': '#808080',
                '--color-active': '#000080', '--color-active-text': '#fff', '--color-header-bg': '#000080',
                '--color-header-text': '#fff', '--color-input-bg': '#fff', '--font-family': 'Tahoma, Arial, sans-serif',
                '--shadow-light': '1px 1px #fff', '--shadow-dark': '1px 1px #000'
            },
            'winxp': {
                '--color-bg': '#eff3fb', '--color-primary': '#2a5b9b', '--color-text': '#000',
                '--color-btn-bg': '#e6e6e6', '--color-btn-border-light': '#f0f0f0', '--color-btn-border-dark': '#a3a3a3',
                '--color-active': '#316ac5', '--color-active-text': '#fff', '--color-header-bg': '#003c74',
                '--color-header-text': '#fff', '--color-input-bg': '#fff', '--font-family': 'Tahoma, Arial, sans-serif',
                '--shadow-light': 'none', '--shadow-dark': 'none'
            },
            'win7': {
                '--color-bg': '#d8e4f1', '--color-primary': '#0061b6', '--color-text': '#000',
                '--color-btn-bg': 'linear-gradient(to bottom, #f3f3f3, #e5e5e5)', '--color-btn-border-light': '#ccc', '--color-btn-border-dark': '#999',
                '--color-active': '#1e90ff', '--color-active-text': '#fff', '--color-header-bg': 'linear-gradient(to right, #4a82c4, #2a69b6)',
                '--color-header-text': '#fff', '--color-input-bg': '#fff', '--font-family': 'Segoe UI, Tahoma, Arial, sans-serif',
                '--shadow-light': 'none', '--shadow-dark': '0 1px 2px rgba(0,0,0,0.3)'
            },
            'dark': {
                '--color-bg': '#1e1e1e', '--color-primary': '#007acc', '--color-text': '#fff',
                '--color-btn-bg': '#333', '--color-btn-border-light': '#555', '--color-btn-border-dark': '#111',
                '--color-active': '#007acc', '--color-active-text': '#fff', '--color-header-bg': '#000',
                '--color-header-text': '#fff', '--color-input-bg': '#252526', '--font-family': 'Consolas, monospace',
                '--shadow-light': 'none', '--shadow-dark': '0 2px 5px rgba(0,0,0,0.5)'
            },
            'light': {
                '--color-bg': '#f0f0f0', '--color-primary': '#6a0dad', '--color-text': '#333',
                '--color-btn-bg': '#fff', '--color-btn-border-light': '#ddd', '--color-btn-border-dark': '#bbb',
                '--color-active': '#6a0dad', '--color-active-text': '#fff', '--color-header-bg': '#fff',
                '--color-header-text': '#6a0dad', '--color-input-bg': '#fff', '--font-family': 'Roboto, sans-serif',
                '--shadow-light': '0 1px 3px rgba(0,0,0,0.1)', '--shadow-dark': '0 2px 5px rgba(0,0,0,0.2)'
            }
        };

        function setSkin(skinName) {
            const root = document.documentElement;
            const style = skins[skinName];
            for (const [prop, value] of Object.entries(style)) {
                root.style.setProperty(prop, value);
            }
            localStorage.setItem('initi_skin', skinName);
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π –∫ —ç–ª–µ–º–µ–Ω—Ç–∞–º
            renderCurrentFolder(); 
            updateWallpaper();
        }

        // --- üìÇ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π ---

        function getItemByPath(path) {
            if (path === '/') return fileSystem;
            const parts = path.split('/').filter(p => p);
            let current = fileSystem;
            for (const part of parts) {
                const child = current.children.find(c => c.name === part);
                if (!child) return null;
                current = child;
            }
            return current;
        }

        function getParentPath(path) {
            if (path === '/') return '/';
            const parts = path.split('/').filter(p => p);
            return '/' + parts.slice(0, -1).join('/') + (parts.length > 1 ? '/' : '');
        }

        function renderCurrentFolder(searchQuery = '') {
            const currentFolder = getItemByPath(currentPath);
            const fileSystemDiv = document.getElementById('fileSystem');
            const pathBar = document.getElementById('pathBar');

            if (!currentFolder) {
                currentPath = '/';
                return renderCurrentFolder();
            }

            pathBar.textContent = '–ü—É—Ç—å: ' + currentPath;
            fileSystemDiv.innerHTML = '';
            selectedItem = null;
            updateWallpaper(); // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±–æ–µ–≤

            let items = currentFolder.children || [];
            
            // üîç –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
            if (searchQuery) {
                items = searchFileSystem(searchQuery, fileSystem); // –ò—â–µ–º –ø–æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ
            } else {
                // üóÉÔ∏è –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                const sortType = document.getElementById('sortSelect').value;
                items.sort((a, b) => {
                    if (sortType.startsWith('name')) {
                        return a.name.localeCompare(b.name) * (sortType.endsWith('desc') ? -1 : 1);
                    } else if (sortType === 'type') {
                        return a.type.localeCompare(b.type);
                    } else if (sortType.startsWith('date')) {
                        return new Date(a.created) - new Date(b.created) * (sortType.endsWith('desc') ? -1 : 1);
                    }
                    return 0;
                });
            }

            // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = item.type === 'folder' ? 'folder-item' : 'file-item';
                div.dataset.name = item.name;
                div.dataset.type = item.type;
                div.dataset.path = searchQuery ? item.path : currentPath + item.name + (item.type === 'folder' ? '/' : '');

                const icon = document.createElement('span');
                icon.className = 'icon ' + (item.type === 'folder' ? 'icon-folder' : (item.content.isHtml ? 'icon-html' : 'icon-file'));

                const nameSpan = document.createElement('span');
                nameSpan.className = item.type === 'folder' ? 'folder-item-name' : 'file-item-name';
                nameSpan.textContent = item.name;
                
                const dateSpan = document.createElement('span');
                dateSpan.className = item.type === 'folder' ? 'folder-date' : 'file-date';
                dateSpan.textContent = formatDate(item.created);

                div.appendChild(icon);
                div.appendChild(nameSpan);
                div.appendChild(dateSpan);
                fileSystemDiv.appendChild(div);
            });
        }

        function searchFileSystem(query, node, results = []) {
            if (node.name.toLowerCase().includes(query.toLowerCase()) && node.path !== '/') {
                results.push({ name: node.name, type: node.type, path: node.path, created: node.created, content: node.content });
            }
            
            if (node.children) {
                node.children.forEach(child => {
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞
                    const childPath = node.path + child.name + (child.type === 'folder' ? '/' : '');
                    searchFileSystem(query, { ...child, path: childPath }, results);
                });
            }
            return results;
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            const options = { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            return date.toLocaleDateString('ru-RU', options);
        }

        function navigateTo(path) {
            currentPath = path;
            renderCurrentFolder();
        }

        function navigateUp() {
            const parentPath = getParentPath(currentPath);
            navigateTo(parentPath);
        }

        function selectItem(event) {
            const itemElement = event.target.closest('.file-item, .folder-item');
            if (!itemElement) return;

            // –°–±—Ä–æ—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –≤—ã–±–æ—Ä–∞
            if (selectedItem) {
                selectedItem.classList.remove('selected');
            }
            
            // –í—ã–±–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
            selectedItem = itemElement;
            selectedItem.classList.add('selected');

            // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫/—Ç–∞–ø –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è
            if (event.detail === 2 || event.type === 'click') {
                const name = itemElement.dataset.name;
                const type = itemElement.dataset.type;
                
                if (type === 'folder') {
                    navigateTo(currentPath + name + '/');
                } else if (type === 'file') {
                    openFileContent(currentPath + name);
                }
            }
        }

        function createItem(type) {
            const currentFolder = getItemByPath(currentPath);
            let name = prompt(`–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –Ω–æ–≤–æ–π ${type === 'folder' ? '–ø–∞–ø–∫–∏' : '—Ñ–∞–π–ª–∞'}:`);
            
            if (!name || currentFolder.children.some(c => c.name === name)) {
                alert('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                return;
            }

            const newItem = {
                name: name,
                type: type,
                created: new Date().toISOString(),
                children: type === 'folder' ? [] : undefined,
                content: type === 'file' ? { notes: [], media: [], isHtml: false } : undefined
            };

            currentFolder.children.push(newItem);
            saveState();
            renderCurrentFolder();
        }
        
        function renameItem() {
            if (!selectedItem) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ —Ñ–∞–π–ª –¥–ª—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è.');
                return;
            }

            const oldName = selectedItem.dataset.name;
            const newName = prompt(`–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å "${oldName}" –≤:`);

            if (!newName || newName === oldName) return;

            const currentFolder = getItemByPath(getParentPath(selectedItem.dataset.path));
            const item = currentFolder.children.find(c => c.name === oldName);

            if (item) {
                item.name = newName;
                saveState();
                // –ü—Ä–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–∏ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–∏, –æ–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç—å
                if (currentPath.endsWith(oldName + '/')) {
                    currentPath = getParentPath(currentPath) + newName + '/';
                }
                renderCurrentFolder();
            }
        }

        function deleteItem() {
            if (!selectedItem) {
                alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø–∞–ø–∫—É –∏–ª–∏ —Ñ–∞–π–ª –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.');
                return;
            }

            const name = selectedItem.dataset.name;
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å "${name}"?`)) {
                const currentFolder = getItemByPath(getParentPath(selectedItem.dataset.path));
                currentFolder.children = currentFolder.children.filter(c => c.name !== name);
                saveState();
                renderCurrentFolder();
            }
        }
        
        // --- üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –ó–∞–≥—Ä—É–∑–∫–∞ ---

        function saveState() {
            localStorage.setItem('initi_fs', JSON.stringify(fileSystem));
        }

        function loadState() {
            const savedFs = localStorage.getItem('initi_fs');
            const savedSkin = localStorage.getItem('initi_skin') || 'win95';
            const savedWallpaper = localStorage.getItem('initi_wallpaper');

            if (savedFs) {
                fileSystem = JSON.parse(savedFs);
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–∏–Ω–∞ –∏ –æ–±–æ–µ–≤
            setSkin(savedSkin);
            if (savedWallpaper) {
                fileSystem.wallpaper = savedWallpaper;
                updateWallpaper();
            }

            renderCurrentFolder();
        }

        function saveFileSystem() {
            // –°–æ–∑–¥–∞–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ 20092025-12-45-32
            const now = new Date();
            const dateStr = [
                now.getFullYear(), 
                (now.getMonth() + 1).toString().padStart(2, '0'), 
                now.getDate().toString().padStart(2, '0')
            ].join('');
            const timeStr = [
                now.getHours().toString().padStart(2, '0'),
                now.getMinutes().toString().padStart(2, '0'),
                now.getSeconds().toString().padStart(2, '0')
            ].join('-');
            const filename = `${dateStr}-${timeStr}.db`;

            const fsData = JSON.stringify(fileSystem);
            const blob = new Blob([fsData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            alert(`–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∫–∞–∫ "${filename}"`);
            closeSettingsModal();
        }

        function loadFileSystem(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedFs = JSON.parse(e.target.result);
                    if (loadedFs && loadedFs.name === 'root') {
                        fileSystem = loadedFs;
                        saveState(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –≤ localStorage
                        currentPath = '/';
                        loadState(); // –û–±–Ω–æ–≤–ª—è–µ–º UI —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
                        alert(`–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ "${file.name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.`);
                    } else {
                        alert('–û—à–∏–±–∫–∞: –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º —Ñ–∞–π–ª–æ–º Initi (.db).');
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // --- üñºÔ∏è –û–±–æ–∏ –ö–æ—Ä–Ω–µ–≤–æ–π –ü–∞–ø–∫–∏ ---
        
        function updateWallpaper() {
            const fileSystemDiv = document.getElementById('fileSystem');
            const root = getItemByPath('/');

            if (root.wallpaper) {
                fileSystemDiv.style.backgroundImage = `url('${root.wallpaper}')`;
                fileSystemDiv.classList.add('has-wallpaper');
            } else {
                fileSystemDiv.style.backgroundImage = 'none';
                fileSystemDiv.classList.remove('has-wallpaper');
            }
        }

        function applyWallpaper() {
            const url = document.getElementById('wallpaperInput').value.trim();
            const root = getItemByPath('/');
            if (url) {
                root.wallpaper = url;
                localStorage.setItem('initi_wallpaper', url);
                alert('–û–±–æ–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –û–Ω–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ –∫–æ—Ä–Ω–µ–≤–æ–π –ø–∞–ø–∫–µ.');
            } else {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ URL –∏–ª–∏ Base64 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.');
            }
            saveState();
            updateWallpaper();
            closeSettingsModal();
        }
        
        function removeWallpaper() {
            const root = getItemByPath('/');
            root.wallpaper = null;
            localStorage.removeItem('initi_wallpaper');
            alert('–û–±–æ–∏ —É–¥–∞–ª–µ–Ω—ã.');
            saveState();
            updateWallpaper();
            closeSettingsModal();
        }

        // --- üìù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º—ã–º —Ñ–∞–π–ª–∞-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ---

        function openFileContent(path) {
            currentFile = getItemByPath(path);
            if (!currentFile || currentFile.type !== 'file') return;

            document.getElementById('fileContentHeader').textContent = currentFile.name;
            document.getElementById('fileContentDate').textContent = '–°–æ–∑–¥–∞–Ω: ' + formatDate(currentFile.created);
            
            // –ï—Å–ª–∏ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç HTML, –∫–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–∏–¥–Ω–∞
            if (currentFile.content.isHtml) {
                // ... (–≠—Ç–æ—Ç –∫–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –ª–æ–≥–∏–∫–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, –Ω–µ –∑–¥–µ—Å—å)
            }

            renderFileContent();
            document.getElementById('fileContentModal').style.display = 'flex';
        }

        function renderFileContent() {
            const noteListDiv = document.getElementById('textNotesList');
            const mediaListDiv = document.getElementById('mediaList');
            noteListDiv.innerHTML = '';
            mediaListDiv.innerHTML = '';

            // –ó–∞–º–µ—Ç–∫–∏
            currentFile.content.notes.forEach((note, index) => {
                const div = document.createElement('div');
                div.style.border = '1px solid #ccc';
                div.style.padding = '5px';
                div.style.marginBottom = '5px';
                div.style.backgroundColor = '#f9f9f9';

                const header = document.createElement('div');
                header.textContent = `–ó–∞–º–µ—Ç–∫–∞ #${index + 1}` + (note.isHtml ? ' (HTML)' : ' (–¢–µ–∫—Å—Ç)');
                header.style.fontWeight = 'bold';
                div.appendChild(header);

                const contentPreview = document.createElement('p');
                contentPreview.textContent = note.content.substring(0, 50) + '...';
                contentPreview.style.margin = '4px 0';
                div.appendChild(contentPreview);

                const editBtn = document.createElement('button');
                editBtn.textContent = '‚úçÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
                editBtn.onclick = () => editTextNote(index);
                div.appendChild(editBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '‚ùå –£–¥–∞–ª–∏—Ç—å';
                deleteBtn.onclick = () => deleteTextNote(index);
                div.appendChild(deleteBtn);
                
                if (note.isHtml) {
                    const runBtn = document.createElement('button');
                    runBtn.textContent = 'üåê –ó–∞–ø—É—Å—Ç–∏—Ç—å';
                    runBtn.onclick = () => runHtmlDemo(note.content);
                    div.appendChild(runBtn);
                }

                noteListDiv.appendChild(div);
            });

            // –ú–µ–¥–∏–∞
            currentFile.content.media.forEach((media, index) => {
                const div = document.createElement('div');
                div.style.position = 'relative';
                div.style.width = '80px';
                div.style.height = '80px';
                div.style.overflow = 'hidden';

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '‚ùå';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '0';
                deleteBtn.style.right = '0';
                deleteBtn.style.fontSize = '8px';
                deleteBtn.style.padding = '0 3px';
                deleteBtn.onclick = (e) => { e.stopPropagation(); deleteMediaItem(index); };
                div.appendChild(deleteBtn);

                if (media.type === 'photo') {
                    const img = document.createElement('img');
                    img.src = media.url;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    img.onclick = () => openPhotoViewer(index);
                    div.appendChild(img);
                } else if (media.type === 'audio') {
                    const audioIcon = document.createElement('div');
                    audioIcon.textContent = 'üéß –ê—É–¥–∏–æ';
                    audioIcon.style.textAlign = 'center';
                    audioIcon.style.paddingTop = '20px';
                    audioIcon.style.backgroundColor = '#ddd';
                    audioIcon.style.height = '100%';
                    audioIcon.onclick = () => {
                        const audio = new Audio(media.url);
                        audio.play().catch(e => alert('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∞—É–¥–∏–æ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç/URL).'));
                    };
                    div.appendChild(audioIcon);
                }
                mediaListDiv.appendChild(div);
            });
        }

        function closeFileContentModal() {
            saveState(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
            currentFile = null;
            document.getElementById('fileContentModal').style.display = 'none';
        }

        // --- –ó–∞–º–µ—Ç–∫–∏ ---

        function createTextNote() {
            currentNoteIndex = null;
            document.getElementById('noteContent').value = '';
            document.getElementById('isHtmlCheckbox').checked = false;
            document.getElementById('textEditorHeader').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–º–µ—Ç–∫–∏';
            document.getElementById('runHtmlButton').style.display = 'none';
            document.getElementById('textEditorModal').style.display = 'flex';
        }

        function editTextNote(index) {
            currentNoteIndex = index;
            const note = currentFile.content.notes[index];
            document.getElementById('noteContent').value = note.content;
            document.getElementById('isHtmlCheckbox').checked = note.isHtml;
            document.getElementById('textEditorHeader').textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ #${index + 1}`;
            
            const runButton = document.getElementById('runHtmlButton');
            runButton.style.display = note.isHtml ? 'inline-block' : 'none';
            runButton.onclick = () => runHtmlDemo(note.content);

            document.getElementById('textEditorModal').style.display = 'flex';
        }

        function saveTextNote() {
            const content = document.getElementById('noteContent').value;
            const isHtml = document.getElementById('isHtmlCheckbox').checked;

            if (content.trim() === '') {
                alert('–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–º–µ—Ç–∫–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.');
                return;
            }

            const newNote = { content: content, isHtml: isHtml };

            if (currentNoteIndex !== null) {
                currentFile.content.notes[currentNoteIndex] = newNote;
            } else {
                currentFile.content.notes.push(newNote);
            }
            
            closeTextEditorModal();
            renderFileContent();
            saveState(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        }

        function deleteTextNote(index) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É #${index + 1}?`)) {
                currentFile.content.notes.splice(index, 1);
                renderFileContent();
                saveState(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            }
        }
        
        function closeTextEditorModal() {
            document.getElementById('textEditorModal').style.display = 'none';
        }
        
        // --- –ó–∞–ø—É—Å–∫ HTML ---
        
        function runHtmlDemo(htmlContent = null) {
            const content = htmlContent || document.getElementById('noteContent').value;
            const iframe = document.getElementById('htmlDemoIframe');
            
            // –°–æ–∑–¥–∞–µ–º HTML-–¥–æ–∫—É–º–µ–Ω—Ç —Å —Å–æ–¥–µ—Ä–∂–∏–º—ã–º
            const htmlDoc = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>HTML Demo</title>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `;

            iframe.srcdoc = htmlDoc;
            document.getElementById('htmlDemoModal').style.display = 'flex';
            closeTextEditorModal(); // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
        }

        function closeHtmlDemoModal() {
            document.getElementById('htmlDemoModal').style.display = 'none';
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –æ—Ç–∫—Ä—ã—Ç
            if (currentNoteIndex !== null) {
                 document.getElementById('textEditorModal').style.display = 'flex';
            } else if (currentFile) {
                 // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –∑–∞–ø—É—Å–∫ –∏–∑ —Å–ø–∏—Å–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ —Ñ–∞–π–ª
                 document.getElementById('fileContentModal').style.display = 'flex';
            }
        }


        // --- –ú–µ–¥–∏–∞ ---

        let currentMediaType = '';

        function showMediaUploadModal(type) {
            currentMediaType = type;
            document.getElementById('mediaUploadModal').style.display = 'flex';
        }

        function addMediaItem() {
            const url = document.getElementById('mediaUrlInput').value.trim();
            if (url) {
                currentFile.content.media.push({
                    type: currentMediaType,
                    url: url
                });
                document.getElementById('mediaUrlInput').value = '';
                closeMediaUploadModal();
                renderFileContent();
                saveState(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            } else {
                alert('–í–≤–µ–¥–∏—Ç–µ URL –∏–ª–∏ Base64 –¥–∞–Ω–Ω—ã—Ö.');
            }
        }

        function deleteMediaItem(index) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å ${currentFile.content.media[index].type === 'photo' ? '—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é' : '–∞—É–¥–∏–æ–∑–∞–ø–∏—Å—å'}?`)) {
                currentFile.content.media.splice(index, 1);
                renderFileContent();
                saveState(); // –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            }
        }

        function closeMediaUploadModal() {
            document.getElementById('mediaUploadModal').style.display = 'none';
        }

        // --- üñºÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä –§–æ—Ç–æ —Å –°–≤–∞–π–ø–æ–º ---

        let photoIndex = 0;
        let startX = 0;
        const photoViewer = document.getElementById('photoViewer');
        const photoDisplay = document.getElementById('photoDisplay');

        function openPhotoViewer(index) {
            const photos = currentFile.content.media.filter(m => m.type === 'photo');
            if (photos.length === 0) return;

            photoIndex = photos.findIndex(m => m === currentFile.content.media[index]);
            
            photoDisplay.src = photos[photoIndex].url;
            photoViewer.style.display = 'flex';
            photoViewer.focus(); // –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–±—ã—Ç–∏–π
        }

        function closePhotoViewer() {
            photoViewer.style.display = 'none';
        }

        function showNextPhoto(direction) {
            const photos = currentFile.content.media.filter(m => m.type === 'photo');
            if (photos.length <= 1) return;

            photoIndex += direction;
            if (photoIndex >= photos.length) photoIndex = 0;
            if (photoIndex < 0) photoIndex = photos.length - 1;

            photoDisplay.src = photos[photoIndex].url;
        }

        function handleTouchStart(e) {
            startX = e.touches[0].clientX;
        }

        function handleTouchMove(e) {
            if (e.touches.length > 1) return; // –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å –º—É–ª—å—Ç–∏—Ç–∞—á
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞ —Å–≤–∞–π–ø–µ
            // e.preventDefault(); 
        }

        function handleTouchEnd(e) {
            const endX = e.changedTouches[0].clientX;
            const diffX = endX - startX;
            
            // –ï—Å–ª–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–∏–ª—å–Ω—ã–π
            if (Math.abs(diffX) > 50) {
                if (diffX > 0) {
                    showNextPhoto(-1); // –°–≤–∞–π–ø –≤–ø—Ä–∞–≤–æ -> –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ñ–æ—Ç–æ
                } else {
                    showNextPhoto(1); // –°–≤–∞–π–ø –≤–ª–µ–≤–æ -> —Å–ª–µ–¥—É—é—â–µ–µ —Ñ–æ—Ç–æ
                }
            } else if (e.target === photoDisplay) {
                // –ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ–π —Ç–∞–ø –ø–æ —Ñ–æ—Ç–æ, –∑–∞–∫—Ä—ã–≤–∞–µ–º (–∫–∞–∫ –ø–æ –∑–∞–¥–∞–Ω–∏—é)
                closePhotoViewer();
            }
        }


        // --- üîç –ü–æ–∏—Å–∫ ---

        document.getElementById('searchBox').addEventListener('input', function(e) {
            const query = e.target.value.trim();
            if (query.length > 0) {
                renderCurrentFolder(query);
            } else {
                renderCurrentFolder();
            }
        });

        // --- ‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ú–æ–¥–∞–ª—å–Ω—ã–º–∏ –û–∫–Ω–∞–º–∏ ---
        
        function closeModal(event, id) {
            if (event.target.id === id) {
                document.getElementById(id).style.display = 'none';
            }
        }
        
        function showSettingsModal() {
            const root = getItemByPath('/');
            document.getElementById('wallpaperInput').value = root.wallpaper || '';
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function showSkinsModal() {
            document.getElementById('skinsModal').style.display = 'flex';
        }
        
        function closeSkinsModal() {
            document.getElementById('skinsModal').style.display = 'none';
        }

        // --- üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–º—ã ---

        window.onload = loadState;
        
        // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–≤–∞–π–ø–∞ –Ω–∞ –≤–µ—Å—å –≤—å—é–ø–æ—Ä—Ç (—á—Ç–æ–±—ã —Å–≤–∞–π–ø –Ω–µ –º–µ—à–∞–ª —Å–∫—Ä–æ–ª–ª—É)
        const photoViewerElement = document.getElementById('photoViewer');
        photoViewerElement.addEventListener('touchstart', handleTouchStart);
        photoViewerElement.addEventListener('touchmove', handleTouchMove);
        photoViewerElement.addEventListener('touchend', handleTouchEnd);


    </script>
</body>
</html>