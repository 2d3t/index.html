<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Manager with Audio Notes</title>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --border-radius: 4px;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo i {
            font-size: 1.8rem;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background-color: white;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .breadcrumb {
            padding: 15px;
            background-color: var(--light-color);
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .breadcrumb-item:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .breadcrumb-separator {
            color: #7f8c8d;
        }

        .search-container {
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }

        .search-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }

        .search-options {
            display: flex;
            margin-top: 10px;
            gap: 10px;
        }

        .search-option {
            flex: 1;
            text-align: center;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .search-option.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .actions {
            padding: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            border-bottom: 1px solid #ddd;
        }

        .btn {
            padding: 10px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .file-item {
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 1px solid #f0f0f0;
        }

        .file-item:hover {
            background-color: rgba(0,0,0,0.03);
        }

        .file-item.selected {
            background-color: rgba(52, 152, 219, 0.1);
        }

        .file-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-actions {
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: var(--transition);
        }

        .file-item:hover .file-actions {
            opacity: 1;
        }

        .file-action {
            background: none;
            border: none;
            cursor: pointer;
            color: #7f8c8d;
            font-size: 0.9rem;
            transition: var(--transition);
        }

        .file-action:hover {
            color: var(--primary-color);
        }

        .editor {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
            overflow: hidden;
        }

        .editor-header {
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .audio-recorder {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .recorder-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .record-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: #e74c3c;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .record-btn.recording {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .timer {
            font-size: 1.2rem;
            font-weight: bold;
            font-family: monospace;
        }

        .audio-player {
            width: 100%;
            margin: 10px 0;
        }

        .textarea-editor {
            width: 100%;
            height: 300px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: monospace;
            resize: vertical;
        }

        .media-attachments {
            margin-top: 20px;
        }

        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .media-item {
            position: relative;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
        }

        .media-item:hover {
            transform: translateY(-5px);
        }

        .media-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .media-item audio {
            width: 100%;
        }

        .media-actions {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: var(--transition);
        }

        .media-item:hover .media-actions {
            opacity: 1;
        }

        .media-action {
            background-color: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .zoom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        .zoom-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .zoomed-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }

        .close-zoom {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #7f8c8d;
            text-align: center;
            padding: 20px;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .context-menu {
            position: fixed;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            z-index: 50;
            display: none;
        }

        .context-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition);
        }

        .context-menu-item:hover {
            background-color: rgba(0,0,0,0.05);
        }

        .status-bar {
            padding: 10px 20px;
            background-color: var(--light-color);
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            width: 400px;
            max-width: 90%;
            box-shadow: var(--shadow);
        }

        .modal-header {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #7f8c8d;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 40%;
            }
            
            .actions {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i>📁</i>
            <span>File Manager with Audio Notes</span>
        </div>
        <div class="header-actions">
            <button class="btn btn-primary" id="saveSystemBtn">
                <i>💾</i> Save System
            </button>
            <button class="btn btn-warning" id="loadSystemBtn">
                <i>📂</i> Load System
            </button>
            <button class="btn btn-danger" id="exitBtn">
                <i>🚪</i> Exit
            </button>
        </div>
    </header>

    <div class="main-container">
        <div class="sidebar">
            <div class="breadcrumb" id="breadcrumb">
                <!-- Breadcrumb will be populated by JavaScript -->
            </div>
            
            <div class="search-container">
                <input type="text" class="search-box" id="searchInput" placeholder="Search files...">
                <div class="search-options">
                    <div class="search-option active" id="localSearch">Current Folder</div>
                    <div class="search-option" id="globalSearch">All Files</div>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn btn-primary" id="backBtn">
                    <i>⬅️</i> Back
                </button>
                <button class="btn btn-primary" id="newFolderBtn">
                    <i>📁</i> New Folder
                </button>
                <button class="btn btn-primary" id="newFileBtn">
                    <i>📄</i> New File
                </button>
                <button class="btn btn-success" id="recordAudioBtn">
                    <i>🎙️</i> Record Audio
                </button>
            </div>
            
            <div class="file-list" id="fileList">
                <!-- File list will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="editor">
            <div class="editor-header">
                <h3 id="editorTitle">Select a file to edit</h3>
                <div class="editor-actions" id="editorActions">
                    <!-- Editor actions will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="editor-content" id="editorContent">
                <div class="empty-state">
                    <i>📁</i>
                    <h3>No file selected</h3>
                    <p>Select a file from the sidebar or create a new one to start editing.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-message" id="statusMessage">Ready</div>
        <div class="auto-save" id="autoSaveStatus">Auto-save: On</div>
    </div>

    <!-- Zoom Overlay -->
    <div class="zoom-overlay" id="zoomOverlay">
        <button class="close-zoom" id="closeZoom">×</button>
        <img class="zoomed-image" id="zoomedImage" src="" alt="Zoomed image">
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" id="renameContextItem">Rename</div>
        <div class="context-menu-item" id="deleteContextItem">Delete</div>
    </div>

    <!-- Modals -->
    <div class="modal" id="newFolderModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New Folder</div>
                <button class="close-modal" id="closeNewFolderModal">×</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="folderNameInput">Folder Name</label>
                <input type="text" class="form-input" id="folderNameInput" placeholder="Enter folder name">
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" id="createFolderBtn">Create</button>
                <button class="btn" id="cancelFolderBtn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="newFileModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create New File</div>
                <button class="close-modal" id="closeNewFileModal">×</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="fileNameInput">File Name</label>
                <input type="text" class="form-input" id="fileNameInput" placeholder="Enter file name">
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" id="createFileBtn">Create</button>
                <button class="btn" id="cancelFileBtn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="renameModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Rename</div>
                <button class="close-modal" id="closeRenameModal">×</button>
            </div>
            <div class="form-group">
                <label class="form-label" for="renameInput">New Name</label>
                <input type="text" class="form-input" id="renameInput" placeholder="Enter new name">
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" id="confirmRenameBtn">Rename</button>
                <button class="btn" id="cancelRenameBtn">Cancel</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Confirm Delete</div>
                <button class="close-modal" id="closeDeleteModal">×</button>
            </div>
            <div class="form-group">
                <p id="deleteMessage">Are you sure you want to delete this item?</p>
            </div>
            <div class="form-actions">
                <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                <button class="btn" id="cancelDeleteBtn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // File System Architecture
        let fileSystem = {
            'root': {
                type: 'folder',
                children: {
                    'Documents': {
                        type: 'folder',
                        children: {
                            'notes.txt': {
                                type: 'file',
                                content: 'This is a sample text file.\nYou can edit this content.'
                            }
                        }
                    },
                    'Audio Notes': {
                        type: 'folder',
                        children: {}
                    }
                }
            }
        };

        let fileMeta = {
            'root/Documents/notes.txt': {
                createdAt: new Date().toISOString(),
                type: 'regular'
            }
        };

        let currentPath = ['root'];
        let currentFile = null;
        let isRecording = false;
        let mediaRecorder = null;
        let recordedChunks = [];
        let recordingTimer = null;
        let recordingSeconds = 0;
        let searchMode = 'local'; // 'local' or 'global'
        let contextMenuTarget = null;

        // DOM Elements
        const breadcrumbEl = document.getElementById('breadcrumb');
        const fileListEl = document.getElementById('fileList');
        const editorTitleEl = document.getElementById('editorTitle');
        const editorContentEl = document.getElementById('editorContent');
        const editorActionsEl = document.getElementById('editorActions');
        const searchInputEl = document.getElementById('searchInput');
        const localSearchEl = document.getElementById('localSearch');
        const globalSearchEl = document.getElementById('globalSearch');
        const statusMessageEl = document.getElementById('statusMessage');
        const autoSaveStatusEl = document.getElementById('autoSaveStatus');
        const zoomOverlayEl = document.getElementById('zoomOverlay');
        const zoomedImageEl = document.getElementById('zoomedImage');
        const closeZoomEl = document.getElementById('closeZoom');
        const contextMenuEl = document.getElementById('contextMenu');
        const renameContextItemEl = document.getElementById('renameContextItem');
        const deleteContextItemEl = document.getElementById('deleteContextItem');

        // Modal Elements
        const newFolderModalEl = document.getElementById('newFolderModal');
        const newFileModalEl = document.getElementById('newFileModal');
        const renameModalEl = document.getElementById('renameModal');
        const deleteModalEl = document.getElementById('deleteModal');

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            renderFileList();
            renderBreadcrumb();
            setupEventListeners();
            startAutoSave();
        });

        // Core File System Operations
        function getFolderByPath(path) {
            let current = fileSystem;
            for (const segment of path) {
                if (current[segment] && current[segment].type === 'folder') {
                    current = current[segment].children;
                } else {
                    return null;
                }
            }
            return current;
        }

        function getCurrentFolder() {
            return getFolderByPath(currentPath);
        }

        function renderFileList(searchTerm = '') {
            const currentFolder = getCurrentFolder();
            fileListEl.innerHTML = '';

            if (!currentFolder) {
                fileListEl.innerHTML = '<div class="empty-state"><i>❌</i><h3>Folder not found</h3></div>';
                return;
            }

            const items = Object.keys(currentFolder).sort((a, b) => {
                const aIsFolder = currentFolder[a].type === 'folder';
                const bIsFolder = currentFolder[b].type === 'folder';
                
                if (aIsFolder && !bIsFolder) return -1;
                if (!aIsFolder && bIsFolder) return 1;
                return a.localeCompare(b);
            });

            // Filter items based on search term
            const filteredItems = searchTerm ? 
                items.filter(item => {
                    if (searchMode === 'local') {
                        return item.toLowerCase().includes(searchTerm.toLowerCase());
                    } else {
                        // Global search - would need to implement findAllMatches
                        return item.toLowerCase().includes(searchTerm.toLowerCase());
                    }
                }) : items;

            if (filteredItems.length === 0) {
                fileListEl.innerHTML = '<div class="empty-state"><i>🔍</i><h3>No files found</h3><p>Try a different search term</p></div>';
                return;
            }

            filteredItems.forEach(itemName => {
                const item = currentFolder[itemName];
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.dataset.name = itemName;
                
                let icon = '📄';
                if (item.type === 'folder') {
                    icon = '📁';
                } else if (itemName.endsWith('.audio.txt')) {
                    icon = '🎵';
                }
                
                fileItem.innerHTML = `
                    <div class="file-icon">${icon}</div>
                    <div class="file-name">${itemName}</div>
                    <div class="file-actions">
                        <button class="file-action rename-btn" title="Rename">✏️</button>
                        <button class="file-action delete-btn" title="Delete">🗑️</button>
                    </div>
                `;
                
                fileItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('file-action')) {
                        if (item.type === 'folder') {
                            navigateToFolder(itemName);
                        } else {
                            openFile(itemName);
                        }
                    }
                });
                
                // Add context menu
                fileItem.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e, itemName);
                });
                
                fileListEl.appendChild(fileItem);
            });
        }

        function renderBreadcrumb() {
            breadcrumbEl.innerHTML = '';
            
            currentPath.forEach((segment, index) => {
                const breadcrumbItem = document.createElement('div');
                breadcrumbItem.className = 'breadcrumb-item';
                breadcrumbItem.textContent = segment === 'root' ? 'Home' : segment;
                breadcrumbItem.addEventListener('click', () => {
                    navigateToPath(currentPath.slice(0, index + 1));
                });
                
                breadcrumbEl.appendChild(breadcrumbItem);
                
                if (index < currentPath.length - 1) {
                    const separator = document.createElement('div');
                    separator.className = 'breadcrumb-separator';
                    separator.textContent = '>';
                    breadcrumbEl.appendChild(separator);
                }
            });
        }

        function navigateToFolder(folderName) {
            currentPath.push(folderName);
            renderFileList();
            renderBreadcrumb();
            clearEditor();
        }

        function navigateToPath(path) {
            currentPath = path;
            renderFileList();
            renderBreadcrumb();
            clearEditor();
        }

        function openFile(fileName) {
            const currentFolder = getCurrentFolder();
            if (!currentFolder || !currentFolder[fileName]) return;
            
            currentFile = {
                name: fileName,
                path: [...currentPath, fileName].join('/'),
                content: currentFolder[fileName].content,
                type: currentFolder[fileName].type
            };
            
            editorTitleEl.textContent = fileName;
            
            if (fileName.endsWith('.audio.txt')) {
                showAudioNoteInterface(currentFolder[fileName].content, currentFile.path);
            } else {
                showRegularFileInterface(currentFolder[fileName].content, currentFile.path);
            }
        }

        function showRegularFileInterface(content, path) {
            editorContentEl.innerHTML = `
                <div class="form-group">
                    <label class="form-label" for="fileContent">File Content</label>
                    <textarea class="textarea-editor" id="fileContent">${content || ''}</textarea>
                </div>
                <div class="media-attachments">
                    <h4>Media Attachments</h4>
                    <div class="media-grid" id="mediaGrid">
                        ${renderMediaAttachments(fileMeta[path]?.attachments || [])}
                    </div>
                    <div class="form-actions" style="margin-top: 15px;">
                        <button class="btn btn-primary" id="addImageBtn">
                            <i>🖼️</i> Add Image
                        </button>
                        <button class="btn btn-primary" id="addAudioBtn">
                            <i>🎵</i> Add Audio
                        </button>
                        <button class="btn btn-success" id="saveFileBtn">
                            <i>💾</i> Save File
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('saveFileBtn').addEventListener('click', saveFileContent);
            document.getElementById('addImageBtn').addEventListener('click', () => triggerFileInput('image'));
            document.getElementById('addAudioBtn').addEventListener('click', () => triggerFileInput('audio'));
            
            editorActionsEl.innerHTML = `
                <button class="btn btn-primary" id="copyContentBtn">
                    <i>📋</i> Copy to KlikEdit
                </button>
            `;
            
            document.getElementById('copyContentBtn').addEventListener('click', copyToKlikEdit);
        }

        function showAudioNoteInterface(content, path) {
            const meta = fileMeta[path] || {};
            const audioData = meta.audioData || '';
            
            editorContentEl.innerHTML = `
                <div class="audio-recorder">
                    <h4>Audio Recording</h4>
                    <div class="recorder-controls">
                        <button class="record-btn" id="recordBtn">
                            <i>🎙️</i>
                        </button>
                        <div class="timer" id="recordingTimer">00:00</div>
                        <button class="btn btn-primary" id="stopRecordBtn" disabled>
                            <i>⏹️</i> Stop
                        </button>
                    </div>
                    ${audioData ? `
                        <div class="audio-player-container">
                            <h4>Recorded Audio</h4>
                            <audio class="audio-player" controls>
                                <source src="${audioData}" type="audio/webm">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    ` : ''}
                </div>
                <div class="form-group">
                    <label class="form-label" for="audioNotes">Notes</label>
                    <textarea class="textarea-editor" id="audioNotes">${content || ''}</textarea>
                </div>
                <div class="media-attachments">
                    <h4>Media Attachments</h4>
                    <div class="media-grid" id="mediaGrid">
                        ${renderMediaAttachments(meta.attachments || [])}
                    </div>
                    <div class="form-actions" style="margin-top: 15px;">
                        <button class="btn btn-primary" id="addImageBtn">
                            <i>🖼️</i> Add Image
                        </button>
                        <button class="btn btn-primary" id="addAudioBtn">
                            <i>🎵</i> Add Audio
                        </button>
                        <button class="btn btn-success" id="saveAudioNoteBtn">
                            <i>💾</i> Save Audio Note
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('recordBtn').addEventListener('click', startRecording);
            document.getElementById('stopRecordBtn').addEventListener('click', stopRecording);
            document.getElementById('saveAudioNoteBtn').addEventListener('click', saveAudioNote);
            document.getElementById('addImageBtn').addEventListener('click', () => triggerFileInput('image'));
            document.getElementById('addAudioBtn').addEventListener('click', () => triggerFileInput('audio'));
            
            editorActionsEl.innerHTML = `
                <button class="btn btn-primary" id="copyNotesBtn">
                    <i>📋</i> Copy Notes to KlikEdit
                </button>
            `;
            
            document.getElementById('copyNotesBtn').addEventListener('click', copyToKlikEdit);
        }

        function renderMediaAttachments(attachments) {
            if (!attachments || attachments.length === 0) {
                return '<p>No media attachments</p>';
            }
            
            return attachments.map((attachment, index) => {
                if (attachment.type === 'image') {
                    return `
                        <div class="media-item">
                            <img src="${attachment.data}" alt="Attachment ${index + 1}">
                            <div class="media-actions">
                                <button class="media-action zoom-btn" data-index="${index}">🔍</button>
                                <button class="media-action delete-media-btn" data-index="${index}">🗑️</button>
                            </div>
                        </div>
                    `;
                } else if (attachment.type === 'audio') {
                    return `
                        <div class="media-item">
                            <audio controls>
                                <source src="${attachment.data}" type="audio/webm">
                                Your browser does not support the audio element.
                            </audio>
                            <div class="media-actions">
                                <button class="media-action delete-media-btn" data-index="${index}">🗑️</button>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Audio Recording System
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        recordedChunks.push(e.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(recordedChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.onload = () => {
                        // Store the base64 audio data
                        if (currentFile) {
                            if (!fileMeta[currentFile.path]) {
                                fileMeta[currentFile.path] = {};
                            }
                            fileMeta[currentFile.path].audioData = reader.result;
                        }
                    };
                    reader.readAsDataURL(audioBlob);
                    
                    // Update UI to show the audio player
                    if (currentFile && currentFile.name.endsWith('.audio.txt')) {
                        showAudioNoteInterface(
                            document.getElementById('audioNotes')?.value || '',
                            currentFile.path
                        );
                    }
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // Update UI
                document.getElementById('recordBtn').classList.add('recording');
                document.getElementById('stopRecordBtn').disabled = false;
                
                // Start timer
                recordingSeconds = 0;
                updateRecordingTimer();
                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    updateRecordingTimer();
                    
                    // Auto-stop after 30 seconds
                    if (recordingSeconds >= 30) {
                        stopRecording();
                    }
                }, 1000);
                
                statusMessageEl.textContent = 'Recording audio...';
            } catch (error) {
                console.error('Error starting recording:', error);
                statusMessageEl.textContent = 'Error: Could not access microphone';
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // Stop all tracks
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                // Update UI
                document.getElementById('recordBtn').classList.remove('recording');
                document.getElementById('stopRecordBtn').disabled = true;
                
                // Clear timer
                clearInterval(recordingTimer);
                
                statusMessageEl.textContent = 'Recording stopped';
            }
        }

        function updateRecordingTimer() {
            const minutes = Math.floor(recordingSeconds / 60);
            const seconds = recordingSeconds % 60;
            document.getElementById('recordingTimer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function saveAudioNote() {
            if (!currentFile) return;
            
            const notes = document.getElementById('audioNotes').value;
            const currentFolder = getCurrentFolder();
            
            if (currentFolder && currentFolder[currentFile.name]) {
                currentFolder[currentFile.name].content = notes;
                
                // Update metadata
                if (!fileMeta[currentFile.path]) {
                    fileMeta[currentFile.path] = {};
                }
                fileMeta[currentFile.path].updatedAt = new Date().toISOString();
                fileMeta[currentFile.path].type = 'audio';
                
                statusMessageEl.textContent = 'Audio note saved successfully';
            }
        }

        function saveFileContent() {
            if (!currentFile) return;
            
            const content = document.getElementById('fileContent').value;
            const currentFolder = getCurrentFolder();
            
            if (currentFolder && currentFolder[currentFile.name]) {
                currentFolder[currentFile.name].content = content;
                
                // Update metadata
                if (!fileMeta[currentFile.path]) {
                    fileMeta[currentFile.path] = {};
                }
                fileMeta[currentFile.path].updatedAt = new Date().toISOString();
                fileMeta[currentFile.path].type = 'regular';
                
                statusMessageEl.textContent = 'File saved successfully';
            }
        }

        // Media Handling
        function triggerFileInput(type) {
            const input = document.createElement('input');
            input.type = 'file';
            
            if (type === 'image') {
                input.accept = 'image/*';
                input.addEventListener('change', handleImageUpload);
            } else if (type === 'audio') {
                input.accept = 'audio/*';
                input.addEventListener('change', handleAudioUpload);
            }
            
            input.click();
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                compressAndAddImage(e.target.result, file.type);
            };
            reader.readAsDataURL(file);
        }

        function compressAndAddImage(dataUrl, mimeType) {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Calculate new dimensions (max 800x600)
                let width = img.width;
                let height = img.height;
                
                if (width > 800) {
                    height = (height * 800) / width;
                    width = 800;
                }
                
                if (height > 600) {
                    width = (width * 600) / height;
                    height = 600;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Draw and compress image
                ctx.drawImage(img, 0, 0, width, height);
                const compressedDataUrl = canvas.toDataURL(mimeType, 0.7);
                
                addMediaAttachment('image', compressedDataUrl);
            };
            img.src = dataUrl;
        }

        function handleAudioUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                addMediaAttachment('audio', e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function addMediaAttachment(type, data) {
            if (!currentFile) return;
            
            const path = currentFile.path;
            if (!fileMeta[path]) {
                fileMeta[path] = {};
            }
            
            if (!fileMeta[path].attachments) {
                fileMeta[path].attachments = [];
            }
            
            fileMeta[path].attachments.push({
                type,
                data,
                addedAt: new Date().toISOString()
            });
            
            // Update the media grid in the editor
            const mediaGrid = document.getElementById('mediaGrid');
            if (mediaGrid) {
                mediaGrid.innerHTML = renderMediaAttachments(fileMeta[path].attachments);
                setupMediaEventListeners();
            }
            
            statusMessageEl.textContent = `${type === 'image' ? 'Image' : 'Audio'} attachment added`;
        }

        function setupMediaEventListeners() {
            // Zoom buttons
            document.querySelectorAll('.zoom-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(e.target.dataset.index);
                    const path = currentFile.path;
                    const attachment = fileMeta[path].attachments[index];
                    
                    if (attachment && attachment.type === 'image') {
                        zoomedImageEl.src = attachment.data;
                        zoomOverlayEl.classList.add('active');
                    }
                });
            });
            
            // Delete media buttons
            document.querySelectorAll('.delete-media-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const index = parseInt(e.target.dataset.index);
                    const path = currentFile.path;
                    
                    if (fileMeta[path] && fileMeta[path].attachments) {
                        fileMeta[path].attachments.splice(index, 1);
                        
                        // Update the media grid
                        const mediaGrid = document.getElementById('mediaGrid');
                        if (mediaGrid) {
                            mediaGrid.innerHTML = renderMediaAttachments(fileMeta[path].attachments);
                            setupMediaEventListeners();
                        }
                        
                        statusMessageEl.textContent = 'Media attachment deleted';
                    }
                });
            });
        }

        // Data Persistence
        function saveToLocalStorage() {
            try {
                const data = {
                    fileSystem,
                    fileMeta,
                    currentPath,
                    savedAt: new Date().toISOString()
                };
                localStorage.setItem('fileManagerData', JSON.stringify(data));
                autoSaveStatusEl.textContent = `Auto-save: ${new Date().toLocaleTimeString()}`;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                autoSaveStatusEl.textContent = 'Auto-save: Error';
            }
        }

        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem('fileManagerData');
                if (data) {
                    const parsed = JSON.parse(data);
                    fileSystem = parsed.fileSystem;
                    fileMeta = parsed.fileMeta;
                    currentPath = parsed.currentPath;
                    
                    renderFileList();
                    renderBreadcrumb();
                    clearEditor();
                    
                    statusMessageEl.textContent = 'System loaded from local storage';
                } else {
                    statusMessageEl.textContent = 'No saved data found in local storage';
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                statusMessageEl.textContent = 'Error loading system data';
            }
        }

        function exportSystem() {
            const data = {
                fileSystem,
                fileMeta,
                exportedAt: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `file-manager-backup-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            statusMessageEl.textContent = 'System exported successfully';
        }

        function importSystem(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    fileSystem = data.fileSystem;
                    fileMeta = data.fileMeta;
                    
                    renderFileList();
                    renderBreadcrumb();
                    clearEditor();
                    
                    statusMessageEl.textContent = 'System imported successfully';
                } catch (error) {
                    console.error('Error importing system:', error);
                    statusMessageEl.textContent = 'Error importing system data';
                }
            };
            reader.readAsText(file);
            
            // Reset the input
            event.target.value = '';
        }

        function startAutoSave() {
            setInterval(saveToLocalStorage, 10000); // Auto-save every 10 seconds
        }

        // UI Utilities
        function clearEditor() {
            editorTitleEl.textContent = 'Select a file to edit';
            editorContentEl.innerHTML = `
                <div class="empty-state">
                    <i>📁</i>
                    <h3>No file selected</h3>
                    <p>Select a file from the sidebar or create a new one to start editing.</p>
                </div>
            `;
            editorActionsEl.innerHTML = '';
            currentFile = null;
        }

        function showContextMenu(event, itemName) {
            event.preventDefault();
            contextMenuTarget = itemName;
            
            contextMenuEl.style.display = 'block';
            contextMenuEl.style.left = `${event.pageX}px`;
            contextMenuEl.style.top = `${event.pageY}px`;
            
            // Close context menu when clicking elsewhere
            const closeContextMenu = (e) => {
                if (!contextMenuEl.contains(e.target)) {
                    contextMenuEl.style.display = 'none';
                    document.removeEventListener('click', closeContextMenu);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeContextMenu);
            }, 100);
        }

        function copyToKlikEdit() {
            let content = '';
            
            if (currentFile) {
                if (currentFile.name.endsWith('.audio.txt')) {
                    content = document.getElementById('audioNotes').value;
                } else {
                    content = document.getElementById('fileContent').value;
                }
                
                navigator.clipboard.writeText(content)
                    .then(() => {
                        statusMessageEl.textContent = 'Content copied to clipboard';
                        
                        // Redirect to KlikEdit (simulated)
                        setTimeout(() => {
                            alert('Redirecting to KlikEdit...');
                            // In a real implementation, this would redirect to the KlikEdit URL
                            // window.location.href = 'https://klikedit.example.com';
                        }, 500);
                    })
                    .catch(err => {
                        console.error('Error copying text: ', err);
                        statusMessageEl.textContent = 'Error copying content';
                    });
            }
        }

        // File and Folder Operations
        function createNewFolder(name) {
            const currentFolder = getCurrentFolder();
            if (!currentFolder) return;
            
            if (currentFolder[name]) {
                statusMessageEl.textContent = 'A folder with this name already exists';
                return;
            }
            
            currentFolder[name] = {
                type: 'folder',
                children: {}
            };
            
            renderFileList();
            statusMessageEl.textContent = `Folder "${name}" created successfully`;
        }

        function createNewFile(name) {
            const currentFolder = getCurrentFolder();
            if (!currentFolder) return;
            
            if (currentFolder[name]) {
                statusMessageEl.textContent = 'A file with this name already exists';
                return;
            }
            
            currentFolder[name] = {
                type: 'file',
                content: ''
            };
            
            // Create metadata
            const path = [...currentPath, name].join('/');
            fileMeta[path] = {
                createdAt: new Date().toISOString(),
                type: name.endsWith('.audio.txt') ? 'audio' : 'regular'
            };
            
            renderFileList();
            statusMessageEl.textContent = `File "${name}" created successfully`;
        }

        function renameItem(oldName, newName) {
            const currentFolder = getCurrentFolder();
            if (!currentFolder || !currentFolder[oldName]) return;
            
            if (currentFolder[newName]) {
                statusMessageEl.textContent = 'An item with this name already exists';
                return;
            }
            
            // Move the item
            currentFolder[newName] = currentFolder[oldName];
            delete currentFolder[oldName];
            
            // Update metadata if it's a file
            if (currentFolder[newName].type === 'file') {
                const oldPath = [...currentPath, oldName].join('/');
                const newPath = [...currentPath, newName].join('/');
                
                if (fileMeta[oldPath]) {
                    fileMeta[newPath] = fileMeta[oldPath];
                    delete fileMeta[oldPath];
                }
            }
            
            renderFileList();
            statusMessageEl.textContent = `"${oldName}" renamed to "${newName}"`;
            
            // If the renamed item is currently open, update the editor
            if (currentFile && currentFile.name === oldName) {
                currentFile.name = newName;
                currentFile.path = newPath;
                editorTitleEl.textContent = newName;
            }
        }

        function deleteItem(name) {
            const currentFolder = getCurrentFolder();
            if (!currentFolder || !currentFolder[name]) return;
            
            const item = currentFolder[name];
            
            // If it's a file, remove metadata
            if (item.type === 'file') {
                const path = [...currentPath, name].join('/');
                delete fileMeta[path];
            }
            
            // Remove the item
            delete currentFolder[name];
            
            renderFileList();
            statusMessageEl.textContent = `"${name}" deleted successfully`;
            
            // If the deleted item is currently open, clear the editor
            if (currentFile && currentFile.name === name) {
                clearEditor();
            }
        }

        // Event Listeners Setup
        function setupEventListeners() {
            // Navigation
            document.getElementById('backBtn').addEventListener('click', () => {
                if (currentPath.length > 1) {
                    currentPath.pop();
                    renderFileList();
                    renderBreadcrumb();
                    clearEditor();
                }
            });
            
            // Search
            searchInputEl.addEventListener('input', (e) => {
                renderFileList(e.target.value);
            });
            
            localSearchEl.addEventListener('click', () => {
                searchMode = 'local';
                localSearchEl.classList.add('active');
                globalSearchEl.classList.remove('active');
                renderFileList(searchInputEl.value);
            });
            
            globalSearchEl.addEventListener('click', () => {
                searchMode = 'global';
                globalSearchEl.classList.add('active');
                localSearchEl.classList.remove('active');
                renderFileList(searchInputEl.value);
            });
            
            // New Folder
            document.getElementById('newFolderBtn').addEventListener('click', () => {
                newFolderModalEl.classList.add('active');
                document.getElementById('folderNameInput').value = '';
                document.getElementById('folderNameInput').focus();
            });
            
            document.getElementById('closeNewFolderModal').addEventListener('click', () => {
                newFolderModalEl.classList.remove('active');
            });
            
            document.getElementById('cancelFolderBtn').addEventListener('click', () => {
                newFolderModalEl.classList.remove('active');
            });
            
            document.getElementById('createFolderBtn').addEventListener('click', () => {
                const name = document.getElementById('folderNameInput').value.trim();
                if (name) {
                    createNewFolder(name);
                    newFolderModalEl.classList.remove('active');
                }
            });
            
            // New File
            document.getElementById('newFileBtn').addEventListener('click', () => {
                newFileModalEl.classList.add('active');
                document.getElementById('fileNameInput').value = '';
                document.getElementById('fileNameInput').focus();
            });
            
            document.getElementById('closeNewFileModal').addEventListener('click', () => {
                newFileModalEl.classList.remove('active');
            });
            
            document.getElementById('cancelFileBtn').addEventListener('click', () => {
                newFileModalEl.classList.remove('active');
            });
            
            document.getElementById('createFileBtn').addEventListener('click', () => {
                const name = document.getElementById('fileNameInput').value.trim();
                if (name) {
                    createNewFile(name);
                    newFileModalEl.classList.remove('active');
                }
            });
            
            // Record Audio
            document.getElementById('recordAudioBtn').addEventListener('click', () => {
                const name = prompt('Enter a name for your audio note (will have .audio.txt extension):');
                if (name) {
                    const fileName = name.endsWith('.audio.txt') ? name : `${name}.audio.txt`;
                    createNewFile(fileName);
                    openFile(fileName);
                }
            });
            
            // System Actions
            document.getElementById('saveSystemBtn').addEventListener('click', exportSystem);
            
            document.getElementById('loadSystemBtn').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.addEventListener('change', importSystem);
                input.click();
            });
            
            document.getElementById('exitBtn').addEventListener('click', () => {
                if (confirm('Are you sure you want to exit? Any unsaved changes will be lost.')) {
                    // In a real application, this might close the window or redirect
                    alert('Thank you for using File Manager with Audio Notes!');
                }
            });
            
            // Context Menu Actions
            renameContextItemEl.addEventListener('click', () => {
                if (contextMenuTarget) {
                    renameModalEl.classList.add('active');
                    document.getElementById('renameInput').value = contextMenuTarget;
                    document.getElementById('renameInput').focus();
                    contextMenuEl.style.display = 'none';
                }
            });
            
            deleteContextItemEl.addEventListener('click', () => {
                if (contextMenuTarget) {
                    deleteModalEl.classList.add('active');
                    document.getElementById('deleteMessage').textContent = 
                        `Are you sure you want to delete "${contextMenuTarget}"?`;
                    contextMenuEl.style.display = 'none';
                }
            });
            
            // Rename Modal
            document.getElementById('closeRenameModal').addEventListener('click', () => {
                renameModalEl.classList.remove('active');
            });
            
            document.getElementById('cancelRenameBtn').addEventListener('click', () => {
                renameModalEl.classList.remove('active');
            });
            
            document.getElementById('confirmRenameBtn').addEventListener('click', () => {
                const newName = document.getElementById('renameInput').value.trim();
                if (newName && contextMenuTarget) {
                    renameItem(contextMenuTarget, newName);
                    renameModalEl.classList.remove('active');
                    contextMenuTarget = null;
                }
            });
            
            // Delete Modal
            document.getElementById('closeDeleteModal').addEventListener('click', () => {
                deleteModalEl.classList.remove('active');
            });
            
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                deleteModalEl.classList.remove('active');
            });
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                if (contextMenuTarget) {
                    deleteItem(contextMenuTarget);
                    deleteModalEl.classList.remove('active');
                    contextMenuTarget = null;
                }
            });
            
            // Zoom Overlay
            closeZoomEl.addEventListener('click', () => {
                zoomOverlayEl.classList.remove('active');
            });
            
            zoomOverlayEl.addEventListener('click', (e) => {
                if (e.target === zoomOverlayEl) {
                    zoomOverlayEl.classList.remove('active');
                }
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    zoomOverlayEl.classList.remove('active');
                }
            });
            
            // File action buttons (delegated events)
            fileListEl.addEventListener('click', (e) => {
                if (e.target.classList.contains('rename-btn')) {
                    const fileItem = e.target.closest('.file-item');
                    const fileName = fileItem.dataset.name;
                    
                    renameModalEl.classList.add('active');
                    document.getElementById('renameInput').value = fileName;
                    document.getElementById('renameInput').focus();
                }
                
                if (e.target.classList.contains('delete-btn')) {
                    const fileItem = e.target.closest('.file-item');
                    const fileName = fileItem.dataset.name;
                    
                    deleteModalEl.classList.add('active');
                    document.getElementById('deleteMessage').textContent = 
                        `Are you sure you want to delete "${fileName}"?`;
                }
            });
        }

        // Initialize with sample data
        window.onload = function() {
            // Add some sample data for demonstration
            createNewFolder('Sample Audio Notes');
            navigateToFolder('Sample Audio Notes');
            
            createNewFile('meeting-notes.audio.txt');
            
            // Add sample image to root
            navigateToPath(['root']);
            createNewFile('sample-image-note.txt');
            
            statusMessageEl.textContent = 'File Manager with Audio Notes loaded successfully';
        };
    </script>
</body>
</html>